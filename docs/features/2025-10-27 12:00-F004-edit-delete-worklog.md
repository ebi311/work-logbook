# 作業記録 F-004 仕様（作業記録の編集・削除）

F-004「作業記録の編集・削除」の仕様。過去の作業記録を修正または削除する機能。

最終更新: 2025-10-27

## 目的・ゴール

- 過去の作業記録（開始時間、終了時間、作業内容、タグ）を修正できる
- 不要な作業記録を削除できる
- 誤入力や記録漏れを後から修正することで、正確な作業履歴を維持する
- 操作は直感的で、誤削除を防ぐ仕組みを設ける

## 関連要件

- 前提: F-001「作業開始・終了」が実装済み
- 前提: F-002「作業内容の入力」が実装済み
- 前提: F-005「作業一覧の表示」が実装済み
- 関連: F-003「タグ付け」（未実装）

## 用語

- **編集（Edit）**: 既存の作業記録の内容を変更すること
- **削除（Delete）**: 作業記録をシステムから完全に削除すること
- **進行中の作業**: `endedAt` が `null` の作業記録
- **完了した作業**: `endedAt` に値が設定されている作業記録

## ユースケース

### UC-001: 完了した作業記録の編集

1. ユーザーが作業一覧から編集したい作業を選択
2. 編集画面またはモーダルが表示される
3. 以下の項目を編集できる:
   - 開始時刻（startedAt）
   - 終了時刻（endedAt）
   - 作業内容（description）
   - タグ（tags）※F-003実装後
4. 「保存」ボタンで変更を確定
5. バリデーションエラーがあればエラーメッセージを表示
6. 成功したら一覧画面に戻る、またはトースト通知を表示

**注**: 進行中の作業は編集対象外とする。進行中の作業を修正したい場合は、一度終了してから編集する。

### UC-002: 作業記録の削除

1. ユーザーが作業一覧から削除したい作業を選択
2. 削除ボタン（またはメニュー）をクリック
3. ブラウザ標準の確認ダイアログが表示される
4. 「OK」をクリックすると作業記録が削除される
5. 成功したら一覧画面を更新、トースト通知を表示

### UC-003: 編集のキャンセル

1. 編集画面でユーザーが「キャンセル」ボタンをクリック
2. 変更を破棄し、元の画面に戻る
3. 未保存の変更がある場合、確認ダイアログを表示（オプション）

## データモデル

### 既存スキーマ（参考）

```sql
CREATE TABLE work_logs (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  started_at TIMESTAMPTZ NOT NULL,
  ended_at TIMESTAMPTZ,
  description TEXT NOT NULL DEFAULT '',
  created_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX work_logs_user_id_active_idx
  ON work_logs(user_id)
  WHERE ended_at IS NULL;
```

### ドメインモデル

`WorkLog` クラスのメソッド拡張:

```typescript
export class WorkLog {
	// 既存のプロパティ
	readonly id: number;
	readonly userId: number;
	readonly startedAt: Date;
	readonly endedAt: Date | null;
	readonly description: string;
	readonly createdAt: Date;
	readonly updatedAt: Date;

	// 編集用メソッド（新規追加）
	update(params: { startedAt?: Date; endedAt?: Date | null; description?: string }): WorkLog;

	// バリデーションメソッド
	validateTimeRange(): void; // startedAt < endedAt の検証
	isActive(): boolean; // endedAt === null の判定
}
```

## バリデーション/ルール

### 編集時のバリデーション

1. **時刻の整合性**
   - `startedAt` は `endedAt` より前でなければならない（endedAtがnullでない場合）
   - エラーメッセージ: "開始時刻は終了時刻より前である必要があります"

2. **時刻の範囲**
   - `startedAt` は未来の日時に設定できない
   - `endedAt` は未来の日時に設定できない
   - エラーメッセージ: "未来の時刻は設定できません"

3. **作業内容**
   - 最大長: 10,000文字
   - エラーメッセージ: "作業内容は10,000文字以内で入力してください"

4. **編集対象の制約**
   - 進行中の作業（`endedAt` が `null`）は編集不可
   - 編集ボタンは完了した作業記録のみに表示される
   - エラーメッセージ: "進行中の作業は編集できません。一度終了してから編集してください。"

5. **認証と権限**
   - 自分の作業記録のみ編集・削除可能
   - 他人の作業記録は操作不可

### 削除時のルール

1. **論理削除 vs 物理削除**
   - MVP段階では物理削除（完全削除）を実装
   - 将来的に論理削除（deleted_atフラグ）への変更を検討

2. **削除対象**
   - 完了した作業のみ削除可能
   - 進行中の作業を削除したい場合は、まず「作業終了」してから削除する

## Server Actions 設計（SvelteKit）

### actions.update

**パス**: `/worklogs/[id]/edit` のフォームアクション

**入力**:

```typescript
{
  id: number;
  startedAt: string; // ISO 8601形式
  endedAt?: string | null; // ISO 8601形式、進行中の場合はundefined
  description: string;
  // tags?: string[]; // F-003実装後
}
```

**振る舞い**:

1. 認証チェック: `locals.user` から `userId` を取得
2. 作業記録の取得: 指定された `id` の作業記録を取得
3. 権限チェック: 作業記録の `userId` が現在のユーザーと一致するか確認
4. バリデーション:
   - 時刻の整合性チェック
   - 時刻の範囲チェック
   - 作業内容の長さチェック
5. データベース更新:
   - `started_at`, `ended_at`, `description` を更新
   - `updated_at` を現在時刻で自動更新
6. ドメインモデルの検証: `WorkLog.validateTimeRange()` を実行

**成功レスポンス**:

```typescript
{
	ok: true;
	workLog: {
		id: number;
		startedAt: string;
		endedAt: string | null;
		description: string;
		updatedAt: string;
	}
	serverNow: string; // ISO 8601形式
}
```

**エラーレスポンス**:

```typescript
{
  ok: false;
  reason: 'UNAUTHORIZED' | 'NOT_FOUND' | 'VALIDATION_ERROR' | 'INTERNAL_ERROR';
  message: string;
  errors?: Record<string, string>; // フィールドごとのエラー
  serverNow: string;
}
```

**ステータスコード**:

- 200: 成功
- 401: 未認証
- 403: 権限なし（他人の作業記録）
- 404: 作業記録が見つからない
- 400: バリデーションエラー
- 500: サーバーエラー

### actions.delete

**パス**: `/worklogs/[id]/delete` のフォームアクション

**入力**:

```typescript
{
	id: number;
}
```

**振る舞い**:

1. 認証チェック: `locals.user` から `userId` を取得
2. 作業記録の取得: 指定された `id` の作業記録を取得
3. 権限チェック: 作業記録の `userId` が現在のユーザーと一致するか確認
4. データベース削除: `DELETE FROM work_logs WHERE id = ? AND user_id = ?`
5. 削除後の状態確認: 進行中の作業が削除された場合、システム状態を更新

**成功レスポンス**:

```typescript
{
	ok: true;
	deletedId: number;
	serverNow: string; // ISO 8601形式
}
```

**エラーレスポンス**:

```typescript
{
	ok: false;
	reason: 'UNAUTHORIZED' | 'NOT_FOUND' | 'FORBIDDEN' | 'INTERNAL_ERROR';
	message: string;
	serverNow: string;
}
```

**ステータスコード**:

- 200: 成功
- 401: 未認証
- 403: 権限なし（他人の作業記録）
- 404: 作業記録が見つからない
- 500: サーバーエラー

## UI/UX設計

### 画面構成

#### 1. 作業一覧画面への追加要素

完了した作業記録に以下のアクションボタンを追加:

- **編集ボタン**: 鉛筆アイコンまたは「編集」ラベル
- **削除ボタン**: ゴミ箱アイコンまたは「削除」ラベル

**表示条件**: `endedAt` が `null` でない（完了した）作業記録のみにボタンを表示

配置案:

- オプション1: 各行の右端にアクションボタンを配置
- オプション2: 行をホバーした際にアクションボタンを表示
- オプション3: 行をクリックでメニューを表示（モバイル対応）

#### 2. 編集画面/モーダル

**表示方法**:

- オプション1: モーダルダイアログで表示（推奨: シンプルで素早い）
- オプション2: 専用ページに遷移（`/worklogs/[id]/edit`）

**フォーム要素**:

```
┌─────────────────────────────────────┐
│  作業記録の編集              [×閉じる] │
├─────────────────────────────────────┤
│ 開始時刻                             │
│ [2025-10-27] [09:00]                 │
│                                     │
│ 終了時刻                             │
│ [2025-10-27] [17:30]                 │
│                                     │
│ 作業内容 (Markdown対応)               │
│ ┌─────────────────────────────────┐ │
│ │                                 │ │
│ │                                 │ │
│ │                                 │ │
│ └─────────────────────────────────┘ │
│                                     │
│ [キャンセル]         [保存]          │
└─────────────────────────────────────┘
```

**入力要素**:

- 開始時刻: `<input type="datetime-local">`
- 終了時刻: `<input type="datetime-local">`
- 作業内容: `<textarea>` (Markdown対応)

**注**: 完了した作業記録のみ編集可能なため、進行中チェックボックスは不要

**バリデーション表示**:

- フィールドごとにエラーメッセージを表示
- 送信ボタンは無効化（エラーがある場合）
- リアルタイムバリデーション（入力時）

#### 3. 削除確認（ブラウザ標準）

ブラウザ標準の `window.confirm()` を使用:

```javascript
const confirmed = confirm('この作業記録を削除してもよろしいですか？\n\nこの操作は取り消せません。');
if (confirmed) {
	// 削除処理を実行
}
```

**メリット**:

- 実装が簡単で高速
- ネイティブUIで動作が軽快
- キーボード操作（Enter/Esc）が標準で対応済み

**デメリット**:

- スタイルのカスタマイズ不可
- 作業内容の要約を表示できない

**将来の拡張**: より詳細な情報を表示したい場合は、カスタムモーダルに置き換えることも検討

### 操作フロー

#### 編集フロー

1. ユーザーが一覧画面で「編集」ボタンをクリック
2. モーダルが開き、現在の値がフォームに表示される
3. ユーザーが値を変更
4. リアルタイムバリデーションでエラーを表示（該当する場合）
5. 「保存」ボタンをクリック
6. サーバーにフォームを送信
7. 成功:
   - モーダルを閉じる
   - 一覧画面を更新
   - トースト通知: "作業記録を更新しました"
8. エラー:
   - エラーメッセージを表示
   - フォームは開いたまま

#### 削除フロー

1. ユーザーが一覧画面で「削除」ボタンをクリック
2. ブラウザ標準の確認ダイアログが表示される
3. ユーザーが「OK」ボタンをクリック
4. サーバーにフォームを送信
5. 成功:
   - 一覧画面から該当行を削除
   - トースト通知: "作業記録を削除しました"
6. エラー:
   - エラーメッセージをトースト通知で表示

## キーボードショートカット

- 編集モーダル内:
  - `Esc`: キャンセル
  - `Ctrl/Cmd + Enter`: 保存
- 削除確認ダイアログ（ブラウザ標準）:
  - `Enter`: OK（削除実行）
  - `Esc`: キャンセル

## アクセシビリティ

- モーダルが開いた際、フォーカスを最初の入力要素に移動
- キーボードのみで操作可能
- スクリーンリーダー対応: `aria-label`, `role` 属性を適切に設定
- 削除確認はブラウザ標準のため、OSレベルのアクセシビリティ機能が自動的に適用される

## エラーハンドリング

### クライアント側

- ネットワークエラー: "通信エラーが発生しました。もう一度お試しください。"
- バリデーションエラー: フィールドごとにエラーメッセージを表示
- 権限エラー: "この操作を実行する権限がありません"

### サーバー側

- 楽観的ロック: `updated_at` を使用して、編集中に他のクライアントで変更された場合を検出
  - エラーメッセージ: "この作業記録は他の場所で更新されています。ページを再読み込みしてください。"

## テスト観点

### 単体テスト（ドメインモデル）

- `WorkLog.update()` メソッドのテスト
  - 正常系: 各フィールドが正しく更新される
  - 異常系: バリデーションエラーが適切にスローされる
- `WorkLog.validateTimeRange()` のテスト
  - startedAt < endedAt の検証
  - endedAt が null の場合は検証をスキップ

### 統合テスト（Server Actions）

- `actions.update` のテスト
  - 正常系: 作業記録が更新される
  - 異常系: 未認証、権限なし、バリデーションエラー
  - 境界値: 時刻の境界、文字数制限
- `actions.delete` のテスト
  - 正常系: 作業記録が削除される
  - 異常系: 未認証、権限なし、存在しないID

### E2Eテスト（UI）

- 編集フロー
  - 編集モーダルが開く
  - 値を変更して保存できる
  - バリデーションエラーが表示される
  - キャンセルで変更が破棄される
- 削除フロー
  - ブラウザ標準の確認ダイアログが表示される
  - OKで削除が実行される
  - キャンセルで削除が中止される

## 実装の優先順位

1. **Phase 1: 編集機能**
   - Server action: `actions.update`
   - UI: 編集モーダル/ページ
   - バリデーション
   - 完了した作業のみ編集可能な制約

2. **Phase 2: 削除機能**
   - Server action: `actions.delete`
   - UI: ブラウザ標準の確認ダイアログを使用
   - 完了した作業のみ削除可能な制約

3. **Phase 3: UX改善**
   - キーボードショートカット
   - 楽観的ロック
   - アクセシビリティ対応

## 将来的な拡張

- **一括操作**: 複数の作業記録を選択して一括削除
- **カスタム削除ダイアログ**: 作業内容の要約を表示するカスタムモーダル
- **論理削除**: `deleted_at` フラグによる論理削除と復元機能
- **変更履歴**: 作業記録の編集履歴を記録（`work_log_history` テーブル）
- **差分表示**: 編集前後の差分を視覚的に表示
- **ドラッグ&ドロップ**: 一覧画面で時刻を視覚的に調整

## 参考資料

- F-001 仕様: 作業開始・終了
- F-002 仕様: 作業内容の入力
- F-005 仕様: 作業一覧の表示
- SvelteKit Form Actions: https://kit.svelte.dev/docs/form-actions
