# F-001.2 FR-01: Inline Active Editing UI

タスク作成日: 2025-11-18

## 目的

進行中カード上で開始時刻・作業内容・タグを同一フォームで扱えるようにするため、開始時刻入力フィールドと「作業中変更」ボタンを既存のUIに追加する。これにより SPEC FR-01 の要件（進行中カード内に編集UIを常設する）が満たされる。

## 前提条件

- 機能仕様: `docs/features/2025-11-18 09:00-F001.2-active-worklog-edit.md`
- 現行UI: `src/routes/+page.svelte` のフォーム（`DescriptionInput`, `WorkLogTagInput`, `WorkLogToggleButton`）
- 進行中作業データは `data.active` 経由で取得できる
- まだ `actions.adjustActive` は未実装であるため、UI側ではエンドポイント名を可変にできるよう実装しておく（後続タスクで本アクションを接続）

## スコープ

- 進行中カード内のフォーム構造拡張
- 開始時刻の入力コンポーネント追加（`datetime-local` ベース）
- 「作業終了」「切り替え」と同列に「作業中変更」ボタンを新設
- ローカルステート（`startedAt`, `description`, `tags`）の同期とフォーム送信値の整理

## 成果物

- `src/routes/_components/ActiveWorkLogStartTimeInput/` (Component + UT + Story)
- `src/routes/_components/ActiveWorkLogActions/` (Button群ラッパ or 既存ボタン拡張) の実装とテスト
- `src/routes/+page.svelte` のフォーム更新（開始時刻編集 + 新ボタン + 状態管理）
- Vitest, Storybook によるテスト/ストーリー
- 必要に応じて型定義更新 (`src/routes/_components/.../types.ts` 等)

## 非スコープ

- `actions.adjustActive` のサーバー実装（FR-02 以降で対応）
- DB/ドメイン層の変更
- 終了後の作業編集UI

## タスク分解

### Task 1: 進行中開始時刻入力コンポーネント

| 項目     | 内容                                                                                                                                                                                                                                                                                                    |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 目的     | 進行中カード用に `datetime-local` フィールドを提供し、開始時刻を編集できるようにする                                                                                                                                                                                                                    |
| ファイル | `src/routes/_components/ActiveWorkLogStartTimeInput/ActiveWorkLogStartTimeInput.svelte`<br>`ActiveWorkLogStartTimeInput.spec.ts`<br>`ActiveWorkLogStartTimeInput.stories.svelte`                                                                                                                        |
| 要件     | <ul><li>props: `value: string`, `min?: string`, `max?: string`, `disabled?: boolean`, `onInput`/bind</li><li>UTC文字列を受け取り、ローカル `datetime-local` 値に変換</li><li>エラーメッセージ表示スロット（フォームからのバリデーションに備える）</li><li>Tailwind + daisyUI フォームスタイル</li></ul> |
| TDD手順  | <ol><li>Spec: 値変換・changeイベントのテストを追加</li><li>実装: フォーマット関数（`toLocalDateTimeInputValue`）を Arrow Function で実装</li><li>Story: 正常ケース（現在時刻/過去時刻）を追加</li></ol>                                                                                                 |
| 合格基準 | <ul><li>UT/Storybook が通る</li><li>Props の型が厳密 (no `any`)</li><li>Min/Max 属性が props 反映される</li></ul>                                                                                                                                                                                       |

### Task 2: 「作業中変更」ボタンのUIラッパ

| 項目     | 内容                                                                                                                                                                                                                                                                                                                                                                                               |
| -------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 目的     | 既存の `WorkLogToggleButton` と並列で操作できるアクション群を提供し、後続の Server Action と接続しやすくする                                                                                                                                                                                                                                                                                       |
| ファイル | `src/routes/_components/ActiveWorkLogActions/ActiveWorkLogActions.svelte`<br>`ActiveWorkLogActions.spec.ts`<br>`ActiveWorkLogActions.stories.svelte`                                                                                                                                                                                                                                               |
| 要件     | <ul><li>props: `isActive: boolean`, `isSubmitting: boolean`, `updateAction: string` (例 `?/adjust-active`)</li><li>内部で `WorkLogToggleButton` を再利用 or ラップ</li><li>`isActive` が true の時のみ「作業中変更」ボタンを表示</li><li>ボタン押下時には `formaction`=`updateAction`, `formmethod=POST` を利用（後でaction差し替え可）</li><li>ローディング状態や`disabled`制御を揃える</li></ul> |
| TDD手順  | <ol><li>Spec: 表示条件、formaction 付与、disabled 動作をテスト</li><li>実装: daisyUIボタン＋`btn-secondary`などを利用</li><li>Story: 停止中/進行中/送信中の3パターン</li></ol>                                                                                                                                                                                                                     |
| 合格基準 | <ul><li>`isActive=false` の時はボタン非表示</li><li>`isSubmitting=true` で全ボタン disabled</li><li>CIのユニット + Storybook 動作がOK</li></ul>                                                                                                                                                                                                                                                    |

### Task 3: `+page.svelte` への統合

| Step | 内容                                                                                                                                                                                                     | テスト                                                     | 合格基準                                                 |
| ---- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- | -------------------------------------------------------- |
| 3-1  | `startedAt` のローカルステートを追加。`currentActive?.startedAt` と同期し、`description/tags` と同じ `effect` で管理                                                                                     | `src/routes/+page.svelte.spec.ts` に状態同期テストを追加   | `currentActive`の変更で startedAt フィールドが更新される |
| 3-2  | フォームに `ActiveWorkLogStartTimeInput` を追加し、`min`=`data.previousEndedAt?`, `max`=`currentServerNow`（仮）。`datetime-local` 値を ISO 文字列へ変換して hidden input に保存するユーティリティを用意 | 新規ユーティリティの UT (`src/lib/utils/datetimeLocal.ts`) | 入力→隠しフィールド→送信値がISOで取得できる              |
| 3-3  | 「作業中変更」ボタンを `ActiveWorkLogActions` 経由で追加し、`formaction` で `/?/adjust-active` (仮) を指す。開始時刻/内容/タグのバインドは既存 `DescriptionInput`/`WorkLogTagInput` を再利用             | `+page.svelte.spec.ts` にボタン表示条件テストを追加        | 進行中時のみボタンがDOMに存在し、送信中は disabled       |
| 3-4  | enhance コールバックで `actionName==='adjust-active'` 時の処理分岐を追加（後続サーバー実装までは `toastError('未実装')` など暫定ハンドリング）                                                           | Spec: `adjust` 送信時にハンドラが呼ばれる                  | UIが退化せず、未実装エラー時に通知が表示される           |

## 受入基準

1. 進行中カードに開始時刻フィールドが表示され、値が進行中作業の `startedAt` と同期している
2. 「作業中変更」ボタンが進行中時のみ表示され、送信中/停止中で状態が適切に変化する
3. すべての新規ユニットテスト・ストーリーブックが成功する
4. `pnpm test:unit` がグリーン（TDD順守）

## テストコマンド

```bash
pnpm test:unit
pnpm storybook
```

## リスク / メモ

- `datetime-local` はローカルタイムで扱うため、UTCとの相互変換ユーティリティを実装してバグを防ぐ
- フォーム送信先は後続タスクでサーバー実装に接続する予定のため、可変の `updateAction` プロップで柔軟性を保持する
- モバイルでは `datetime-local` のUIがブラウザ依存となるため、ストーリーで表示崩れを確認
