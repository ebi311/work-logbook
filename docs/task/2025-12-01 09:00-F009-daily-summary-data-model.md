# Task: F-009 Daily Summary Data Model

最終更新: 2025-12-01T09:00:00Z

## 概要

指定月に対する「日別合計時間」のデータモデルを定義する。UIとサーバ処理間の契約（DTO）、集計要件、バリデーション、エッジケースを明文化する。コードは記載せず、仕様のみとする。

## 目的

- 月単位で各日ごとの合計作業時間と件数を返却する標準的なデータモデルを確立
- 既存のフィルタ（月、タグ）と整合し、拡張可能な設計
- タイムゾーンや未終了ログの扱いを明確化

## スコープ

- 入力: `month (YYYY-MM)`, `tags (string[])` 任意
- 出力: `DailySummaryData`
- 集計対象: 終了済みの作業ログのみ
- タイムゾーン: サーバ側は UTC 基準で集計

## エンティティ/DTO 定義

### DailySummaryItem

| フィールド名 | 型     | 必須 | 説明                                       | 例              |
| ------------ | ------ | ---- | ------------------------------------------ | --------------- |
| `date`       | 文字列 | ○    | 日付 (YYYY-MM-DD, UTC 基準)                | `"2025-11-30"`  |
| `dayOfWeek`  | 文字列 | ○    | 曜日（日本語: 日/月/火/水/木/金/土）       | `"土"`          |
| `totalSec`   | 数値   | ○    | 合計作業秒数（その日の終了済みログの合計） | `28800` (8時間) |
| `count`      | 数値   | ○    | その日の終了済み作業ログ件数               | `2`             |

### DailySummaryData

| フィールド名      | 型                     | 必須 | 説明                                                      | 例                 |
| ----------------- | ---------------------- | ---- | --------------------------------------------------------- | ------------------ |
| `items`           | 配列<DailySummaryItem> | ○    | 対象月の各日のサマリー。作業なしの日は原則含めない（MVP） | `[...]`            |
| `monthlyTotalSec` | 数値                   | ○    | 月の合計作業秒数（`items.totalSec` の総和）               | `576000` (160時間) |
| `month`           | 文字列                 | ○    | 対象月 (YYYY-MM)                                          | `"2025-11"`        |

## 入出力契約（API/ローデータ）

### 入力パラメータ

| パラメータ | 型           | 必須 | 説明                   | 例                | 備考          |
| ---------- | ------------ | ---- | ---------------------- | ----------------- | ------------- |
| `userId`   | 文字列       | ○    | ログインユーザーID     | `"user_123"`      | 認証済み前提  |
| `month`    | 文字列       | ○    | 対象月 (YYYY-MM)       | `"2025-11"`       | URLクエリ由来 |
| `tags`     | 配列<文字列> | ×    | タグフィルタ（OR条件） | `["開発","会議"]` | 未指定可      |

### レスポンス（成功）

- 200 OK: `DailySummaryData`
- 並び順: 日付降順（最新→過去）

### エラー/例外

| ステータス | 条件                     | メッセージ例           | 備考           |
| ---------- | ------------------------ | ---------------------- | -------------- |
| 400        | `month` フォーマット不正 | `Invalid month format` | `YYYY-MM` 必須 |
| 401        | 未認証                   | `Unauthorized`         | -              |
| 403        | 他者のデータアクセス     | `Forbidden`            | -              |

## 集計仕様（DB視点）

### 入力レンジ

| 名称   | 計算                   | 例                     |
| ------ | ---------------------- | ---------------------- |
| 月初   | `{month}-01T00:00:00Z` | `2025-11-01T00:00:00Z` |
| 翌月初 | 月初に 1 ヶ月加算      | `2025-12-01T00:00:00Z` |

### 対象レコード

- `user_id = :userId`
- `started_at >= :startOfMonth AND started_at < :startOfNextMonth`
- `ended_at IS NOT NULL`（進行中を除外）
- タグフィルタ: `tags && :tags[]`（指定時のみ、OR 条件）

### 集計内容

| 項目        | 説明                                                    |
| ----------- | ------------------------------------------------------- |
| `date`      | `DATE(started_at AT TIME ZONE 'UTC')`（UTC 基準の日付） |
| `total_sec` | `SUM(EXTRACT(EPOCH FROM (ended_at - started_at)))`      |
| `count`     | `COUNT(*)`                                              |

### グルーピング/ソート

- GROUP BY `date`
- ORDER BY `date` DESC

### インデックス/性能考慮

| 対象           | 推奨インデックス        | 目的                     |
| -------------- | ----------------------- | ------------------------ |
| ユーザー＋期間 | `(user_id, started_at)` | レンジスキャン最適化     |
| タグ           | `tags` GIN              | タグフィルタ適用時の性能 |

## バリデーションルール

| 項目    | ルール                          | 失敗時                   |
| ------- | ------------------------------- | ------------------------ |
| `month` | `YYYY-MM`                       | 400 Bad Request          |
| `tags`  | 文字列配列、要素は 1〜50 文字   | 不正要素は無視（MVP）    |
| レンジ  | `startOfMonth < endOfNextMonth` | 400 Bad Request          |
| 時刻    | 集計は UTC 基準                 | ドキュメント化（本仕様） |

## 並び順/表示仕様

- デフォルト並び: 日付降順
- 作業時間 0 の日: 表示しない（MVP）。将来オプション化
- 曜日表記: `['日','月','火','水','木','金','土']`

## エッジケース

- 対象月に作業が 0 件 → `items = []`, `monthlyTotalSec = 0`
- 進行中ログのみ → 全て除外（`ended_at IS NULL`）
- 月の跨ぎ → `started_at` の月に含める（MVP）。将来 `ended_at` 基準の集計オプション検討
- 無効タグ指定 → フィルタ条件に該当なし、結果は空

## 受け入れ基準（Acceptance Criteria）

1. 指定 `month` と `userId` のもとで、終了済みログのみを対象に `items` が返ること
2. `monthlyTotalSec` は `items.totalSec` の総和と一致すること
3. `items` は日付降順でソートされていること
4. タグフィルタが指定された場合、該当タグを持つログのみを集計すること（OR 条件）
5. 対象月にログが無い場合、`items=[]` かつ `monthlyTotalSec=0` を返すこと

## 追記（UI 連携のための補足）

- `DailySummaryView` は `dailySummaryData: Promise<DailySummaryData>` を受け取る
- 行クリックで `onDateClick(date)` を発火し、`+page.svelte` でビュー切替と日付フィルタ適用
- 表示時間は HH:mm 形式に整形（例: `8:05`）
