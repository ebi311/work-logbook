# CSP の unsafe-inline 削除とnonce実装タスク

## タスクID

NF-002.1

## 関連要件

NF-003: セキュリティヘッダー（強化）

## 目的

Content Security Policy (CSP) から `unsafe-inline` を削除し、nonce (number used once) ベースのCSPに移行することで、XSS攻撃に対するセキュリティをさらに強化する。

## 背景

現在の実装では、SvelteKitの制約により `script-src` と `style-src` に `'unsafe-inline'` を使用しているが、これはXSS攻撃のリスクを高める。nonceベースのCSPを使用することで、`unsafe-inline` を削除できる。

## 実装ステップ

### Step 1: Nonce生成ユーティリティの作成

#### ファイル

- `src/lib/server/security/nonce.ts`
- `src/lib/server/security/nonce.spec.ts`

#### 機能

- リクエストごとにランダムなnonceを生成
- 暗号学的に安全な乱数を使用

#### 実装例

```typescript
export const generateNonce = (): string => {
	const buffer = new Uint8Array(16);
	crypto.getRandomValues(buffer);
	return Array.from(buffer)
		.map((b) => b.toString(16).padStart(2, '0'))
		.join('');
};
```

### Step 2: セキュリティヘッダーユーティリティの更新

#### 変更内容

1. `getSecurityHeaders` 関数に `nonce` パラメータを追加
2. CSPの `script-src` と `style-src` で nonce を使用
3. `unsafe-inline` を削除（ただし開発環境では `unsafe-eval` は保持）

#### 更新後のCSP

```
script-src 'self' 'nonce-{nonce}' 'unsafe-eval' (開発環境)
script-src 'self' 'nonce-{nonce}' (本番環境)
style-src 'self' 'nonce-{nonce}'
```

### Step 3: app.d.ts の型定義更新

#### 追加内容

```typescript
interface Locals {
	user?: {
		id: string;
		githubId: string;
		githubUsername: string;
		isActive: boolean;
	};
	nonce?: string; // 追加
}
```

### Step 4: hooks.server.ts の更新

#### 変更内容

1. リクエストごとにnonceを生成
2. `event.locals.nonce` に保存
3. セキュリティヘッダーにnonceを渡す

#### 実装位置

- `handle` 関数の最初でnonceを生成
- すべてのレスポンスパスで同じnonceを使用

### Step 5: SvelteKit設定の更新（svelte.config.js）

#### 追加内容

```javascript
kit: {
  adapter: adapter({
    runtime: 'nodejs20.x',
  }),
  csp: {
    mode: 'auto',
    directives: {
      'script-src': ['self'],
      'style-src': ['self'],
    },
  },
}
```

**注意**: SvelteKitの `csp` 設定を使用すると、自動的にnonceが生成・適用される可能性があるため、調査が必要。

### Step 6: テストの更新

#### 更新箇所

1. `headers.spec.ts`: nonce パラメータを含むテスト
2. `hooks.server.spec.ts`: locals.nonce の検証を追加

#### テスト項目

- [ ] nonceが毎回異なる値を生成する
- [ ] nonceが32文字（16バイト）の16進数文字列である
- [ ] CSPヘッダーにnonceが含まれる
- [ ] event.locals.nonceにnonceが設定される
- [ ] `unsafe-inline` が含まれない

### Step 7: 動作確認

#### 確認項目

- [ ] 開発環境でアプリが正常に動作する
- [ ] インラインスクリプトが実行される
- [ ] インラインスタイルが適用される
- [ ] Vite HMRが正常に動作する（`unsafe-eval` が開発環境で有効）
- [ ] ブラウザコンソールでCSP違反がない
- [ ] すべてのユニットテストが成功

#### 確認コマンド

```bash
# ヘッダー確認
curl -I http://localhost:5173/ | grep -i content-security-policy

# テスト実行
pnpm test:unit
```

## 合格基準

1. **unsafe-inline の削除**
   - CSPから `'unsafe-inline'` が完全に削除される
   - nonce ベースのディレクティブのみを使用

2. **機能の維持**
   - すべての既存機能が正常に動作する
   - インラインスクリプト・スタイルが動作する
   - Vite HMR が動作する（開発環境）

3. **セキュリティの向上**
   - より厳格なCSPによりXSS攻撃のリスクが軽減される
   - nonceが毎リクエスト異なる値を生成する

## 注意事項

### SvelteKitの制約

- SvelteKit 2.x では、`%sveltekit.nonce%` プレースホルダーがサポートされている
- `app.html` 内のインラインスクリプトに自動的にnonceが適用される
- カスタムCSPヘッダーとSvelteKitのCSP設定が競合しないよう注意

### 開発環境

- `unsafe-eval` は Vite の HMR に必要なため、開発環境では保持する
- WebSocket接続も開発環境で許可を継続

### Tailwind CSS

- Tailwind CSSのスタイルはビルド時に生成されるため、nonceは不要
- インラインスタイル（`style`属性）を使用している場合は要確認

## 参考資料

- [SvelteKit CSP Documentation](https://kit.svelte.dev/docs/configuration#csp)
- [MDN: CSP nonce](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src#unsafe_inline_script)
- [OWASP: Content Security Policy Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Content_Security_Policy_Cheat_Sheet.html)
