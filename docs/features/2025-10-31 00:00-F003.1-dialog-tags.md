# 作業記録 F-003.1 仕様（ダイアログでのタグ表示・編集）

F-003.1「ダイアログでのタグ表示・編集」の仕様。作業ログの参照・編集ダイアログにタグ機能を統合する。

**実装状態**: 🔄 計画中  
最終更新: 2025-10-31

## 目的・ゴール

- 作業記録の詳細ダイアログでタグを表示できるようにする
- 作業記録の編集ダイアログでタグを編集できるようにする
- F-003（タグ付け機能）で実装した TagInput、TagBadge コンポーネントを再利用する
- ユーザーが作業記録を閲覧・編集する際に、タグ情報も一緒に確認・変更できるようにする

## 関連要件

- 前提: F-003「タグ付け」が実装済み
- 前提: F-004「作業記録の編集・削除」が実装済み
- 統合対象: WorkLogDetailDialog コンポーネント
- 統合対象: WorkLogEditModal コンポーネント

## 用語

- **詳細ダイアログ（Detail Dialog）**: 作業記録の詳細を表示する読み取り専用のダイアログ
- **編集モーダル（Edit Modal）**: 作業記録を編集するためのダイアログ

## ユースケース

### UC-001: 詳細ダイアログでタグを閲覧

1. ユーザーが作業一覧から作業記録をクリック
2. 詳細ダイアログが開く
3. 作業内容と共に、付けられているタグがバッジ形式で表示される
4. タグは読み取り専用（クリックしても何も起こらない）

### UC-002: 編集モーダルでタグを変更

1. ユーザーが作業記録の「編集」ボタンをクリック
2. 編集モーダルが開く
3. 既存のタグがタグ入力フィールドに表示されている
4. ユーザーがタグを追加・削除
5. オートコンプリートで過去のタグをサジェスト
6. 「保存」ボタンで更新内容を送信
7. サーバーで更新され、ダイアログが閉じる

## データモデル

### 詳細ダイアログの Props 拡張

```typescript
type Props = {
	item: {
		id: string;
		startedAt: string;
		endedAt: string | null;
		description: string;
		tags: string[]; // 追加
	};
	duration: number | null;
	onClose: () => void;
};
```

### 編集モーダルの Props 拡張

```typescript
type EditableWorkLog = {
	id: string;
	startedAt: Date;
	endedAt: Date | null;
	description: string;
	tags: string[]; // 追加
};

type Props = {
	workLog: EditableWorkLog;
	open: boolean;
	onclose?: () => void;
	onupdated?: (workLog: WorkLog) => void;
	tagSuggestions: Array<{ tag: string; count: number }>; // 追加
};
```

## UI/UX設計

### 詳細ダイアログ

#### 配置

タグ表示エリアを作業時間の下に追加:

```
┌─────────────────────────────────────┐
│ 作業詳細                      [×]   │
├─────────────────────────────────────┤
│ 日付:     2025-10-31                │
│ 開始:     09:00                     │
│ 終了:     11:30                     │
│ 作業時間: 2時間30分                  │
│                                     │
│ タグ:     [開発] [PJ-A] [機能追加]   │ ← 追加
│                                     │
│ 作業内容:                           │
│ ┌─────────────────────────────────┐ │
│ │ Markdownレンダリング内容        │ │
│ │                                 │ │
│ └─────────────────────────────────┘ │
│                                     │
│                      [閉じる]       │
└─────────────────────────────────────┘
```

#### スタイリング

- タグがない場合: 「タグ:」のラベルは非表示、または「（タグなし）」と表示
- TagBadge コンポーネントを使用
- `removable={false}` で削除ボタンを非表示

### 編集モーダル

#### 配置

作業内容（description）の下にタグ入力フィールドを追加:

```
┌─────────────────────────────────────┐
│ 作業記録を編集                [×]   │
├─────────────────────────────────────┤
│ 開始日時:                           │
│ [2025-10-31T09:00]                  │
│                                     │
│ 終了日時:                           │
│ [2025-10-31T11:30]                  │
│                                     │
│ 作業内容:                           │
│ ┌─────────────────────────────────┐ │
│ │ テキストエリア                  │ │
│ └─────────────────────────────────┘ │
│                                     │
│ タグ:                               │ ← 追加
│ [入力フィールド（サジェスト付き）]   │
│ [開発] [PJ-A] [機能追加]             │
│                                     │
│ [エラー表示エリア]                   │
│                                     │
│            [キャンセル] [保存]       │
└─────────────────────────────────────┘
```

#### インタラクション

- TagInput コンポーネントを使用
- オートコンプリート機能が利用可能
- タグのバリデーション（最大20個、1〜100文字）
- エラーがある場合は保存ボタンを無効化、またはエラーメッセージ表示

## 実装方針

### 1. WorkLogDetailDialog の拡張

**ファイル**: `src/routes/_components/WorkLogDetailDialog/WorkLogDetailDialog.svelte`

#### 変更点

1. Props に `tags` を追加
2. TagBadge コンポーネントをインポート
3. タグ表示セクションを追加
4. タグがない場合の表示処理

#### 実装例

```svelte
<script lang="ts">
	import TagBadge from '../TagBadge/TagBadge.svelte';

	type Props = {
		item: {
			id: string;
			startedAt: string;
			endedAt: string | null;
			description: string;
			tags: string[];
		};
		duration: number | null;
		onClose: () => void;
	};

	let { item, duration, onClose }: Props = $props();
</script>

<!-- 作業情報の下に追加 -->
{#if item.tags && item.tags.length > 0}
	<div class="mb-4 flex-shrink-0">
		<h4 class="mb-2 text-sm font-semibold text-base-content/60">タグ:</h4>
		<div class="flex flex-wrap gap-2">
			{#each item.tags as tag}
				<TagBadge {tag} removable={false} />
			{/each}
		</div>
	</div>
{/if}
```

### 2. WorkLogEditModal の拡張

**ファイル**: `src/routes/_components/WorkLogEditModal/WorkLogEditModal.svelte`

#### 変更点

1. Props に `tags` と `tagSuggestions` を追加
2. TagInput コンポーネントをインポート
3. タグ入力フィールドを追加
4. フォーム送信時に tags を含める
5. バリデーションエラー処理

#### 実装例

```svelte
<script lang="ts">
	import TagInput from '../TagInput/TagInput.svelte';

	type EditableWorkLog = {
		id: string;
		startedAt: Date;
		endedAt: Date | null;
		description: string;
		tags: string[];
	};

	type Props = {
		workLog: EditableWorkLog;
		open: boolean;
		onclose?: () => void;
		onupdated?: (workLog: WorkLog) => void;
		tagSuggestions: Array<{ tag: string; count: number }>;
	};

	let { workLog, open = $bindable(false), onclose, onupdated, tagSuggestions }: Props = $props();

	// フォーム入力値
	let tags = $state<string[]>([]);

	// workLogが変更されたら、フォーム値を初期化
	$effect(() => {
		if (!workLog) return;
		// ... 既存の初期化
		tags = [...workLog.tags];
	});
</script>

<!-- DescriptionField の下に追加 -->
<div class="form-control">
	<label class="label" for="tags-input">
		<span class="label-text">タグ</span>
	</label>
	<TagInput id="tags-input" bind:tags suggestions={tagSuggestions} placeholder="開発 PJ-A 会議" />
	<input type="hidden" name="tags" value={tags.join(' ')} />
</div>
```

### 3. 親コンポーネントの修正

#### WorkLogList.svelte

詳細ダイアログを開く際に `tags` を渡す:

```svelte
{#if detailDialog.item}
	<WorkLogDetailDialog
		item={{
			...detailDialog.item,
			tags: detailDialog.item.tags || [],
		}}
		duration={detailDialog.item.durationSec}
		onClose={closeDetailDialog}
	/>
{/if}
```

#### +page.svelte または編集モーダルを開く箇所

編集モーダルを開く際に `tagSuggestions` を渡す:

```svelte
{#if editModal.open && editModal.workLog}
	<WorkLogEditModal
		bind:open={editModal.open}
		workLog={editModal.workLog}
		tagSuggestions={data.tagSuggestions}
		onupdated={handleWorkLogUpdated}
	/>
{/if}
```

### 4. Server Actions の確認

既に `update` アクションはタグをサポートしているため、追加の変更は不要。

**確認事項**:

- `src/routes/_actions/update.ts` が `tags` パラメータを受け取っている
- `saveWorkLogTags` が正しく呼ばれている

## テスト観点

### WorkLogDetailDialog

#### UT-1: タグの表示

- タグがある場合、TagBadge で表示される
- タグがない場合、タグセクションが表示されない
- 複数のタグが正しく表示される
- TagBadge は読み取り専用（removable=false）

#### UT-2: Props の型

- `item.tags` が string[] として受け取れる
- タグがない場合（空配列）でもエラーにならない

### WorkLogEditModal

#### UT-3: タグの初期表示

- モーダルを開くと、既存のタグが TagInput に表示される
- タグがない場合は空の状態で表示される

#### UT-4: タグの編集

- タグを追加できる
- タグを削除できる
- オートコンプリートが機能する
- スペース区切りで複数タグを入力できる

#### UT-5: フォーム送信

- 保存ボタンをクリックすると、tags が FormData に含まれる
- tags が正しくスペース区切りの文字列として送信される

#### UT-6: バリデーション

- タグ数が20個を超える場合、エラーメッセージが表示される
- タグ名が100文字を超える場合、エラーメッセージが表示される

### 統合テスト

#### IT-1: 詳細ダイアログの表示

1. 作業一覧でタグ付きの作業をクリック
2. 詳細ダイアログが開く
3. タグがバッジ形式で表示される

#### IT-2: 編集モーダルでのタグ変更

1. 作業記録の編集ボタンをクリック
2. 編集モーダルが開く
3. 既存のタグが表示されている
4. タグを追加・削除
5. 保存ボタンをクリック
6. 作業記録が更新され、タグも保存される
7. 詳細ダイアログで確認すると、更新されたタグが表示される

## セキュリティ

- タグのサニタイゼーションは既に実装済み（F-003）
- XSS対策: TagBadge コンポーネントでテキストをエスケープ

## パフォーマンス

- TagInput コンポーネントは既に最適化済み（デバウンス処理）
- 詳細ダイアログでのタグ表示は軽量（静的表示のみ）

## アクセシビリティ

- タグ入力フィールドに適切な `label` を設定
- キーボード操作のサポート（TagInput で実装済み）
- スクリーンリーダーへの対応（ARIA属性）

## 完了基準

- [ ] WorkLogDetailDialog にタグ表示が追加されている
- [ ] WorkLogEditModal にタグ入力フィールドが追加されている
- [ ] タグの追加・削除・編集が正常に動作する
- [ ] オートコンプリートが機能する
- [ ] すべてのテストが合格する
- [ ] 型チェックが通る
- [ ] 動作確認が完了している

## 既知の制限事項

なし（F-003 で実装済みのコンポーネントを再利用するため）

## 将来の拡張

- タグをクリックしてフィルタリング（F-006で実装予定）
- タグの色をカスタマイズ可能に
