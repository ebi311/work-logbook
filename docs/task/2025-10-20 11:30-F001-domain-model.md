# タスク: F-001 ドメインモデル定義（Zodスキーマ）

作成日時: 2025-10-20T11:30:00Z  
関連タスク: [F-001 データモデル実装](./2025-10-19%2013:00-F001-worklog-model.md)  
関連機能仕様: [F-001 作業開始・終了](../features/2025-10-19%2012:51-F001-start-stop.md)

## 目的

F-001「作業開始・終了」機能で扱うドメインモデルをZodスキーマで定義する。
- API境界でのバリデーション
- 型安全性の向上
- DBスキーマとドメインモデルの分離

## 実装範囲

### 対象
- `WorkLog` ドメインモデル（Zodスキーマ）
- API リクエスト/レスポンス用のスキーマ
- 型エクスポート（TypeScript型推論）
- バリデーション関数

### 対象外（後続タスク）
- SvelteKit form actions での利用
- UI コンポーネントでのバリデーション

## モデル設計

### 1. WorkLog ドメインモデル

**用途:** アプリケーション内部で扱う作業記録の完全な表現

**スキーマ名:** `workLogSchema`  
**エクスポート型:** `WorkLog`

| フィールド | 型 | 必須 | Null許可 | Zodバリデーション | 説明 |
|-----------|-----|------|----------|------------------|------|
| id | string | ✓ | - | `z.string().uuid()` | 作業記録ID（UUID） |
| userId | string | ✓ | - | `z.string().uuid()` | ユーザーID（UUID） |
| startedAt | Date | ✓ | - | `z.date()` | 作業開始日時 |
| endedAt | Date | - | ✓ | `z.date().nullable()` | 作業終了日時（進行中の場合はnull） |
| createdAt | Date | ✓ | - | `z.date()` | レコード作成日時 |
| updatedAt | Date | ✓ | - | `z.date()` | レコード更新日時 |

**特徴:**
- DB層の型（`typeof workLogs.$inferSelect`）と互換性あり
- JavaScript Dateオブジェクトを使用
- nullable() で明示的なnull許可

### 2. API リクエストスキーマ

#### 2-1. 作業開始リクエスト

**スキーマ名:** `startWorkLogRequestSchema`  
**エクスポート型:** `StartWorkLogRequest`

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| _(なし)_ | - | - | userIdは認証から取得 |

**Zodスキーマ:** `z.object({})`

#### 2-2. 作業終了リクエスト

**スキーマ名:** `stopWorkLogRequestSchema`  
**エクスポート型:** `StopWorkLogRequest`

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| _(なし)_ | - | - | 進行中の作業を自動検索 |

**Zodスキーマ:** `z.object({})`

### 3. API レスポンススキーマ

#### 3-1. 作業開始レスポンス

**スキーマ名:** `startWorkLogResponseSchema`  
**エクスポート型:** `StartWorkLogResponse`  
**用途:** 作業開始APIの成功レスポンス

| フィールド | 型 | 必須 | Null許可 | Zodバリデーション | 説明 |
|-----------|-----|------|----------|------------------|------|
| ok | boolean | ✓ | - | `z.literal(true)` | 成功フラグ（常にtrue） |
| workLog | WorkLog | ✓ | - | `workLogSchema` | 作成された作業記録 |
| serverNow | Date | ✓ | - | `z.date()` | サーバー現在時刻 |

#### 3-2. 作業終了レスポンス

**スキーマ名:** `stopWorkLogResponseSchema`  
**エクスポート型:** `StopWorkLogResponse`  
**用途:** 作業終了APIの成功レスポンス

| フィールド | 型 | 必須 | Null許可 | Zodバリデーション | 説明 |
|-----------|-----|------|----------|------------------|------|
| ok | boolean | ✓ | - | `z.literal(true)` | 成功フラグ（常にtrue） |
| workLog | WorkLog | ✓ | - | `workLogSchema` | 更新された作業記録 |
| serverNow | Date | ✓ | - | `z.date()` | サーバー現在時刻 |
| durationSec | number | ✓ | - | `z.number().int().nonnegative()` | 作業時間（秒） |

#### 3-3. 初期状態取得レスポンス

**スキーマ名:** `loadWorkLogResponseSchema`  
**エクスポート型:** `LoadWorkLogResponse`  
**用途:** ページ読み込み時の初期状態取得レスポンス

| フィールド | 型 | 必須 | Null許可 | Zodバリデーション | 説明 |
|-----------|-----|------|----------|------------------|------|
| active | WorkLog | ✓ | ✓ | `workLogSchema.nullable()` | 進行中の作業（なければnull） |
| serverNow | Date | ✓ | - | `z.date()` | サーバー現在時刻 |

### 4. エラーレスポンススキーマ

**スキーマ名:** `errorResponseSchema`  
**エクスポート型:** `ErrorResponse`  
**用途:** API処理失敗時の共通エラーレスポンス

| フィールド | 型 | 必須 | Null許可 | Zodバリデーション | 説明 |
|-----------|-----|------|----------|------------------|------|
| ok | boolean | ✓ | - | `z.literal(false)` | 失敗フラグ（常にfalse） |
| reason | string | ✓ | - | `z.enum([...])` | エラー理由コード（下記参照） |
| message | string | ✓ | - | `z.string()` | ユーザー向けエラーメッセージ |
| serverNow | Date | - | - | `z.date().optional()` | サーバー現在時刻 |
| active | WorkLog | - | - | `workLogSchema.optional()` | 既存の進行中作業（ACTIVE_EXISTSの場合） |

**エラー理由コード:**

| コード | 説明 | 含まれる追加フィールド |
|--------|------|----------------------|
| ACTIVE_EXISTS | 既に進行中の作業が存在する | `active` |
| NO_ACTIVE | 進行中の作業が見つからない | - |
| UNAUTHORIZED | 認証エラー | - |
| INTERNAL_ERROR | サーバー内部エラー | - |

## ファイル構成

```
src/
├── models/
│   ├── workLog.ts              # WorkLogドメインモデル
│   ├── workLog.spec.ts         # モデルのテスト
│   └── index.ts                # 再エクスポート
```

## 実装ステップ

### ステップ1: Zodのインストール

```bash
pnpm add zod
```

### ステップ2: WorkLogドメインモデル定義

**ファイル:** `src/models/workLog.ts`

**実装内容:**

1. **スキーマ定義**
   - 上記「モデル設計」セクションの表に基づいてZodスキーマを定義

2. **型エクスポート**
   - 各スキーマから `z.infer<typeof 〇〇Schema>` で型を推論してエクスポート

3. **バリデーション関数**

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| `validateWorkLog` | `data: unknown` | `WorkLog` | データをパースし、失敗時は例外をスロー |
| `isWorkLog` | `data: unknown` | `data is WorkLog` | 型ガード関数（boolean返却） |

**エクスポート一覧:**

| エクスポート名 | 種類 | 説明 |
|---------------|------|------|
| `workLogSchema` | Zodスキーマ | WorkLogスキーマ |
| `WorkLog` | 型 | WorkLog型 |
| `startWorkLogResponseSchema` | Zodスキーマ | 作業開始レスポンススキーマ |
| `StartWorkLogResponse` | 型 | 作業開始レスポンス型 |
| `stopWorkLogResponseSchema` | Zodスキーマ | 作業終了レスポンススキーマ |
| `StopWorkLogResponse` | 型 | 作業終了レスポンス型 |
| `loadWorkLogResponseSchema` | Zodスキーマ | 初期状態取得レスポンススキーマ |
| `LoadWorkLogResponse` | 型 | 初期状態取得レスポンス型 |
| `errorResponseSchema` | Zodスキーマ | エラーレスポンススキーマ |
| `ErrorResponse` | 型 | エラーレスポンス型 |
| `validateWorkLog` | 関数 | バリデーション関数 |
| `isWorkLog` | 関数 | 型ガード関数 |

### ステップ3: 再エクスポート

**ファイル:** `src/models/index.ts`

**実装内容:**
- `./workLog` からすべてをre-export
- `$models` エイリアスでインポートできるようにする

### ステップ4: テストコード作成

**ファイル:** `src/models/workLog.spec.ts`

**テストスイート構成:**

| テストスイート | テストケース | 検証内容 |
|---------------|-------------|---------|
| `workLogSchema` | 正常系: 正しいデータをパースできる | 全フィールドが正しい形式の場合、パース成功 |
| | 異常系: 不正なUUIDでエラー | UUID形式が不正な場合、例外をスロー |
| | 異常系: 不正な日時形式でエラー | Date型でない値の場合、例外をスロー |
| `startWorkLogResponseSchema` | 正常系: 作業開始レスポンスをパースできる | レスポンス構造が正しい場合、パース成功 |
| `errorResponseSchema` | 正常系: エラーレスポンスをパースできる | エラー構造が正しい場合、パース成功 |
| `validateWorkLog` | 正常系: バリデーション成功 | 正しいデータで例外が発生しない |
| `isWorkLog` | 正常系: 型ガード成功 | 正しいデータでtrueを返す |
| | 異常系: 型ガード失敗 | 不正なデータでfalseを返す |

**テストデータ:**

| データ種類 | 使用するフィールド値 |
|-----------|---------------------|
| 正常なWorkLog | id: UUID, userId: UUID, 日時: Date型, endedAt: null |
| 不正なUUID | id: "invalid-uuid" |
| 不正な日時 | startedAt: "invalid-date" (文字列) |
| エラーレスポンス | ok: false, reason: "ACTIVE_EXISTS", message: 文字列 |

### ステップ5: DB層との統合（オプション）

**ファイル:** `src/lib/server/db/workLogs.ts`（既存ファイルに追加）

**変換関数定義:**

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| `toWorkLogDomain` | `dbWorkLog: DbWorkLog` | `DomainWorkLog` | DB型からドメイン型への変換 |

**変換処理:**
- DB層の各フィールドをドメイン型にマッピング
- `validateWorkLog()` を使用してバリデーション実行
- 型安全性を保証

**インポート:**
- `validateWorkLog` および `WorkLog as DomainWorkLog` を `$models/workLog` からインポート
- `WorkLog as DbWorkLog` を `./schema` からインポート（型の衝突を避けるためエイリアス使用）

## 合格基準

### 必須条件
- [ ] Zodがインストールされている
- [ ] `WorkLog` ドメインモデルが定義されている
- [ ] API レスポンススキーマが定義されている
- [ ] エラーレスポンススキーマが定義されている
- [ ] 全テストケースが PASS する
- [ ] TypeScript の型チェックが通る
- [ ] バリデーション関数が動作する

### 推奨条件
- [ ] 型ガード関数が実装されている
- [ ] DB層との変換関数が実装されている
- [ ] JSDocコメントが記載されている

## 決定事項

### 技術選定
- **バリデーションライブラリ:** Zod（TypeScript first、型推論が強力）
- **日時形式:** JavaScript Date オブジェクト（`z.date()`）
- **null vs undefined:** nullable() を使用（DB層と一致）

### DB層との関係
- **分離理由:**
  - DB層: ORMの型（Drizzle）
  - ドメイン層: ビジネスロジックの型（Zod）
  - API層: バリデーション済みの型（Zod）
- **変換:** DB層 → ドメイン層への変換関数を提供

### エラーハンドリング
- `parse()`: エラー時に例外をスロー
- `safeParse()`: エラー時に `{ success: false, error }` を返す
- 型ガード: `is〇〇()` 関数で実装

## 参考資料
- [Zod Documentation](https://zod.dev/)
- [Zod: TypeScript-first schema validation](https://github.com/colinhacks/zod)

---

**次のステップ:** Zodのインストールとモデル定義
