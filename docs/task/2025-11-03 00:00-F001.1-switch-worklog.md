# F-001.1: 作業切り替え機能の実装

## 概要

作業の終了と同時に新しい作業を開始できる「切り替え」機能を実装する。

## 背景

ユーザーは複数の作業間をスムーズに切り替えたい。現在は「終了」→「開始」の2ステップが必要だが、これを1クリックで実行できるようにすることで、作業記録の効率を向上させる。

## 機能要件

### ユースケース

1. ユーザーが進行中の作業を持っている
2. 「切り替え」ボタンをクリック
3. 現在の作業が終了し、同時に新しい作業が開始される
4. 作業内容とタグは新しい作業に引き継がれる(フォームに入力されている値を使用)

### 動作仕様

- **ボタンの表示条件**: 進行中の作業がある場合のみ表示
- **アトミック性**: 終了と開始を1つのトランザクションで実行し、途中で失敗した場合はロールバック
- **入力値の扱い**: フォームに入力された作業内容とタグを新しい作業に適用
- **レスポンス**: 終了した作業と開始した作業の両方の情報を返す

## 実装ステップ

### Step 1: Server Action の実装

#### ファイル: `src/routes/_actions/switch.ts`

新しいアクションを作成:

- 現在の進行中の作業を取得
- 作業がなければエラー
- トランザクション内で:
  - 現在の作業を終了
  - 新しい作業を開始
  - タグを保存
- 両方の作業情報を返す

#### ファイル: `src/routes/+page.server.ts`

`switch` アクションを追加

### Step 2: UI実装

#### ファイル: `src/routes/_components/WorkLogToggleButton/WorkLogToggleButton.svelte`

- 切り替えボタンの追加
- 進行中の作業がある場合のみ表示
- 既存の開始/終了ボタンと同様のスタイル

#### ファイル: `src/routes/+page.svelte`

- `switch` アクションのハンドリング
- 成功時のトースト表示
- エラーハンドリング

### Step 3: テストコード

#### ファイル: `src/routes/_actions/switch.spec.ts`

- 正常系: 進行中の作業を終了し、新しい作業を開始
- 異常系: 進行中の作業がない
- タグの引き継ぎ確認
- トランザクションのロールバック確認

## 合格基準

- [x] 進行中の作業がある場合、「切り替え」ボタンが表示される
- [x] 切り替えボタンをクリックすると、現在の作業が終了し新しい作業が開始される
- [x] 作業内容とタグがフォームから新しい作業に引き継がれる
- [x] 切り替え成功時に適切なトーストメッセージが表示される
- [x] エラー時に適切なエラーメッセージが表示される
- [x] ユニットテストが全て成功する

## API仕様

### POST /?/switch

#### Request (FormData)

```
description: string (任意) - 新しい作業の内容
tags: string[] (任意) - 新しい作業のタグ
```

#### Response (Success)

```typescript
{
  ok: true,
  stopped: {
    id: string,
    startedAt: string,
    endedAt: string,
    description: string,
    tags: string[],
    durationSec: number
  },
  started: {
    id: string,
    startedAt: string,
    endedAt: null,
    description: string,
    tags: string[]
  },
  serverNow: string
}
```

#### Response (Failure - No Active Work)

```typescript
{
  reason: 'NO_ACTIVE',
  serverNow: string
}
```

## DBトランザクション

```sql
BEGIN TRANSACTION;
  -- 現在の作業を終了
  UPDATE work_logs SET ended_at = ?, description = ? WHERE id = ? AND ended_at IS NULL;

  -- 新しい作業を開始
  INSERT INTO work_logs (id, user_id, started_at, description) VALUES (?, ?, ?, ?);

  -- タグを保存(古い作業と新しい作業の両方)
  DELETE FROM work_log_tags WHERE work_log_id IN (?, ?);
  INSERT INTO work_log_tags (work_log_id, tag) VALUES ...;
COMMIT;
```

## 関連機能

- F-001: 作業開始・終了
- F-003: タグ付け
