# タスク: F-001 ドメインモデル定義（Zodスキーマ）

作成日時: 2025-10-20T11:30:00Z  
関連タスク: [F-001 データモデル実装](./2025-10-19%2013:00-F001-worklog-model.md)  
関連機能仕様: [F-001 作業開始・終了](../features/2025-10-19%2012:51-F001-start-stop.md)

## 目的

F-001「作業開始・終了」機能で扱うドメインモデルをZodスキーマで定義する。
- API境界でのバリデーション
- 型安全性の向上
- DBスキーマとドメインモデルの分離

## 実装範囲

### 対象
- `WorkLog` ドメインモデル（Zodスキーマ）
- API リクエスト/レスポンス用のスキーマ
- 型エクスポート（TypeScript型推論）
- バリデーション関数

### 対象外（後続タスク）
- SvelteKit form actions での利用
- UI コンポーネントでのバリデーション

## モデル設計

### 1. WorkLog ドメインモデルクラス

**用途:** アプリケーション内部で扱う作業記録の完全な表現

**設計方針:** クラスベース設計
- `private constructor` で直接インスタンス化を防止
- ファクトリメソッドでバリデーション付き生成
- `readonly` プロパティで不変性を保証
- ビジネスロジックをメソッドとして実装

#### プロパティ

| プロパティ | 型 | 修飾子 | 説明 |
|-----------|-----|--------|------|
| id | string | readonly | 作業記録ID（UUID） |
| userId | string | readonly | ユーザーID（UUID） |
| startedAt | Date | readonly | 作業開始日時 |
| endedAt | Date \| null | readonly | 作業終了日時（進行中の場合はnull） |
| createdAt | Date | readonly | レコード作成日時 |
| updatedAt | Date | readonly | レコード更新日時 |

#### コンストラクタ

| シグネチャ | アクセス修飾子 | 説明 |
|-----------|--------------|------|
| `constructor(props: WorkLogProps)` | private | 直接インスタンス化を防止、ファクトリメソッドを使用 |

#### 静的メソッド（ファクトリ）

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| `from(data: unknown)` | data: バリデーション対象 | `WorkLog` | Zodでバリデーション後、インスタンス生成。失敗時は例外 |
| `isValid(data: unknown)` | data: チェック対象 | `boolean` | データが有効なWorkLog形式かチェック（型ガード） |

#### インスタンスメソッド（ビジネスロジック）

| メソッド | 引数 | 戻り値 | 説明 |
|---------|------|--------|------|
| `isActive()` | なし | `boolean` | 作業が進行中（endedAt === null）の場合true |
| `getDuration()` | なし | `number \| null` | 作業時間を秒単位で返す。進行中の場合null |
| `canStop()` | なし | `boolean` | 作業を停止可能（進行中）の場合true |
| `toObject()` | なし | `WorkLogProps` | プレーンオブジェクトに変換 |

#### バリデーションルール

内部的にZodスキーマを使用:

| フィールド | Zodバリデーション | 説明 |
|-----------|------------------|------|
| id | `z.string().uuid()` | UUID形式 |
| userId | `z.string().uuid()` | UUID形式 |
| startedAt | `z.date()` | Date型 |
| endedAt | `z.date().nullable()` | Date型またはnull |
| createdAt | `z.date()` | Date型 |
| updatedAt | `z.date()` | Date型 |

**ビジネスルール制約:**
- `endedAt` が null でない場合、`startedAt` より大きい日付であること
- 実装: `.refine()` を使用してカスタムバリデーション

**特徴:**
- DB層の型（`typeof workLogs.$inferSelect`）と互換性あり
- JavaScript Dateオブジェクトを使用
- 不変性（immutability）を保証

### 2. API リクエストスキーマ

#### 2-1. 作業開始リクエスト

**スキーマ名:** `startWorkLogRequestSchema`  
**エクスポート型:** `StartWorkLogRequest`

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| _(なし)_ | - | - | userIdは認証から取得 |

**Zodスキーマ:** `z.object({})`

#### 2-2. 作業終了リクエスト

**スキーマ名:** `stopWorkLogRequestSchema`  
**エクスポート型:** `StopWorkLogRequest`

| フィールド | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| _(なし)_ | - | - | 進行中の作業を自動検索 |

**Zodスキーマ:** `z.object({})`

### 3. API レスポンススキーマ

#### 3-1. 作業開始レスポンス

**スキーマ名:** `startWorkLogResponseSchema`  
**エクスポート型:** `StartWorkLogResponse`  
**用途:** 作業開始APIの成功レスポンス

| フィールド | 型 | 必須 | Null許可 | Zodバリデーション | 説明 |
|-----------|-----|------|----------|------------------|------|
| ok | boolean | ✓ | - | `z.literal(true)` | 成功フラグ（常にtrue） |
| workLog | WorkLog | ✓ | - | `workLogSchema` | 作成された作業記録 |
| serverNow | Date | ✓ | - | `z.date()` | サーバー現在時刻 |

#### 3-2. 作業終了レスポンス

**スキーマ名:** `stopWorkLogResponseSchema`  
**エクスポート型:** `StopWorkLogResponse`  
**用途:** 作業終了APIの成功レスポンス

| フィールド | 型 | 必須 | Null許可 | Zodバリデーション | 説明 |
|-----------|-----|------|----------|------------------|------|
| ok | boolean | ✓ | - | `z.literal(true)` | 成功フラグ（常にtrue） |
| workLog | WorkLog | ✓ | - | `workLogSchema` | 更新された作業記録 |
| serverNow | Date | ✓ | - | `z.date()` | サーバー現在時刻 |
| durationSec | number | ✓ | - | `z.number().int().nonnegative()` | 作業時間（秒） |

#### 3-3. 初期状態取得レスポンス

**スキーマ名:** `loadWorkLogResponseSchema`  
**エクスポート型:** `LoadWorkLogResponse`  
**用途:** ページ読み込み時の初期状態取得レスポンス

| フィールド | 型 | 必須 | Null許可 | Zodバリデーション | 説明 |
|-----------|-----|------|----------|------------------|------|
| active | WorkLog | ✓ | ✓ | `workLogSchema.nullable()` | 進行中の作業（なければnull） |
| serverNow | Date | ✓ | - | `z.date()` | サーバー現在時刻 |

### 4. エラーレスポンススキーマ

**スキーマ名:** `errorResponseSchema`  
**エクスポート型:** `ErrorResponse`  
**用途:** API処理失敗時の共通エラーレスポンス

| フィールド | 型 | 必須 | Null許可 | Zodバリデーション | 説明 |
|-----------|-----|------|----------|------------------|------|
| ok | boolean | ✓ | - | `z.literal(false)` | 失敗フラグ（常にfalse） |
| reason | string | ✓ | - | `z.enum([...])` | エラー理由コード（下記参照） |
| message | string | ✓ | - | `z.string()` | ユーザー向けエラーメッセージ |
| serverNow | Date | - | - | `z.date().optional()` | サーバー現在時刻 |
| active | WorkLog | - | - | `workLogSchema.optional()` | 既存の進行中作業（ACTIVE_EXISTSの場合） |

**エラー理由コード:**

| コード | 説明 | 含まれる追加フィールド |
|--------|------|----------------------|
| ACTIVE_EXISTS | 既に進行中の作業が存在する | `active` |
| NO_ACTIVE | 進行中の作業が見つからない | - |
| UNAUTHORIZED | 認証エラー | - |
| INTERNAL_ERROR | サーバー内部エラー | - |

## ファイル構成

```
src/
├── models/
│   ├── workLog.ts              # WorkLogドメインモデル
│   ├── workLog.spec.ts         # モデルのテスト
│   └── index.ts                # 再エクスポート
```

## 実装ステップ

### ステップ1: Zodのインストール

```bash
pnpm add zod
```

### ステップ2: WorkLogドメインモデル定義

**ファイル:** `src/models/workLog.ts`

**実装内容:**

1. **Zodスキーマ定義（内部使用）**
   - `workLogSchema` を内部的に定義（エクスポートしない）
   - `.refine()` でカスタムバリデーションを追加:
     - 条件: `endedAt` が null でない場合、`endedAt > startedAt`
     - エラーメッセージ: "endedAt must be greater than startedAt"

2. **WorkLogクラス実装**
   - `private constructor(props: WorkLogProps)` - 直接インスタンス化を防止
   - 静的メソッド:
     - `from(data: unknown): WorkLog` - ファクトリメソッド（バリデーション付き）
     - `isValid(data: unknown): boolean` - 型ガード
   - インスタンスメソッド:
     - `isActive(): boolean` - 進行中判定
     - `getDuration(): number | null` - 作業時間取得
     - `canStop(): boolean` - 停止可能判定
     - `toObject(): WorkLogProps` - プレーンオブジェクト変換

3. **レスポンス型定義**
   - API レスポンススキーマ用のZodスキーマ
   - TypeScript型定義（WorkLogクラスインスタンスを含む）

4. **後方互換性関数（非推奨）**

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| `validateWorkLog` | `data: unknown` | `WorkLog` | `@deprecated` WorkLog.from()を使用 |
| `isWorkLog` | `data: unknown` | `boolean` | `@deprecated` WorkLog.isValid()を使用 |

**エクスポート一覧:**

| エクスポート名 | 種類 | 説明 |
|---------------|------|------|
| `WorkLog` | クラス | WorkLogドメインモデルクラス |
| `startWorkLogResponseSchema` | Zodスキーマ | 作業開始レスポンススキーマ |
| `StartWorkLogResponse` | 型 | 作業開始レスポンス型 |
| `stopWorkLogResponseSchema` | Zodスキーマ | 作業終了レスポンススキーマ |
| `StopWorkLogResponse` | 型 | 作業終了レスポンス型 |
| `loadWorkLogResponseSchema` | Zodスキーマ | 初期状態取得レスポンススキーマ |
| `LoadWorkLogResponse` | 型 | 初期状態取得レスポンス型 |
| `errorResponseSchema` | Zodスキーマ | エラーレスポンススキーマ |
| `ErrorResponse` | 型 | エラーレスポンス型 |
| `validateWorkLog` | 関数 | バリデーション関数（非推奨） |
| `isWorkLog` | 関数 | 型ガード関数（非推奨） |

### ステップ3: 再エクスポート

**ファイル:** `src/models/index.ts`

**実装内容:**
- `./workLog` からすべてをre-export
- `$models` エイリアスでインポートできるようにする

### ステップ4: テストコード作成

**ファイル:** `src/models/workLog.spec.ts`

**テストスイート構成:**

| テストスイート | テストケース | 検証内容 |
|---------------|-------------|---------|
| `WorkLog.from()` | 正常系: 正しいデータをパースできる（進行中） | endedAtがnullの場合、インスタンス生成成功 |
| | 正常系: 正しいデータをパースできる（完了） | endedAtがstartedAtより大きい場合、インスタンス生成成功 |
| | 異常系: 不正なUUIDでエラー | UUID形式が不正な場合、例外をスロー |
| | 異常系: 不正な日時形式でエラー | Date型でない値の場合、例外をスロー |
| | 異常系: endedAtがstartedAt以前でエラー | endedAt < startedAt の場合、例外をスロー |
| | 異常系: endedAtがstartedAtと同じでエラー | endedAt = startedAt の場合、例外をスロー |
| `WorkLog.isValid()` | 正常系: 型ガード成功 | 正しいデータでtrueを返す |
| | 異常系: 型ガード失敗 | 不正なデータでfalseを返す |
| `WorkLog#isActive()` | 進行中の作業の場合はtrueを返す | endedAtがnullの場合、true |
| | 完了した作業の場合はfalseを返す | endedAtがある場合、false |
| `WorkLog#getDuration()` | 完了した作業の場合は作業時間（秒）を返す | endedAt - startedAt を秒で返す |
| | 進行中の作業の場合はnullを返す | endedAtがnullの場合、null |
| `WorkLog#canStop()` | 進行中の作業の場合はtrueを返す | isActive()がtrueの場合、true |
| | 完了した作業の場合はfalseを返す | isActive()がfalseの場合、false |
| `WorkLog#toObject()` | プレーンオブジェクトに変換できる | 元のデータと同じ構造のオブジェクトを返す |
| `startWorkLogResponseSchema` | 正常系: 作業開始レスポンスをパースできる | レスポンス構造が正しい場合、パース成功 |
| `errorResponseSchema` | 正常系: エラーレスポンスをパースできる | エラー構造が正しい場合、パース成功 |
| `validateWorkLog` | 正常系: バリデーション成功 | 正しいデータでWorkLogインスタンスを返す |
| `isWorkLog (deprecated)` | 正常系: 型ガード成功 | 正しいデータでtrueを返す |
| | 異常系: 型ガード失敗 | 不正なデータでfalseを返す |

**テストデータ:**

| データ種類 | 使用するフィールド値 | 用途 |
|-----------|---------------------|------|
| 正常なWorkLog（進行中） | id: UUID, userId: UUID, 日時: Date型, endedAt: null | インスタンス生成、isActive, canStop |
| 正常なWorkLog（完了） | id: UUID, userId: UUID, startedAt: Date, endedAt: startedAt + 1時間 | インスタンス生成、getDuration |
| 不正なUUID | id: "invalid-uuid" | バリデーションエラー確認 |
| 不正な日時 | startedAt: "invalid-date" (文字列) | 型エラー確認 |
| 不正なendedAt（過去） | startedAt: 2025-10-20 12:00, endedAt: 2025-10-20 11:00 | ビジネスルール違反確認 |
| 不正なendedAt（同時刻） | startedAt: 2025-10-20 12:00, endedAt: 2025-10-20 12:00 | ビジネスルール違反確認 |
| エラーレスポンス | ok: false, reason: "ACTIVE_EXISTS", message: 文字列 | レスポンススキーマ検証 |

### ステップ5: DB層との統合（オプション）

**ファイル:** `src/lib/server/db/workLogs.ts`（既存ファイルに追加）

**変換関数定義:**

| 関数名 | 引数 | 戻り値 | 説明 |
|--------|------|--------|------|
| `toWorkLogDomain` | `dbWorkLog: DbWorkLog` | `DomainWorkLog` | DB型からドメイン型への変換 |

**変換処理:**
- DB層の各フィールドをドメイン型にマッピング
- `validateWorkLog()` を使用してバリデーション実行
- 型安全性を保証

**インポート:**
- `validateWorkLog` および `WorkLog as DomainWorkLog` を `$models/workLog` からインポート
- `WorkLog as DbWorkLog` を `./schema` からインポート（型の衝突を避けるためエイリアス使用）

## 合格基準

### 必須条件
- [x] Zodがインストールされている（v4.1.12）
- [x] `WorkLog` ドメインモデルが定義されている
- [x] API レスポンススキーマが定義されている
- [x] エラーレスポンススキーマが定義されている
- [x] 全テストケースが PASS する（11/11 テスト成功）
- [x] TypeScript の型チェックが通る
- [x] バリデーション関数が動作する

### 推奨条件
- [x] 型ガード関数が実装されている
- [ ] DB層との変換関数が実装されている（オプション）
- [x] JSDocコメントが記載されている

## 決定事項

### 技術選定
- **バリデーションライブラリ:** Zod（TypeScript first、型推論が強力）
- **日時形式:** JavaScript Date オブジェクト（`z.date()`）
- **null vs undefined:** nullable() を使用（DB層と一致）
- **設計パターン:** クラスベース設計
  - private constructor + ファクトリメソッド
  - readonly プロパティで不変性保証
  - ビジネスロジックをメソッドとして実装

### DB層との関係
- **分離理由:**
  - DB層: ORMの型（Drizzle） - プレーンオブジェクト
  - ドメイン層: ビジネスロジックの型（WorkLogクラス） - メソッド付きオブジェクト
  - API層: バリデーション済みの型（Zod + WorkLogクラス）
- **変換:** 
  - DB → ドメイン: `WorkLog.from(dbData)` でインスタンス化
  - ドメイン → DB: `workLog.toObject()` でプレーンオブジェクト化

### エラーハンドリング
- `parse()`: エラー時に例外をスロー
- `safeParse()`: エラー時に `{ success: false, error }` を返す
- 型ガード: `is〇〇()` 関数で実装

## 参考資料
- [Zod Documentation](https://zod.dev/)
- [Zod: TypeScript-first schema validation](https://github.com/colinhacks/zod)

## 実装結果

### 実装日
2025-10-20

### テスト結果
- ✅ 20/20 テスト成功
- ✅ 型チェック成功（pnpm tsc --noEmit）
- ✅ すべての合格基準を満たす

### 主な設計変更
当初の設計から以下の改善を実施:

1. **関数ベース → クラスベース設計**
   - 単純な型定義とバリデーション関数から、ビジネスロジックを持つクラスに変更
   - 不変性を `readonly` で保証
   - `private constructor` でインスタンス生成を制御

2. **ビジネスメソッドの追加**
   - `isActive()`: 進行中判定
   - `getDuration()`: 作業時間計算
   - `canStop()`: 停止可能判定
   - `toObject()`: DB層への変換

3. **後方互換性の維持**
   - `validateWorkLog()`, `isWorkLog()` を `@deprecated` として残存
   - 既存コードへの影響を最小化

---

**ステータス:** ✅ 完了
