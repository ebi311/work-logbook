# F-006: 日付フィルタUIの実装

作成日: 2025-11-01T16:00:00Z  
ステータス: 実装中

## 概要

作業一覧のフィルタバーに日付フィルタのUIを追加します。バックエンドの日付フィルタ機能は既に実装済みですが、ユーザーが操作するUIが未実装のため、追加します。

## 前提条件

- ✅ F-005: 作業一覧表示実装済み
- ✅ F-006 サーバー側: 日付フィルタ実装済み（+page.server.ts）
- ✅ F-006 UC-001〜005: タグフィルタ実装済み

## 現状の問題

- URLで `?month=2025-10` などを指定すれば日付フィルタは機能する
- しかし、UIから日付を選択する方法がない
- ユーザーはURLを手動で編集するしかない

## 実装する日付フィルタUI

### 基本方針

1. **月選択**: 最も一般的な使い方（月次請求のため）
2. **クイック選択**: 今日、今月（ワンクリック）
3. **期間選択**: より詳細な絞り込み（オプション）
4. **クリア**: フィルタ解除

### UI配置

```
┌─ 絞り込み ──────────────────────────────┐
│                                          │
│ [月選択: 2025-10 ▼] [今日] [今月]       │
│                                          │
│ タグ: [開発 ×] [PJ-A ×] ...             │
│                                          │
└──────────────────────────────────────────┘
```

## 実装ステップ

### Step 1: 日付フィルタコンポーネントの設計

**目的**: WorkLogHistory コンポーネントに日付フィルタUIを追加

**実装方針**:

1. 月選択用のドロップダウン（`<select>`）
2. クイックフィルタボタン（今日、今月）
3. 日付とタグのフィルタを横並びに配置

**Props拡張**:

```typescript
type Props = {
	// ... 既存のProps
	currentMonth?: string; // 現在選択中の月（YYYY-MM形式）
	currentDate?: string; // 現在選択中の日付（YYYY-MM-DD形式）
	onDateFilterChange: (filter: { month?: string; date?: string }) => void;
};
```

### Step 2: 月選択UIの実装

**実装箇所**: `src/routes/_components/WorkLogHistory/WorkLogHistory.svelte`

**UI要素**:

```svelte
<div class="mb-4 rounded-lg bg-base-200 p-4">
	<h3 class="mb-3 text-sm font-semibold">絞り込み</h3>

	<!-- 日付フィルタ -->
	<div class="mb-3 flex gap-2">
		<select
			class="select-bordered select select-sm"
			value={currentMonth ?? ''}
			on:change={handleMonthChange}
		>
			<option value="">すべての月</option>
			{#each monthOptions as month}
				<option value={month}>{month}</option>
			{/each}
		</select>

		<button
			class="btn btn-outline btn-sm"
			on:click={() => onDateFilterChange({ date: todayString })}
		>
			今日
		</button>

		<button
			class="btn btn-outline btn-sm"
			on:click={() => onDateFilterChange({ month: currentMonthString })}
		>
			今月
		</button>
	</div>

	<!-- タグフィルタ -->
	<TagInput ... />
</div>
```

**月の選択肢生成**:

```typescript
// 過去12ヶ月分の選択肢を生成
const generateMonthOptions = (): string[] => {
	const months: string[] = [];
	const now = new Date();

	for (let i = 0; i < 12; i++) {
		const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
		const month = date.toISOString().slice(0, 7); // YYYY-MM
		months.push(month);
	}

	return months;
};
```

**合格基準**:

- 月選択ドロップダウンが表示される
- 過去12ヶ月分の選択肢が表示される
- 「すべての月」を選択するとフィルタが解除される
- 選択した月でフィルタリングされる

### Step 3: +page.svelteでの日付フィルタハンドラ実装

**実装箇所**: `src/routes/+page.svelte`

**実装内容**:

```typescript
// 日付フィルタの状態を URL から取得
let currentMonth = $state<string | undefined>(undefined);
let currentDate = $state<string | undefined>(undefined);

$effect(() => {
	currentMonth = page.url.searchParams.get('month') ?? undefined;
	currentDate = page.url.searchParams.get('date') ?? undefined;
});

// 日付フィルタ変更ハンドラー
const handleDateFilterChange = (filter: { month?: string; date?: string }) => {
	const url = new URL(page.url);

	// 既存の日付パラメータをクリア
	url.searchParams.delete('month');
	url.searchParams.delete('date');
	url.searchParams.delete('from');
	url.searchParams.delete('to');

	// 新しいフィルタを設定
	if (filter.month) {
		url.searchParams.set('month', filter.month);
	} else if (filter.date) {
		url.searchParams.set('date', filter.date);
	}

	// ページをリセット
	url.searchParams.set('page', '1');

	goto(url.toString(), { replaceState: false, noScroll: true, keepFocus: true });
};
```

**WorkLogHistoryへの伝播**:

```svelte
<WorkLogHistory
	{listDataPromise}
	{filterTags}
	{currentMonth}
	{currentDate}
	tagSuggestions={data.tagSuggestions}
	serverNow={currentServerNow}
	onFilterTagsChange={handleFilterTagsChange}
	onDateFilterChange={handleDateFilterChange}
	onTagClick={handleTagClick}
	onEdit={openEditModal}
	onDelete={handleDeleteClick}
/>
```

**合格基準**:

- 日付フィルタ変更時にURLが更新される
- タグフィルタは保持される
- ページが1にリセットされる
- スクロール位置が保持される

### Step 4: 期間選択UIの実装（オプション）

**目的**: より詳細な期間指定を可能にする

**実装内容**:

```svelte
<!-- 詳細フィルタ（展開式） -->
<details class="collapse-arrow collapse bg-base-100">
	<summary class="collapse-title text-sm">詳細フィルタ</summary>
	<div class="collapse-content">
		<div class="form-control">
			<label class="label">
				<span class="label-text">開始日</span>
			</label>
			<input type="date" class="input-bordered input input-sm" bind:value={fromDate} />
		</div>
		<div class="form-control mt-2">
			<label class="label">
				<span class="label-text">終了日</span>
			</label>
			<input type="date" class="input-bordered input input-sm" bind:value={toDate} />
		</div>
		<button class="btn mt-2 btn-sm btn-primary" on:click={handlePeriodFilter}> 適用 </button>
	</div>
</details>
```

**合格基準**:

- 開始日・終了日を指定できる
- 適用ボタンでフィルタが実行される
- from/to パラメータがURLに設定される

### Step 5: テストケースの追加

**実装箇所**: `src/routes/page.svelte.spec.ts`

**テストケース**:

```typescript
describe('F-006: 日付フィルタUI', () => {
	it('月選択ドロップダウンが表示される', async () => {
		// Given: ページが表示されている
		// When: フィルタバーを確認
		// Then: 月選択ドロップダウンが存在する
	});

	it('月を選択すると、その月でフィルタリングされる', async () => {
		// Given: ページが表示されている
		// When: 月選択ドロップダウンから "2025-10" を選択
		// Then: handleDateFilterChange が呼ばれる
	});

	it('「今日」ボタンをクリックすると、今日の作業でフィルタリングされる', async () => {
		// Given: ページが表示されている
		// When: 「今日」ボタンをクリック
		// Then: date パラメータが設定される
	});

	it('「今月」ボタンをクリックすると、今月の作業でフィルタリングされる', async () => {
		// Given: ページが表示されている
		// When: 「今月」ボタンをクリック
		// Then: month パラメータが設定される
	});

	it('日付フィルタを変更しても、タグフィルタは保持される', async () => {
		// Given: タグでフィルタリング中
		// When: 月を変更
		// Then: タグパラメータは保持される
	});

	it('「すべての月」を選択すると、日付フィルタが解除される', async () => {
		// Given: 月でフィルタリング中
		// When: 「すべての月」を選択
		// Then: month パラメータが削除される
	});
});
```

### Step 6: スタイリングと動作確認

**確認項目**:

1. ✅ フィルタバーのレイアウトが整っている
2. ✅ 月選択ドロップダウンが使いやすい
3. ✅ クイックフィルタボタンが目立つ
4. ✅ タグフィルタと並んでも見やすい
5. ✅ モバイルでも操作しやすい
6. ✅ 選択中の月が視覚的にわかる

**コミット**:

```bash
git add -A
git commit -m "F-006: 日付フィルタUIを実装

- WorkLogHistoryに日付フィルタUI追加
  - 月選択ドロップダウン（過去12ヶ月）
  - クイックフィルタ（今日、今月）
  - 「すべての月」でフィルタ解除
- +page.svelteにhandleDateFilterChange実装
  - 日付パラメータを更新
  - タグフィルタは保持
  - ページリセット、スクロール位置保持
- Props拡張（currentMonth, currentDate, onDateFilterChange）
- テストケース追加（6件）
- daisyUIのselect、btnコンポーネントを使用
- 全テスト成功
"
```

## 技術仕様

### URL パラメータの優先順位

既存の仕様通り:

1. `month` が最優先
2. `date` が次
3. `from/to` が最後

日付フィルタ変更時は既存の日付パラメータを全てクリアしてから新しいパラメータを設定。

### 月の選択肢

- 過去12ヶ月分を生成
- 現在の月を含む
- ISO 8601形式（YYYY-MM）

### クイックフィルタ

- **今日**: `date=YYYY-MM-DD`（ローカル日付）
- **今月**: `month=YYYY-MM`（ローカル月）

### タグフィルタとの連携

日付フィルタとタグフィルタは独立して動作:

- 日付を変更してもタグは保持
- タグを変更しても日付は保持
- どちらかをクリアしても、もう一方は保持

## UI/UX仕様

### レイアウト

```
┌─ 絞り込み ──────────────────────────────────────┐
│                                                  │
│ [月を選択 ▼] [今日] [今月]                       │
│                                                  │
│ タグ: [___________________] [開発 ×] [PJ-A ×]   │
│                                                  │
└──────────────────────────────────────────────────┘
```

### スタイル

- **月選択**: daisyUI の `select select-bordered select-sm`
- **ボタン**: daisyUI の `btn btn-sm btn-outline`
- **間隔**: `gap-2` で適度な間隔
- **フィルタバー**: 既存の `bg-base-200 p-4 rounded-lg`

### アクセシビリティ

- selectに適切なラベル
- ボタンに明確なテキスト
- キーボード操作可能
- スクリーンリーダー対応

## 非機能要件

- **パフォーマンス**: フィルタ変更から結果表示まで100ms以内
- **レスポンシブ**: モバイルでも操作しやすいサイズとレイアウト
- **一貫性**: タグフィルタと同じ操作感

## 備考

- 期間選択（from/to）はStep 4でオプション実装
- まずは月選択とクイックフィルタで十分な UX を提供
- 将来的にカレンダーUIなども検討可能
