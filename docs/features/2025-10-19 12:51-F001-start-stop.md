# 作業記録 F-001 仕様（作業開始・終了）

F-001「作業開始・終了」の仕様。内容入力・タグ付けは含めない。

最終更新: 2025-10-19T12:51:31.325Z

## 目的・ゴール

- 思考を中断せず「すぐ押せる」「すぐ残る」
- 1ユーザーにつき同時に1つだけ進行中の作業を許可

## 用語

- 作業記録（WorkLog）: 作業の1単位（開始/終了）
- 進行中（Active）: endedAt=null のレコード

## UXフロー（最小）

1. Start → 進行中の作業を作成（endedAt=null）
2. Stop → endedAt を現在のサーバー時刻で確定
3. 起動時に進行中状態を取得しUI復元

## 画面要素

- ステータス: 「停止中」/「記録中（経過 00:12:34）」
- トグルボタン: 停止中→[作業開始] / 記録中→[作業終了]
- タイマー: 1秒更新。serverNow と startedAt から算出

## データモデル（参考）

- work_logs(id PK, user_id, started_at timestamptz, ended_at timestamptz null,
  created_at, updated_at)
- 部分ユニーク: UNIQUE(user_id) WHERE ended_at IS NULL

## バリデーション/ルール

- Start: 既に進行中があれば409
- Stop: 進行中が無ければ404
- すべてサーバー時刻（UTC）で保存

## Server actions 設計（SvelteKit）

- load（初期状態取得）
  - 返却: { active?: { id, startedAt, endedAt:null }, serverNow: ISO }
  - 認証必須（未認証時の挙動は方針に従う）

- actions.start
  - 入力: なし
  - 振る舞い:
    - 進行中があれば fail(409, { reason:'ACTIVE_EXISTS', active, serverNow })
    - 無ければサーバー時刻で開始（endedAt=null）を作成
  - 成功: { ok:true, workLog:{ id, startedAt, endedAt:null }, serverNow: ISO }

- actions.stop
  - 入力: なし
  - 振る舞い:
    - 進行中が無ければ fail(404, { reason:'NO_ACTIVE', serverNow })
    - あればサーバー時刻で endedAt を確定
  - 成功: { ok:true, workLog:{ id, startedAt, endedAt }, serverNow: ISO, durationSec:number }

共通

- 認証: locals.user 等から userId を解決。本人レコードのみ操作
- serverNow: 毎回返却しクライアントの経過表示補正に使用
- エラー: 401 未認証, 404/409 は上記、その他は500系

## 画面の挙動

- 初期ロード: load → 状態に応じてUI/タイマー設定
- 開始: 送信中は無効化→start→成功で記録中へ。409時は状態再取得
- 終了: 送信中は無効化→stop→成功で停止中へ。404時は状態再取得
- フォーカス復帰/ドリフト補正: load 相当で再同期

## 実装メモ

- DBはtimestamptz(UTC)。部分ユニークで二重開始を防止
- SvelteKitのform actionsを使用。トースト/エラー表示はUI側で実装

## テスト観点

- Start/Stop基本動作、二重開始→409、進行中なしStop→404
- 認証必須（未ログイン→401）。時刻がサーバー基準で保存されること
