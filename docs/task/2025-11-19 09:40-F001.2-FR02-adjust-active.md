# F-001.2 FR-02: actions.adjustActive 実装

タスク作成日: 2025-11-19

## 目的

FR-02 の要件を満たすため、進行中作業の開始時刻・内容・タグをサーバー側で更新する `actions.adjustActive` を実装し、`?/adjustActive` でフォーム送信できるようにする。UI (FR-01) が送信する値を検証し、ドメインルール（24h制限・previousEndedAt境界等）をサーバーで担保する。

## 前提 / 参照

- 機能仕様: `docs/features/2025-11-18 09:00-F001.2-active-worklog-edit.md`
- UIタスク: `docs/task/2025-11-18 10:30-F001.2-FR01-inline-edit.md`
- 既存Actions: `src/routes/_actions/{start,stop,switch,update}.ts`
- DBユーティリティ: `src/lib/server/db/workLogs.ts`

## スコープ

- 新規 Server Action: `src/routes/_actions/adjustActive.ts`
- `+page.server.ts` の `actions` へ `adjustActive` を追加
- **`WorkLog` ドメインモデルの拡張**（調整バリデーションメソッド追加）
- DBリポジトリ拡張（進行中レコードの更新+タグ更新、previousEndedAt取得）
- 24時間制限・previousEndedAt境界・concurrency検知を含むバリデーション
- テスト（ユニット: WorkLog/Action, 統合: `+page.server.ts`）

## 非スコープ

- UI側のボタン/フォーム実装（FR-01で対応）
- フロント側のハンドラー/トースト実装
- 監査ログの永続化（ログ出力のみ）

## 実装ステップ

### Task 1: WorkLog ドメインモデル拡張

| 項目     | 内容                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| -------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 目的     | `WorkLog` クラスに進行中作業の調整バリデーションメソッドを追加し、ドメインロジックを集約する                                                                                                                                                                                                                                                                                                                                                                     |
| ファイル | `src/models/workLog.ts` + `src/models/workLog.spec.ts`                                                                                                                                                                                                                                                                                                                                                                                                           |
| 仕様     | <ul><li>新規メソッド: `validateAdjustment({ previousEndedAt?: Date, serverNow: Date, newStartedAt: Date, maxAdjustHours?: number }): { valid: boolean; error?: string }`</li><li>バリデーション: <ul><li>`previousEndedAt` が存在する場合 `previousEndedAt < newStartedAt`</li><li>`newStartedAt <= serverNow`</li><li>`serverNow - newStartedAt <= maxAdjustHours時間` (デフォルト24h)</li></ul></li><li>既存の `update()` メソッドをそのまま利用可能</li></ul> |
| TDD      | 1) 先に `workLog.spec.ts` に `validateAdjustment` のテストケースを追加（境界値/24h超過/previousEndedAt違反/未来日時等）<br>2) 実装 -> テストpass<br>3) 既存テストが退化していないことを確認                                                                                                                                                                                                                                                                      |

### Task 2: DBユーティリティ拡張

| 項目     | 内容                                                                                                                                                                                                                                                                                                                                                    |
| -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 目的     | 進行中レコードの更新 + タグ再保存を原子的に行う関数を追加する                                                                                                                                                                                                                                                                                           |
| ファイル | `src/lib/server/db/workLogs.ts`                                                                                                                                                                                                                                                                                                                         |
| 仕様     | <ul><li>`updateActiveWorkLog(userId, workLogId, { startedAt, description, tags })` を追加</li><li>トランザクションで work_logs 更新 + 既存タグ削除 + 再挿入</li><li>進行中のみ更新 (`ended_at IS NULL`)、条件に合わない場合は null を返す</li><li>`getPreviousEndedAt(userId): Promise<Date \| null>` を追加 - 最新の完了作業の終了時刻を取得</li></ul> |
| TDD      | 1) `workLogs.spec.ts` でユニットテスト（既存テストと同じharness利用）<br>2) happy-path（進行中→更新成功）+ ended_at がnullでない場合にnull返却のテスト<br>3) `getPreviousEndedAt` の取得テスト                                                                                                                                                          |

### Task 3: actions.adjustActive 実装

| 項目       | 内容                                                                                                                                                                                                                                                                                                                                                   |
| ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 目的       | フォームからの入力を検証し、DB更新結果を返す Server Action を追加                                                                                                                                                                                                                                                                                      |
| ファイル   | `src/routes/_actions/adjustActive.ts` (新規) + `adjustActive.spec.ts`                                                                                                                                                                                                                                                                                  |
| 入力       | FormData: `workLogId`, `startedAt` (ISO), `description`, `tags` (JSON文字列 or スペース区切り), `clientClockOffsetMs?`                                                                                                                                                                                                                                 |
| 振る舞い   | <ol><li>認証チェック</li><li>Activeレコードと previousEndedAt を取得</li><li>`WorkLog.validateAdjustment()` でバリデーション (Task1)</li><li>既存の `validateDescription`, タグ正規化も実施</li><li>DB更新 (Task2)</li><li>成功レスポンス `{ ok:true, workLog, serverNow }`</li><li>Fail時: `fail(400/404/409, { reason, message, errors })`</li></ol> |
| エラー種別 | `NO_ACTIVE`, `NOT_FOUND`, `VALIDATION_ERROR`, `CONFLICT_STOPPED`, `INTERNAL_ERROR`                                                                                                                                                                                                                                                                     |
| TDD        | 1) 先に spec で happy-path + validation失敗 + previousEndedAt違反 + stop済み(409) を定義<br>2) 実装し、`pnpm test:unit` で確認                                                                                                                                                                                                                         |

### Task 4: +page.server.ts への組み込み

| Step | 内容                                                                                    | テスト                                 |
| ---- | --------------------------------------------------------------------------------------- | -------------------------------------- |
| 4-1  | `handleAdjustActiveAction` を import し、`actions.adjustActive` を追加                  | `+page.server.ts` のユニットテスト更新 |
| 4-2  | load のレスポンスに `previousEndedAt` など UI側が必要な値を含める（仕様が要求する場合） | loadテストで値が含まれること           |
| 4-3  | `actions` エクスポートが `adjustActive` を含むように e2e/contract を更新                | 既存 e2e があれば修正                  |

### Task 5: API/コントラクトドキュメント更新

- `docs/features/2025-11-18 09:00-F001.2-active-worklog-edit.md` でエンドポイントURL (`?/adjustActive`) と over-the-wire format を確定
- README or API docs にサーバーアクション追加を追記

## 受入基準

1. `WorkLog.validateAdjustment()` メソッドが追加され、ユニットテストがフルパスする
2. `src/routes/_actions/adjustActive.ts` のユニットテストがフルパスし、代表的なエラーケースを網羅している
3. `pnpm test:unit` がグリーン
4. `actions.adjustActive` が `+page.server.ts` に登録され、UI側から `?/adjustActive` で呼び出せる
5. バリデーション（previousEndedAt・24h・未来日等）がサーバー側で拒否される
6. DB更新後、レスポンスの `workLog.startedAt`・`description`・`tags`・`updatedAt` が最新状態を返す

## 実行コマンド

```bash
pnpm test:unit
pnpm lint
```

## リスク / メモ

- 24h 制限値は `WorkLog.validateAdjustment()` のデフォルト引数で管理し、将来環境変数 `ACTIVE_ADJUST_MAX_HOURS` などで上書きできるよう設計
- タグの受け渡し形式（JSON/スペース区切り）は UI 実装と同期させる。暫定でスペース区切りを推奨（既存の start/stop と統一）
- オフライン同期との整合性: オフラインでの `adjust` は将来検討。現段階ではオンラインのみ許可し、UIで guard する
- `getPreviousEndedAt` は同ユーザーの最新完了ログを `ended_at` 降順で1件取得する実装
- `WorkLog` ドメインモデルにバリデーションロジックを集約することで、テストが容易になり、将来の保守性も向上
