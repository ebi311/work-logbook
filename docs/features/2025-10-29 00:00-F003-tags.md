# 作業記録 F-003 仕様（タグ付け）

F-003「タグ付け」の仕様。作業内容へのタグ付けとサジェスト機能。

**実装状態**: ✅ 完了  
最終更新: 2025-10-30

## 目的・ゴール

- 作業内容に複数のタグを付けることで、後から絞り込みや集計を容易にする
- プロジェクト名（#PJ-A）、作業種別（#開発、#会議）などで分類できる
- 過去に使用したタグをサジェスト（入力補完）することで、入力の手間を削減し、表記ゆれを防ぐ
- タグの追加・削除を直感的に行える

## 関連要件

- 前提: F-001「作業開始・終了」が実装済み
- 前提: F-002「作業内容の入力」が実装済み
- 関連: F-004「作業記録の編集・削除」（部分実装）
- 関連: F-006「日付・タグでの絞り込み」（未実装・タグでの絞り込みに使用）
- 関連: F-008「レポートの集計」（未実装・タグごとの集計に使用）

## 用語

- **タグ（tag）**: 作業を分類するための短いラベル（例: `開発`, `PJ-A`, `会議`）
- **サジェスト（suggest）**: ユーザーの入力に基づいて候補を提示する機能
- **タグ候補**: 過去に使用したタグの一覧

## ユースケース

### UC-001: 作業開始時にタグを付ける

1. ユーザーが作業内容を入力
2. タグ入力フィールドにタグ名を入力
3. システムは過去に使用したタグをサジェスト表示
4. ユーザーがサジェストから選択、または新しいタグを入力
5. 複数のタグをスペース区切りで入力可能
6. 「作業開始」ボタンをクリック
7. システムは作業記録とタグを保存

### UC-002: 作業終了時にタグを追加・修正

1. 作業中の状態で、タグ入力フィールドが表示されている
2. ユーザーがタグを追加・修正（サジェスト機能が利用可能）
3. 「作業終了」ボタンをクリック
4. システムは作業を終了し、更新されたタグを保存

### UC-003: タグの閲覧

1. 作業一覧画面で過去の作業記録を表示
2. 各作業に付けられたタグがバッジまたはラベルとして表示される
3. タグをクリックすると、そのタグでフィルタリング（F-006実装後）

### UC-004: タグの編集・削除

1. 過去の作業記録を編集モードに変更（F-004）
2. タグ入力フィールドでタグを追加・削除
3. 変更を保存

## データモデル

### DBスキーマ

新規テーブル: `work_log_tags`

```sql
CREATE TABLE work_log_tags (
  id SERIAL PRIMARY KEY,
  work_log_id INTEGER NOT NULL REFERENCES work_logs(id) ON DELETE CASCADE,
  tag VARCHAR(100) NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(work_log_id, tag)
);

CREATE INDEX idx_work_log_tags_work_log_id ON work_log_tags(work_log_id);
CREATE INDEX idx_work_log_tags_tag ON work_log_tags(tag);
CREATE INDEX idx_work_log_tags_user_tag ON work_log_tags(work_log_id, tag);
```

| カラム名    | 型           | NULL許可 | デフォルト | 説明                   |
| ----------- | ------------ | -------- | ---------- | ---------------------- |
| id          | SERIAL       | NO       | auto       | 主キー                 |
| work_log_id | INTEGER      | NO       | -          | 作業記録ID（外部キー） |
| tag         | VARCHAR(100) | NO       | -          | タグ名                 |
| created_at  | TIMESTAMPTZ  | NO       | NOW()      | 作成日時               |

- **制約**: `UNIQUE(work_log_id, tag)` で同じ作業に同じタグを重複して付けられない
- **カスケード削除**: 作業記録が削除されたら、関連するタグも削除

### ドメインモデル拡張

`WorkLog` クラスに `tags` プロパティを追加:

```typescript
export class WorkLog {
	// ... 既存のプロパティ
	readonly tags: string[];
}
```

バリデーション:

- 型: `string[]`（空配列を許可）
- タグ名: 1〜100文字、空白文字は含まない
- タグの数: 最大20個
- タグ名の制約:
  - 英数字、ハイフン、アンダースコア、日本語を許可
  - 先頭・末尾の空白は自動でトリミング
  - 重複は自動で除去

## UI/UX設計

### 画面要素

#### 1. タグ入力フィールド

- **位置**: 作業内容入力フィールドの下
- **タイプ**: テキスト入力フィールド（サジェスト機能付き）
- **プレースホルダー**: "開発 PJ-A 会議"
- **入力形式**: スペース区切りで複数タグを入力
- **サジェスト表示**:
  - 文字を入力すると、過去に使用したタグの候補を表示
  - 候補は使用頻度順（降順）にソート
  - 矢印キー（↑↓）で選択、Enterで確定
  - Escapeでサジェストを閉じる
  - マウスクリックでも選択可能

#### 2. タグバッジ（一覧表示）

- **位置**: 作業一覧の各行、作業内容の下または横
- **スタイル**: 小さなバッジ（daisyUIの`badge`コンポーネント）
- **色**: プライマリカラー、またはタグごとにハッシュ値で色を決定
- **クリック**: タグをクリックすると、そのタグでフィルタリング（F-006実装後）

#### 3. タグ入力中のバッジ表示

- **位置**: タグ入力フィールドの下
- **内容**: 現在入力されているタグをバッジとして表示
- **削除**: 各バッジの `×` ボタンでタグを削除

### インタラクション

#### タグの追加

1. ユーザーが文字を入力
2. サジェストが表示される
3. ユーザーが候補を選択、またはそのまま入力
4. スペースを入力すると、タグが確定され、バッジとして表示

#### タグの削除

1. バッジの `×` ボタンをクリック
2. または、入力フィールドでBackspaceで削除

## Server actions 設計（SvelteKit）

### load（初期状態取得）

拡張内容:

```typescript
type LoadData = {
	active?: {
		id: number;
		startedAt: string;
		endedAt: null;
		description: string;
		tags: string[]; // 追加
	};
	serverNow: string;
	tagSuggestions: Array<{ tag: string; count: number }>; // 追加
};
```

- `tags`: 進行中の作業に付けられているタグの配列
- `tagSuggestions`: ユーザーが過去に使用したタグと使用回数（使用頻度順）

### actions.start

拡張内容:

```typescript
type StartInput = {
	description?: string;
	tags?: string[]; // 追加
};

type StartSuccess = {
	ok: true;
	workLog: {
		id: number;
		startedAt: string;
		endedAt: null;
		description: string;
		tags: string[]; // 追加
	};
	serverNow: string;
};
```

振る舞い:

- `tags` が入力されている場合、バリデーション後に保存
- タグのバリデーション:
  - 配列の長さ: 最大20個
  - 各タグ: 1〜100文字
  - 空白をトリミング
  - 重複を除去
  - 空文字列は除外

### actions.stop

拡張内容:

```typescript
type StopInput = {
	description?: string;
	tags?: string[]; // 追加
};

type StopSuccess = {
	ok: true;
	workLog: {
		id: number;
		startedAt: string;
		endedAt: string;
		description: string;
		tags: string[]; // 追加
	};
	serverNow: string;
	durationSec: number;
};
```

振る舞い:

- 進行中の作業を終了し、`description` と `tags` を更新
- タグのバリデーションは `start` と同様

### 新規アクション: actions.suggestTags

```typescript
type SuggestTagsInput = {
	query?: string; // 部分一致検索用
};

type SuggestTagsSuccess = {
	ok: true;
	suggestions: Array<{ tag: string; count: number }>;
};
```

振る舞い:

- ユーザーが過去に使用したタグを取得
- `query` が指定されている場合、部分一致でフィルタリング
- 使用頻度順（降順）にソート
- 最大20件を返却

## 実装方針

### フロントエンド

1. **タグ入力コンポーネント**:
   - `TagInput.svelte` を作成
   - サジェスト機能を実装（ドロップダウン）
   - バッジ表示機能

2. **サジェストAPI呼び出し**:
   - 文字入力時にデバウンス（300ms）後にAPIを呼び出し
   - `actions.suggestTags` を使用

3. **タグバッジコンポーネント**:
   - `TagBadge.svelte` を作成
   - daisyUIの `badge` を使用
   - クリックイベント（F-006実装後に有効化）

### バックエンド

1. **ドメインモデル**:
   - `WorkLog` クラスに `tags` プロパティを追加
   - バリデーションロジックを実装

2. **リポジトリ**:
   - タグの保存・取得・削除機能を実装
   - トランザクション管理（作業記録とタグを同時に保存）

3. **Server actions**:
   - `start`, `stop` アクションに `tags` パラメータを追加
   - `suggestTags` アクションを実装

## テスト観点

### ドメインモデル

- タグの正規化（トリミング、重複除去）
- タグ数の上限（20個）
- タグ名の長さ制限（1〜100文字）
- 空文字列の除外

### リポジトリ

- タグの保存・取得・削除
- 同じ作業に同じタグを重複して保存できない
- 作業記録削除時にタグもカスケード削除される

### Server actions

- `start` / `stop` でタグを正しく保存できる
- バリデーションエラー時のエラーハンドリング
- `suggestTags` で使用頻度順にタグを取得できる
- 部分一致検索が機能する

### UI

- タグ入力フィールドでサジェストが表示される
- サジェストから選択してタグを追加できる
- バッジの `×` ボタンでタグを削除できる
- 作業一覧でタグがバッジとして表示される

## セキュリティ

- タグには機密情報を含めないことをユーザーに推奨（ドキュメント記載）
- タグのサニタイゼーション（SQLインジェクション対策はORMが対応）
- 他ユーザーのタグを取得できないこと（認証チェック）

## パフォーマンス

- タグのサジェストは頻繁に呼ばれるため、インデックスを適切に設定
- サジェストのキャッシュ（Redis等）は将来的に検討
- タグの数が多い場合の表示最適化（最初の数個のみ表示、「+N more」など）

## 将来の拡張

- タグの色をユーザーがカスタマイズできる機能
- タグの階層化（例: `#PJ-A/機能開発`）
- タグの統合・リネーム機能
- タグクラウド表示
- よく使うタグをピン留め

---

## 実装完了情報

**実装日**: 2025-10-30  
**実装者**: GitHub Copilot

### 実装内容

#### 1. DBスキーマ

- `work_log_tags` テーブルを作成
- マイグレーション: `drizzle/0002_great_lionheart.sql`
- インデックス: `work_log_id`, `tag`, `(work_log_id, tag)` の複合ユニーク制約

#### 2. ドメインモデル

- `WorkLog` クラスに `tags: string[]` プロパティを追加
- バリデーション:
  - タグ数: 最大20個
  - タグ名: 1〜100文字
  - 自動トリミング、重複除去、空文字列除外

#### 3. リポジトリ層

**ファイル**: `src/lib/server/db/workLogs.ts`

実装済み関数:

- `saveWorkLogTags(workLogId: string, tags: string[]): Promise<void>`
- `getWorkLogTags(workLogId: string): Promise<string[]>`
- `getUserTagSuggestions(userId: string, query: string, limit: number): Promise<Array<{ tag: string; count: number }>>`
- `getWorkLogWithTags(id: string): Promise<WorkLog | null>`

#### 4. Server Actions

**ファイル**: `src/routes/_actions/start.ts`, `stop.ts`, `update.ts`

- `start`: タグ付きで作業を開始
- `stop`: タグ付きで作業を終了
- `update`: 作業記録のタグを編集
- `load`: タグサジェスト情報を取得（`tagSuggestions`）

#### 5. UIコンポーネント

##### TagInput コンポーネント

**ファイル**: `src/routes/_components/TagInput/TagInput.svelte`

機能:

- スペース区切りでの複数タグ入力
- オートコンプリート機能（サジェスト表示）
- 使用頻度順にソート表示
- キーボード操作対応（↑↓、Enter、Escape）
- IME入力対応（日本語入力も問題なし）
- リアクティブな入力バリデーション

##### TagBadge コンポーネント

**ファイル**: `src/routes/_components/TagBadge/TagBadge.svelte`

機能:

- タグをバッジ形式で表示
- daisyUIのバッジコンポーネント使用
- 削除可能/読み取り専用モード
- ハッシュベースの色分け（プライマリカラー）

#### 6. 統合

- メインページ (`+page.svelte`) にタグ入力フィールドを統合
- 作業一覧 (`WorkLogList.svelte`) にタグバッジ表示
- 編集モーダル (`WorkLogEditModal.svelte`) にタグ編集機能

### テスト

- ✅ ドメインモデルのUT: 50件
- ✅ リポジトリ層のUT: 10件
- ✅ Server ActionsのUT: 23件
- ✅ UIコンポーネントのUT: 18件
- **合計**: 391件のテスト全てパス

### 動作確認

- ✅ 作業開始時のタグ入力
- ✅ 作業終了時のタグ更新
- ✅ タグサジェスト機能
- ✅ タグの編集・削除
- ✅ 一覧でのタグ表示
- ✅ IME入力（日本語）の正常動作

### 既知の制限事項

- タグでのフィルタリング機能は未実装（F-006で実装予定）
- タグクラウド表示は未実装（将来拡張）
- タグの色カスタマイズは未実装（将来拡張）
