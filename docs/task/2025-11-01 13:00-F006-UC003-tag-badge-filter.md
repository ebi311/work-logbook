# F-006 UC-003: 一覧のタグバッジから絞り込む タスク

作成日: 2025-11-01T13:00:00Z  
関連機能: [F-006: タグでの絞り込み](../features/2025-11-01%2000:00-F006-tag-filter.md)  
前提タスク: 
- [F-006 UC-001](./2025-11-01%2000:00-F006-UC001-single-tag-filter.md) ✅
- [F-006 UC-002](./2025-11-01%2012:00-F006-UC002-multiple-tag-filter.md) ✅

## 概要

作業一覧に表示されているタグバッジをクリックすることで、そのタグで絞り込める機能を実装する。

### 現状

- ✅ タグフィルタ機能（UC-001, UC-002）実装済み
- ✅ WorkLogDetailDialog（詳細ダイアログ）内でタグ表示
- ❌ WorkLogList（一覧）にはタグが表示されていない

### 実装範囲

UC-003では以下を実装:
- WorkLogListコンポーネントにタグバッジ表示を追加
- タグバッジをクリック可能にする
- クリック時に該当タグをフィルタに追加（既存のフィルタに追加してAND検索）
- スクロール位置を保持

## ゴール

- 作業一覧の各アイテムにタグバッジが表示される
- タグバッジをクリックすると、そのタグでフィルタリングされる
- 既にフィルタリング中の場合、タグが追加される（AND条件）
- 同じタグを再度クリックした場合は何もしない（重複防止）
- スクロール位置が保持される

## 実装ステップ

### Step 1: WorkLogListコンポーネントへのタグ表示追加

**目的**: 作業一覧の各アイテムにタグバッジを表示する

**実装箇所**: `src/routes/_components/WorkLogList/WorkLogList.svelte`

**実装内容**:

1. **TagBadgeコンポーネントのインポート**
   ```svelte
   import TagBadge from '../TagBadge/TagBadge.svelte';
   ```

2. **タグバッジの表示エリア追加**
   - 作業内容の下に配置
   - `flex flex-wrap gap-1` でタグを横並び表示
   - タグがない場合は非表示

3. **Props拡張（必要に応じて）**
   - `ontagclick?: (tag: string) => void` ハンドラを追加

**実装例**:
```svelte
<!-- 2行目: 作業内容とタグ -->
<div class="col-span-3 mt-2 space-y-2 text-sm">
  {#if item.description}
    <div class="line-clamp-2">{item.description}</div>
  {:else}
    <span class="text-base-content/40">—</span>
  {/if}
  
  <!-- タグ -->
  {#if item.tags && item.tags.length > 0}
    <div class="flex flex-wrap gap-1">
      {#each item.tags as tag}
        <TagBadge 
          {tag} 
          clickable={true}
          onclick={(e) => {
            e.stopPropagation(); // 行クリックを防ぐ
            ontagclick?.(tag);
          }}
        />
      {/each}
    </div>
  {/if}
</div>
```

**合格基準**:
- 作業一覧の各アイテムにタグバッジが表示される
- タグがない場合は非表示
- 既存のテストが成功
- レイアウトが崩れていない

### Step 2: TagBadgeコンポーネントのクリック対応確認

**目的**: TagBadgeコンポーネントがクリック可能か確認・拡張

**実装箇所**: `src/routes/_components/TagBadge/TagBadge.svelte`

**確認項目**:
1. `clickable` prop があるか
2. `onclick` ハンドラがあるか
3. クリック時の視覚フィードバック（hover効果など）

**実装内容**（必要に応じて）:

```svelte
<script lang="ts">
  export let tag: string;
  export let onRemove: (() => void) | undefined = undefined;
  export let clickable = false; // 追加
  
  $: colorClass = getColorClass(tag);
  $: cursorClass = clickable ? 'cursor-pointer hover:opacity-80' : '';
</script>

<div 
  class="badge {colorClass} {cursorClass} gap-1"
  role={clickable ? 'button' : undefined}
  tabindex={clickable ? 0 : undefined}
>
  <span>{tag}</span>
  {#if onRemove}
    <button type="button" ...>×</button>
  {/if}
</div>
```

**合格基準**:
- `clickable` prop でクリック可能/不可を制御できる
- クリック可能な場合、カーソルがポインターになる
- hover時に視覚フィードバックがある

### Step 3: +page.svelteのタグクリックハンドラ追加

**目的**: タグクリック時にフィルタに追加する処理を実装

**実装箇所**: `src/routes/+page.svelte`

**実装内容**:

```typescript
// F-006 UC-003: タグバッジクリックハンドラー
const handleTagClick = (tag: string) => {
  // 既に選択されている場合はスキップ
  if (filterTags.includes(tag)) {
    return;
  }
  
  // 新しいタグを追加
  const newTags = [...filterTags, tag];
  handleFilterTagsChange(newTags);
};
```

**WorkLogHistoryコンポーネントへの伝播**:
```svelte
<WorkLogHistory
  {listDataPromise}
  {filterTags}
  tagSuggestions={data.tagSuggestions}
  serverNow={currentServerNow}
  onFilterTagsChange={handleFilterTagsChange}
  onTagClick={handleTagClick}  <!-- 追加 -->
  onEdit={openEditModal}
  onDelete={handleDeleteClick}
/>
```

**合格基準**:
- タグクリック時に該当タグがフィルタに追加される
- 重複タグは追加されない
- URLが更新される
- スクロール位置が保持される

### Step 4: WorkLogHistoryコンポーネントの拡張

**目的**: WorkLogListにタグクリックハンドラを渡す

**実装箇所**: `src/routes/_components/WorkLogHistory/WorkLogHistory.svelte`

**実装内容**:

1. **Props拡張**:
```typescript
type Props = {
  // ... 既存のProps
  onTagClick: (tag: string) => void; // 追加
};

let {
  listDataPromise,
  filterTags,
  tagSuggestions,
  serverNow,
  onFilterTagsChange,
  onTagClick, // 追加
  onEdit,
  onDelete,
}: Props = $props();
```

2. **WorkLogListへの伝播**:
```svelte
<WorkLogList
  items={listData.items}
  {serverNow}
  onedit={onEdit}
  ondelete={onDelete}
  ontagclick={onTagClick}  <!-- 追加 -->
/>
```

**合格基準**:
- ハンドラが正しく伝播される
- 型エラーがない

### Step 5: テストの追加

**目的**: タグバッジクリックの動作を確認

**実装箇所**: 
- `src/routes/page.svelte.spec.ts`
- `src/routes/_components/WorkLogList/WorkLogList.svelte.spec.ts`

**テストケース**:

#### +page.svelte のテスト

```typescript
describe('F-006 UC-003: 一覧のタグバッジから絞り込む', () => {
  it('タグバッジをクリックすると、そのタグでフィルタリングされる', async () => {
    // Given: 作業一覧にタグ付きアイテムがある
    const listData = Promise.resolve({
      items: [{
        id: '1',
        startedAt: '2025-10-25T09:00:00.000Z',
        endedAt: '2025-10-25T10:30:00.000Z',
        description: 'テスト作業',
        tags: ['開発', 'PJ-A'],
      }],
      page: 1,
      size: 10,
      hasNext: false,
      monthlyTotalSec: 5400,
    });

    render(Page, {
      props: {
        data: createDefaultData({ listData }),
      },
    });

    await waitFor(() => {
      expect(screen.getByText('開発')).toBeInTheDocument();
    });

    // When: タグバッジをクリック
    const tagBadge = screen.getByText('開発');
    await fireEvent.click(tagBadge);

    // Then: handleTagClick が呼ばれる
    // （実際にはhandleFilterTagsChangeが呼ばれてURLが更新される）
  });

  it('既に選択されているタグは追加されない', () => {
    // Given: 既にフィルタリング中
    // When: 同じタグをクリック
    // Then: 何も変わらない（重複チェック）
  });

  it('タグクリック時、既存のフィルタに追加される（AND条件）', () => {
    // Given: '開発' でフィルタリング中
    // When: 'PJ-A' タグをクリック
    // Then: '開発,PJ-A' でフィルタリングされる
  });
});
```

#### WorkLogList のテスト

```typescript
describe('WorkLogList - タグバッジクリック', () => {
  it('タグバッジが表示される', () => {
    render(WorkLogList, {
      items: [{
        id: '1',
        startedAt: '2025-10-25T09:00:00.000Z',
        endedAt: '2025-10-25T10:30:00.000Z',
        description: 'テスト',
        tags: ['開発', 'PJ-A'],
      }],
      serverNow: '2025-10-25T12:00:00.000Z',
    });

    expect(screen.getByText('開発')).toBeInTheDocument();
    expect(screen.getByText('PJ-A')).toBeInTheDocument();
  });

  it('タグバッジをクリックすると、ontagclickが呼ばれる', async () => {
    const mockOnTagClick = vi.fn();
    
    render(WorkLogList, {
      items: [{
        id: '1',
        startedAt: '2025-10-25T09:00:00.000Z',
        endedAt: '2025-10-25T10:30:00.000Z',
        description: 'テスト',
        tags: ['開発'],
      }],
      serverNow: '2025-10-25T12:00:00.000Z',
      ontagclick: mockOnTagClick,
    });

    const tagBadge = screen.getByText('開発');
    await fireEvent.click(tagBadge);

    expect(mockOnTagClick).toHaveBeenCalledWith('開発');
  });

  it('タグクリック時、行クリックイベントは発火しない', async () => {
    // Given: ontagclickとonclickハンドラ
    // When: タグをクリック
    // Then: ontagclickのみ呼ばれ、行クリックは呼ばれない（stopPropagation）
  });
});
```

**合格基準**:
- 全テストケースが成功
- 既存のテストも引き続き成功

### Step 6: 動作確認とコミット

**確認項目**:
1. 作業一覧にタグバッジが表示される
2. タグバッジをクリックすると絞り込まれる
3. 既存のフィルタに追加される（AND条件）
4. 重複タグは追加されない
5. スクロール位置が保持される
6. 行クリックとタグクリックが混同しない

**コミット**:
```bash
git add -A
git commit -m "F-006 UC-003: 一覧のタグバッジクリックで絞り込み機能を実装

- WorkLogListにタグバッジ表示を追加
- TagBadgeコンポーネントにclickable propを追加
- +page.svelteにhandleTagClickハンドラを実装
  - 既存のフィルタに追加（AND条件）
  - 重複チェック
  - スクロール位置保持
- WorkLogHistoryコンポーネントでハンドラを伝播
- テストケース追加（6件）
- 全テスト成功
"
```

## 技術仕様

### イベント伝播

```
WorkLogList (タグクリック)
  → WorkLogHistory (ontagclick prop)
    → +page.svelte (handleTagClick)
      → handleFilterTagsChange
        → goto() でURL更新
```

### 重複チェックロジック

```typescript
if (filterTags.includes(tag)) {
  return; // 既に選択済み
}
```

### スクロール位置保持

既存の `handleFilterTagsChange` を使用するため、自動的に `noScroll: true, keepFocus: true` が適用される。

## UI/UX仕様

### タグバッジの配置

- 作業内容の下に配置
- 横並び（flex-wrap）
- 小さめのバッジ（badge-sm相当）
- タグがない場合は非表示

### クリック時の挙動

1. タグバッジにカーソルを合わせると `cursor-pointer`
2. hover時に `opacity-80` などで視覚フィードバック
3. クリックすると即座にフィルタリング実行
4. スクロール位置は保持

### 行クリックとの競合回避

- タグクリック時は `e.stopPropagation()` で行クリックを防ぐ
- 作業詳細ダイアログは開かない

## 非機能要件

- **パフォーマンス**: タグクリックからフィルタリングまで100ms以内
- **アクセシビリティ**: タグバッジにもキーボード操作対応（Enter/Space）
- **レスポンシブ**: モバイルでもタグバッジが適切に表示される

## 備考

- タグバッジのクリックは「追加」のみで、「削除」はフィルタバーの×ボタンで行う（UC-004）
- WorkLogDetailDialog内のタグバッジは引き続きクリック不可（情報表示のみ）
