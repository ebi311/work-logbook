# F-009: 日別合計時間表示機能 仕様

最終更新: 2025-11-30T00:00:00Z

## 目的・ゴール

指定月の日別の合計作業時間を一覧で確認できるようにすることで、日々の作業量の把握と分析を容易にする。

### ユーザーストーリー

- **As a** フリーランスITエンジニア
- **I want to** 指定した月の各日の合計作業時間を一覧で確認したい
- **So that** 日々の作業量のバランスを把握し、請求書作成時の参考資料として活用できる

## 背景・要求

現在、作業一覧画面では以下が表示されている:

- 個別の作業記録（開始・終了時刻、作業時間）
- 月次合計時間
- 日次合計時間（選択日のみ）

しかし、「指定月の各日の合計時間」を俯瞰的に確認する手段がないため、以下の課題がある:

- 日ごとの作業量のバラツキが把握しにくい
- どの日に何時間働いたかを確認するには、日付フィルタを一日ずつ変更する必要がある
- 月全体の作業パターンが視覚的に理解しにくい

## スコープ（MVP）

### 含むもの

1. **タブ切り替えUI**
   - 「作業一覧」タブと「日別集計」タブを切り替え可能
   - タブの状態はURLに反映（`?view=list` or `?view=daily`、デフォルトは `list`）
   - フィルタ（月選択、タグ）は両タブで共有

2. **日別集計表示**
   - 指定月の各日の合計作業時間を表形式で表示
   - 表示カラム:
     - 日付（YYYY-MM-DD、曜日付き）
     - 合計作業時間（HH:mm形式）
     - 作業件数（その日の作業記録数）
   - 並び順: 日付降順（最新の日が上）
   - 作業時間0の日は表示しない（実際に作業した日のみ）
   - 月次合計も表示（画面上部または下部）

3. **インタラクション**
   - 各日の行をクリックすると、その日の作業一覧にドリルダウン
   - 作業一覧タブに切り替わり、該当日でフィルタされた状態になる

### 含まないもの（将来検討）

- グラフ表示（棒グラフ、折れ線グラフなど）
- 週別集計
- 作業時間0の日の表示オプション
- カレンダー形式の表示
- タグ別の日次集計
- CSV/PDFエクスポート（日別サマリー版）

## 画面設計

### レイアウト構成

```
┌─────────────────────────────────────────┐
│  作業記録                                │
│  ┌─────────────────────────────────┐   │
│  │ [開始/終了ボタン等の既存UI]       │   │
│  └─────────────────────────────────┘   │
├─────────────────────────────────────────┤
│  ┌─────────┬──────────┐                │
│  │ 作業一覧 │ 日別集計  │  ← タブ       │
│  └─────────┴──────────┘                │
│                                          │
│  ┌─ フィルタバー（共通） ─────────┐   │
│  │ 月選択: [2025-11] ▼              │   │
│  │ タグ: [#開発] [#会議] + 追加     │   │
│  └────────────────────────────────┘   │
│                                          │
│  【タブ: 作業一覧】の場合               │
│  ┌────────────────────────────────┐   │
│  │ 日付       開始  終了  時間  ...  │   │
│  │ 2025-11-30 09:00 12:00 3:00  ...  │   │
│  │ 2025-11-30 13:00 18:00 5:00  ...  │   │
│  │ ...                                │   │
│  └────────────────────────────────┘   │
│                                          │
│  【タブ: 日別集計】の場合               │
│  ┌────────────────────────────────┐   │
│  │ 月次合計: 160時間30分              │   │
│  └────────────────────────────────┘   │
│  ┌────────────────────────────────┐   │
│  │ 日付             合計時間  件数   │   │
│  │ 2025-11-30(土)   8:00      2     │ ← クリック可
│  │ 2025-11-29(金)   7:30      3     │   │
│  │ 2025-11-28(木)   6:00      2     │   │
│  │ ...                               │   │
│  └────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### UIコンポーネント構成

```
+page.svelte
  ├─ タブ切り替えUI (新規)
  │   ├─ 作業一覧タブ
  │   └─ 日別集計タブ
  ├─ フィルタバー (既存、共通)
  ├─ WorkLogListView (既存 WorkLogHistory をリネーム)
  │   ├─ MonthlyTotal (既存、月次合計)
  │   ├─ DailyTotal (既存、日次合計)
  │   ├─ WorkLogList (既存、作業一覧)
  │   └─ Pagination (既存)
  └─ DailySummaryView (新規、日別集計表示用)
      ├─ MonthlyTotal (既存、月次合計)
      └─ DailySummaryTable (新規、日別集計テーブル)
```

### タブ切り替え仕様

- **実装方法**: daisyUI の Tabs コンポーネントを使用
- **URL管理**: `?view=list` または `?view=daily` でタブ状態を管理
  - デフォルト（パラメータなし）: `list`
  - 他のクエリパラメータ（`month`, `tags`, `page`）と共存
- **ナビゲーション**: タブクリック時は `goto()` で URL を更新し、`replaceState: false` で履歴に追加
- **初期表示**: URL の `view` パラメータに基づいてアクティブタブを決定

## データモデル

### 日別集計データの項目 (DailySummaryItem)

| フィールド名 | 型     | 説明                   | 例                          |
| ------------ | ------ | ---------------------- | --------------------------- |
| `date`       | 文字列 | 日付（YYYY-MM-DD形式） | `"2025-11-30"`              |
| `dayOfWeek`  | 文字列 | 曜日（日本語）         | `"月"`, `"火"`, `"水"` など |
| `totalSec`   | 数値   | その日の合計作業秒数   | `28800` (8時間)             |
| `count`      | 数値   | その日の作業記録件数   | `3`                         |

### 日別集計のレスポンスデータ (DailySummaryData)

| フィールド名      | 型     | 説明                                       | 例                 |
| ----------------- | ------ | ------------------------------------------ | ------------------ |
| `items`           | 配列   | 日別集計データの配列（DailySummaryItem[]） | 下記参照           |
| `monthlyTotalSec` | 数値   | 指定月の合計作業秒数                       | `576000` (160時間) |
| `month`           | 文字列 | 対象月（YYYY-MM形式）                      | `"2025-11"`        |

### DB クエリ設計

#### 集計対象データ

- **テーブル**: `work_logs`
- **集計単位**: 日付（UTCタイムゾーン基準）
- **集計対象**: 終了済みの作業記録のみ（`ended_at IS NOT NULL`）

#### 集計内容

| 集計項目     | 説明                   | 計算方法                                           |
| ------------ | ---------------------- | -------------------------------------------------- |
| 日付         | 作業の開始日（UTC）    | `DATE(started_at AT TIME ZONE 'UTC')`              |
| 合計作業秒数 | その日の作業時間の合計 | `SUM(EXTRACT(EPOCH FROM (ended_at - started_at)))` |
| 作業件数     | その日の作業記録数     | `COUNT(*)`                                         |

#### フィルタ条件

| 条件         | 説明                         | 適用方法                                |
| ------------ | ---------------------------- | --------------------------------------- |
| ユーザーID   | 本人の作業のみ               | `user_id = ?`                           |
| 対象月       | 指定月の月初〜翌月初未満     | `started_at >= ? AND started_at < ?`    |
| 終了済み     | 進行中の作業を除外           | `ended_at IS NOT NULL`                  |
| タグフィルタ | 指定タグのいずれかを含む作業 | `tags && ?`（配列の積集合、オプション） |

#### グルーピングとソート

- **グルーピング**: 日付（UTC基準）
- **ソート順**: 日付降順（最新の日が上）

#### 注意点

- タイムゾーンは UTC で統一（サーバー側で処理）
- 進行中の作業（`ended_at` が NULL）は集計に含めない
- タグフィルタ適用時は、指定タグのいずれかを持つ作業のみを集計（OR条件）
- 作業時間が0秒の日も、作業記録があれば表示される

## API 設計（SvelteKit）

### Server Load Function の変更（契約をデータモデルに整合）

**対象ファイル**: `src/routes/+page.server.ts`

#### 入力パラメータ（URL/環境）

| パラメータ | 取得元           | 説明                            | デフォルト値 |
| ---------- | ---------------- | ------------------------------- | ------------ |
| `view`     | URLクエリ        | 表示ビュー（`list` or `daily`） | `list`       |
| `month`    | URLクエリ        | 対象月（YYYY-MM）               | 現在の月     |
| `tags`     | URLクエリ        | タグフィルタ（カンマ区切り）    | なし         |
| `userId`   | `locals.user.id` | ログインユーザーID              | -            |

#### 処理フロー

1. URLから `view` パラメータを取得
2. `view` が `daily` の場合:
   - 日別集計データ（DailySummaryData）を取得
   - 作業一覧データは返却しない（フィールド自体を未含にする）
3. `view` が `list` または未指定の場合:
   - 既存の作業一覧データ取得処理を実行

#### レスポンス契約（ビュー別）

**日別集計ビュー（`view=daily`）の場合**:

| フィールド名       | 型                        | 必須 | 説明                         |
| ------------------ | ------------------------- | ---- | ---------------------------- |
| `active`           | オブジェクトまたはnull    | ○    | 進行中の作業                 |
| `serverNow`        | 文字列（ISO形式）         | ○    | サーバー時刻                 |
| `tagSuggestions`   | 配列                      | ○    | タグサジェスト               |
| `previousEndedAt`  | 文字列またはnull          | ○    | 前回の作業終了時刻           |
| `dailySummaryData` | Promise<DailySummaryData> | ○    | 日別集計データ（モデル準拠） |
| `view`             | `'daily'`                 | ○    | ビュー種別                   |

**作業一覧ビュー（`view=list`）の場合**:

| フィールド名      | 型                     | 必須 | 説明                       |
| ----------------- | ---------------------- | ---- | -------------------------- |
| `active`          | オブジェクトまたはnull | ○    | 進行中の作業               |
| `serverNow`       | 文字列（ISO形式）      | ○    | サーバー時刻               |
| `tagSuggestions`  | 配列                   | ○    | タグサジェスト             |
| `previousEndedAt` | 文字列またはnull       | ○    | 前回の作業終了時刻         |
| `listData`        | Promise<ListData>      | ○    | 作業一覧データ（既存仕様） |
| `view`            | `'list'`               | ○    | ビュー種別                 |

注: `view=daily` のときは `listData` を返却しない（フィールド未含）。`view=list` のときは `dailySummaryData` を返却しない。

### Repository 層の追加

**対象ファイル**: `src/lib/server/repositories/workLogRepository.ts`

#### 新規関数: `getDailySummary`

**目的**: 指定月の日別集計データを取得

**入力パラメータ**:

| パラメータ名 | 型         | 必須 | 説明              | 例                 |
| ------------ | ---------- | ---- | ----------------- | ------------------ |
| `userId`     | 文字列     | ○    | ユーザーID        | `"user_123"`       |
| `month`      | 文字列     | ○    | 対象月（YYYY-MM） | `"2025-11"`        |
| `tags`       | 文字列配列 | ×    | タグフィルタ      | `["開発", "会議"]` |

**処理内容**:

1. **月の範囲計算**
   - 月初: `{month}-01T00:00:00Z`
   - 翌月初: 月初に1ヶ月加算

2. **DBクエリ実行**
   - 上記「DBクエリ設計」セクションの仕様に従う
   - タグフィルタがある場合のみ条件に追加

3. **月次合計計算**
   - 全日の `total_sec` を合算

4. **曜日変換**
   - 各日付の曜日を日本語で取得
   - 配列: `['日', '月', '火', '水', '木', '金', '土']`

**戻り値**: `DailySummaryData` 型のオブジェクト（上記「データモデル」参照）

#### エラー契約（Repository）

| 例外                | 条件                        | ハンドリング方針          |
| ------------------- | --------------------------- | ------------------------- |
| `InvalidMonthError` | `month` が `YYYY-MM` でない | Server Load で 400 に変換 |
| `UnauthorizedError` | `userId` が未設定           | Server Load で 401 に変換 |
| DB例外              | 接続・クエリ失敗            | 500 Internal Server Error |

## UI コンポーネント設計

### 1. +page.svelte の変更

**対象ファイル**: `src/routes/+page.svelte`

#### 追加する UI 要素

1. **タブUI**（新規追加）
   - daisyUIの `tabs tabs-boxed` クラスを使用
   - タブ項目:
     - 「作業一覧」（`currentView === 'list'` でアクティブ）
     - 「日別集計」（`currentView === 'daily'` でアクティブ）
   - クリック時の動作: `handleViewChange` を呼び出してURLを更新

2. **フィルタバー**（既存を共通化）
   - 既存のフィルタUIを両ビューで共有
   - 月選択、タグフィルタを含む

3. **ビュー切り替え**
   - `currentView === 'list'` の場合: `WorkLogListView` を表示
   - `currentView === 'daily'` の場合: `DailySummaryView` を表示

#### 追加する State

| State名       | 型                  | 説明         | 初期値                          |
| ------------- | ------------------- | ------------ | ------------------------------- |
| `currentView` | `'list' \| 'daily'` | 現在のビュー | URLの `view` パラメータから取得 |

#### 追加するイベントハンドラー

| ハンドラー名       | 引数                      | 説明         | 動作                                                  |
| ------------------ | ------------------------- | ------------ | ----------------------------------------------------- |
| `handleViewChange` | `view: 'list' \| 'daily'` | ビュー変更   | URLの `view` パラメータを更新して `goto()` を呼び出し |
| `handleDateClick`  | `date: string`            | 日付クリック | ビューを `list` に切り替え、日付フィルタを適用        |

### 2. WorkLogListView コンポーネント（既存 WorkLogHistory をリネーム）

**対象ファイル**: `src/routes/_components/WorkLogListView/WorkLogListView.svelte`（既存の `WorkLogHistory` からリネーム）

#### 変更内容

- コンポーネント名を `WorkLogHistory` から `WorkLogListView` に変更
- タブUIとフィルタバーを削除（親コンポーネントに移動）
- 作業一覧表示のみに専念

#### Props（API仕様に合わせて更新）

| Prop名            | 型                              | 必須 | 説明                         |
| ----------------- | ------------------------------- | ---- | ---------------------------- |
| `listDataPromise` | Promise<ListData>               | ○    | 一覧データのPromise          |
| `serverNow`       | 文字列                          | ○    | サーバー時刻                 |
| `filterTags`      | 配列<文字列>                    | ○    | 現在のタグフィルタ           |
| `currentMonth`    | 文字列                          | ×    | 現在の月（YYYY-MM）          |
| `currentDate`     | 文字列                          | ×    | 現在の日（YYYY-MM-DD）       |
| `onTagClick`      | 関数 `(tag: string) => void`    | ○    | タグバッジクリックハンドラー |
| `onEdit`          | 関数 `(item: ListItem) => void` | ○    | 編集ハンドラー               |
| `onDelete`        | 関数 `(item: ListItem) => void` | ○    | 削除ハンドラー               |

### 3. DailySummaryView コンポーネント（新規作成）

**対象ファイル**: `src/routes/_components/DailySummaryView/DailySummaryView.svelte`

#### Props（API仕様に合わせて更新）

| Prop名             | 型                            | 必須 | 説明                         |
| ------------------ | ----------------------------- | ---- | ---------------------------- |
| `dailySummaryData` | Promise<DailySummaryData>     | ○    | 日別集計データのPromise      |
| `onDateClick`      | 関数 `(date: string) => void` | ○    | 日付クリック時のコールバック |

#### 表示要素

1. **月次合計セクション**
   - 既存の `MonthlyTotal` コンポーネントを再利用
   - `totalSec` に `summary.monthlyTotalSec`（await結果）を渡す
2. **日別集計テーブル**
   - daisyUIの `table table-zebra` クラスを使用
   - カラム構成:
     - 日付: YYYY-MM-DD (曜日) 形式
     - 合計時間: HH:mm 形式
     - 件数: 数値
   - 各行の動作:
     - カーソルをポインターに変更
     - ホバー時に背景色変更（`hover:bg-base-200`）
     - クリック時に `onDateClick` コールバックを実行

   ### 4. ビュー切替と Props 受け渡しフローチャート（+page.svelte）

   ```
   ┌────────────────────────────────────────────────────────────┐
   │               URL クエリ（view, month, tags, date）        │
   └────────────────────────────────────────────────────────────┘
         │ 読み取り
         ▼
   ┌────────────────────────────────────────────────────────────┐
   │                 +page.svelte（親コンポーネント）           │
   │  - State: currentView, filterTags, currentMonth, currentDate│
   │  - Handlers: handleViewChange, handleFilterTagsChange,      │
   │              handleDateFilterChange, handleDateClick        │
   └────────────────────────────────────────────────────────────┘
      │                              │
      │ view === 'list'              │ view === 'daily'
      ▼                              ▼
   ┌──────────────────────────────┐   ┌──────────────────────────────┐
   │  WorkLogListView             │   │  DailySummaryView            │
   │  Props:                      │   │  Props:                      │
   │   - listDataPromise (必須)   │   │   - dailySummaryData (必須)  │
   │   - serverNow (必須)         │   │   - onDateClick (必須)       │
   │   - filterTags (必須)        │   └──────────────────────────────┘
   │   - currentMonth (任意)      │            ▲ onDateClick(date)
   │   - currentDate (任意)       │            │
   │   - onTagClick (必須)        │            │ ドリルダウン要求
   │   - onEdit/onDelete (必須)    │            │
   └──────────────────────────────┘            ▼
                   ┌──────────────────────────────────┐
                   │ +page.svelte:                    │
                   │  handleViewChange('list')        │
                   │  handleDateFilterChange({date})  │
                   └──────────────────────────────────┘

   ＜ナビゲーション＞
   - タブクリック: handleViewChange → URL(view) 更新 → 再レンダリング
   - フィルタ変更: handleFilterTagsChange / handleDateFilterChange → URL更新
   - 行クリック: onDateClick → 一覧ビューへ切替 + 日付フィルタ適用
   ```

3. **空データ時のメッセージ**
   - データが0件の場合に表示
   - テキスト: 「この期間に作業記録がありません」
   - スタイル: 中央揃え、グレーテキスト

#### ユーティリティ関数

| 関数名           | 引数              | 戻り値   | 説明                  |
| ---------------- | ----------------- | -------- | --------------------- |
| `formatDuration` | `seconds: number` | `string` | 秒数をHH:mm形式に変換 |

**変換ロジック**:

- 時間 = 秒数 ÷ 3600（小数点以下切り捨て）
- 分 = (秒数 % 3600) ÷ 60（小数点以下切り捨て）
- 分は2桁にゼロパディング

### 3. +page.svelte の変更

**対象ファイル**: `src/routes/+page.svelte`

#### 追加する State

| State名       | 型                  | 説明         | 初期値                          |
| ------------- | ------------------- | ------------ | ------------------------------- |
| `currentView` | `'list' \| 'daily'` | 現在のビュー | URLの `view` パラメータから取得 |

#### 追加するイベントハンドラー

| ハンドラー名       | 引数                      | 説明       | 動作                              |
| ------------------ | ------------------------- | ---------- | --------------------------------- |
| `handleViewChange` | `view: 'list' \| 'daily'` | ビュー変更 | URLを更新して `goto()` を呼び出し |

#### WorkLogHistory への Props 追加

- `currentView`: State から渡す
- `dailySummaryData`: `data.dailySummaryData`（ビューが `daily` の場合のみ存在）
- `onViewChange`: `handleViewChange` を渡す

## URL設計とルーティング

### クエリパラメータ

| パラメータ | 値                | 説明                         | デフォルト |
| ---------- | ----------------- | ---------------------------- | ---------- |
| `view`     | `list` \| `daily` | 表示ビュー                   | `list`     |
| `month`    | YYYY-MM           | 対象月                       | 今月       |
| `tags`     | tag1,tag2         | タグフィルタ（カンマ区切り） | なし       |
| `page`     | 数値              | ページ番号（一覧のみ）       | 1          |

### URL例

- 作業一覧（デフォルト）: `/?month=2025-11`
- 日別集計: `/?view=daily&month=2025-11`
- タグフィルタ付き日別集計: `/?view=daily&month=2025-11&tags=開発,会議`
- 日付ドリルダウン: `/?view=list&date=2025-11-30`

## ユーザーフロー

### 基本フロー

1. ユーザーが作業一覧画面を表示
2. 「日別集計」タブをクリック
3. 指定月の日別集計が表示される
4. 気になる日付の行をクリック
5. 作業一覧タブに切り替わり、その日の詳細な作業記録が表示される

### フィルタ連携フロー

1. 日別集計タブで月を選択（例: 2025-11）
2. タグフィルタを追加（例: #開発）
3. 「#開発」タグを持つ作業のみの日別集計が表示される
4. 特定の日をクリックしてドリルダウン
5. 作業一覧タブで「2025-11-30」かつ「#開発」でフィルタされた作業が表示される

## 非機能要件

### パフォーマンス

- 日別集計クエリは月単位でインデックスを活用（`user_id`, `started_at`）
- 最大31日分のデータのため、ページングは不要
- クエリレスポンスタイム: 100ms以内（目標）

### アクセシビリティ

- タブは `role="tablist"` と `role="tab"` を使用
- キーボード操作: 矢印キーでタブ間移動、Enterでタブ選択
- スクリーンリーダー対応: 適切な `aria-label` を設定

### レスポンシブデザイン

- モバイル: テーブルは横スクロール可能
- タブレット以上: 通常の表示
- タブUIはモバイルでも見やすいサイズ

## テスト要件

### ユニットテスト

1. **getDailySummary 関数**
   - 正しく日別集計が計算される
   - タグフィルタが正しく適用される
   - 進行中の作業が除外される
   - 曜日が正しく表示される

2. **DailySummaryView コンポーネント**
   - データが正しく表示される
   - 日付クリックでイベントが発火する
   - 空データ時のメッセージが表示される
   - ローディング状態が正しく表示される

### E2Eテスト

1. タブ切り替えが正しく動作する
2. URL が正しく更新される
3. 日付クリックでドリルダウンできる
4. フィルタが両タブで共有される
5. ブラウザバックで正しい状態に戻る

## 実装の優先順位

### Phase 1: 基本機能（必須）

1. Repository層: `getDailySummary` 関数の実装
2. Server Load Function: ビュー分岐処理の追加
3. コンポーネントリネーム: `WorkLogHistory` → `WorkLogListView`
4. 新規コンポーネント: `DailySummaryView` の実装
5. `+page.svelte`: タブUIとビュー切り替えの実装
6. URL パラメータ管理
7. 基本的なユニットテスト
8. Server Load Function: ビュー分岐処理の追加
9. コンポーネントリネーム: `WorkLogHistory` → `WorkLogListView`
10. 新規コンポーネント: `DailySummaryView` の実装
11. `+page.svelte`: タブUIとビュー切り替えの実装
12. URL パラメータ管理
13. 基本的なユニットテスト

### Phase 2: UX 改善

1. ドリルダウン機能（日付クリック）
2. タグフィルタとの連携
3. ローディング状態の改善
4. エラーハンドリング

### Phase 3: 品質向上

1. E2E テストの追加
2. アクセシビリティ対応の強化
3. パフォーマンスチューニング

## 今後の拡張案

1. **グラフ表示**: Chart.js 等を使用した視覚化
2. **週別集計**: 週単位の集計ビュー追加
3. **エクスポート**: 日別集計の CSV/PDF 出力
4. **カレンダービュー**: カレンダー形式での表示
5. **比較機能**: 前月・前年同月との比較
6. **目標設定**: 日別・週別の作業時間目標との比較

## 備考

- 既存の作業一覧機能（F-005/F-006）との整合性を保つ
- フィルタUIは既存のものを再利用し、両タブで共有する（`+page.svelte` で管理）
- タグフィルタ適用時の集計は「OR条件」（いずれかのタグを持つ作業）とする
- 日別集計は「終了済み」の作業のみを対象とする（進行中の作業は除外）
- `WorkLogHistory` コンポーネントは `WorkLogListView` にリネームし、責務を明確化
- ビュー別にコンポーネントを分けることで型安全性を向上し、Optional な Props を削減
