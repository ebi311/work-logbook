# F-006: タグでの絞り込み 機能仕様

最終更新: 2025-11-01T00:00:00Z

## 概要

F-006「日付・タグでの絞り込み」のうち、タグによる絞り込み機能の仕様。日付による絞り込みは既に実装済み（F-005/F-006 仕様書参照）。

**実装状態**: 未実装  
**前提条件**:

- F-003「タグ付け」が実装済み ✅
- F-005「作業一覧の表示」が実装済み ✅
- 日付フィルタが実装済み ✅

## 目的・ゴール

- 特定のタグが付いた作業記録のみを表示できる
- 複数タグでの絞り込み（AND/OR条件）ができる
- 日付フィルタとタグフィルタを組み合わせて使用できる
- URLでフィルタ条件を共有できる（クエリパラメータ）
- ストレスなく素早く絞り込める（タグ入力のサジェスト、ワンクリック選択）

## 用語

- **タグフィルタ**: 作業記録を特定のタグで絞り込む条件
- **AND条件**: 指定した全てのタグが付いている作業のみを表示
- **OR条件**: 指定したタグのいずれかが付いている作業を表示
- **タグバッジ**: 一覧画面で表示されるタグのクリック可能な要素

## ユースケース

### UC-001: タグで絞り込む（単一タグ）

1. ユーザーが作業一覧画面を表示
2. フィルタバーのタグ入力欄にタグ名を入力（例: `開発`）
3. システムは過去に使用したタグをサジェスト表示
4. ユーザーがタグを選択またはEnterキーを押す
5. システムは該当するタグが付いた作業記録のみを表示
6. URLに `?tags=開発` が追加される
7. 選択されたタグがフィルタバーにバッジとして表示される

### UC-002: 複数タグで絞り込む（AND条件）

1. ユーザーが既に1つのタグでフィルタリングしている状態
2. タグ入力欄に別のタグを追加（例: `PJ-A`）
3. システムは両方のタグが付いている作業のみを表示
4. URLに `?tags=開発,PJ-A` が設定される
5. 両方のタグバッジがフィルタバーに表示される

### UC-003: 一覧のタグバッジから絞り込む

1. ユーザーが作業一覧を見ている
2. 作業記録に表示されているタグバッジをクリック
3. システムはそのタグで絞り込んだ結果を表示
4. フィルタバーに選択されたタグが追加される

### UC-004: タグフィルタを解除

1. ユーザーがタグでフィルタリングしている状態
2. フィルタバーのタグバッジの×ボタンをクリック
   - または、フィルタバーの「クリア」ボタンをクリック
3. システムはタグフィルタを解除
4. 日付フィルタのみが適用された状態に戻る（日付フィルタがある場合）

### UC-005: 日付とタグを組み合わせて絞り込む

1. ユーザーが月指定フィルタで `2025-10` を選択
2. さらにタグ `会議` を追加
3. システムは2025年10月の作業のうち、`会議` タグが付いたもののみを表示
4. URLに `?month=2025-10&tags=会議` が設定される

## 画面要素

### フィルタバー（拡張）

既存の日付フィルタに加えて:

- **タグ入力欄**
  - プレースホルダー: 「タグで絞り込み...」
  - サジェスト機能: ユーザーが使用したタグの一覧を表示
  - 複数選択可能
  - キーボード操作: Enter（選択）、Backspace（最後のタグを削除）、Escape（サジェストを閉じる）

- **選択中タグバッジ**
  - 選択されたタグを視覚的に表示
  - 各バッジに×ボタン（削除用）
  - クリックでそのタグの選択を解除

- **クリアボタン**
  - 全てのフィルタ（日付+タグ）をクリア
  - または、個別に「タグをクリア」リンク

### 一覧画面のタグ表示（既存・動作拡張）

- 各作業記録のタグバッジをクリック可能にする
- クリックすると、そのタグでフィルタリング
- 既にフィルタリング中の場合は、タグを追加（AND条件）

## データ仕様

### URLクエリパラメータ

既存の `month`, `date`, `from`, `to`, `page`, `size` に加えて:

- **`tags`**: カンマ区切りのタグ名リスト
  - 例: `?tags=開発,PJ-A`
  - URLエンコードされる（日本語タグの場合）
  - 複数指定時はAND条件（全てのタグが付いている作業のみ）

優先順位: 既存の日付フィルタと同じレベルで並行して適用

### バリデーション

- タグ名: 1〜100文字
- タグ数: 最大10個まで（パフォーマンスとUI上の理由）
- 不正なタグ名は無視（空文字、100文字超）
- 存在しないタグでのフィルタリングは可能（結果が0件になる）

## サーバー処理（SvelteKit）

### Server Load 拡張

既存の `src/routes/+page.server.ts` の load 関数を拡張:

```typescript
export const load: PageServerLoad = async ({ locals, url }) => {
	// ... 既存の認証・日付フィルタ処理

	// タグフィルタの取得
	const tagsParam = url.searchParams.get('tags');
	const tags = tagsParam
		? tagsParam
				.split(',')
				.map((t) => t.trim())
				.filter((t) => t.length > 0 && t.length <= 100)
				.slice(0, 10) // 最大10個
		: undefined;

	// DB検索（タグ条件を追加）
	const result = await listWorkLogs(userId, {
		from,
		to,
		tags, // 追加
		limit: size + 1,
		offset: (page - 1) * size,
	});

	// ... 既存のレスポンス処理
};
```

### DB層拡張

`src/db/workLogs.ts` の `listWorkLogs` 関数を拡張:

```typescript
export type ListWorkLogsOptions = {
	from?: Date;
	to?: Date;
	tags?: string[]; // 追加
	limit: number;
	offset: number;
};

export const listWorkLogs = async (
	userId: string,
	options: ListWorkLogsOptions,
): Promise<WorkLog[]> => {
	const { from, to, tags, limit, offset } = options;

	let query = db
		.select({
			id: workLogs.id,
			userId: workLogs.userId,
			startedAt: workLogs.startedAt,
			endedAt: workLogs.endedAt,
			description: workLogs.description,
			createdAt: workLogs.createdAt,
			updatedAt: workLogs.updatedAt,
		})
		.from(workLogs)
		.where(eq(workLogs.userId, userId));

	// 日付フィルタ（既存）
	if (from) {
		query = query.where(gte(workLogs.startedAt, from));
	}
	if (to) {
		query = query.where(lte(workLogs.startedAt, to));
	}

	// タグフィルタ（新規）
	if (tags && tags.length > 0) {
		// 全てのタグが付いている作業のみを取得（AND条件）
		// サブクエリを使用して、指定されたタグ数と一致するwork_log_idを抽出
		const taggedWorkLogIds = db
			.select({ workLogId: workLogTags.workLogId })
			.from(workLogTags)
			.where(and(eq(workLogTags.userId, userId), inArray(workLogTags.tag, tags)))
			.groupBy(workLogTags.workLogId)
			.having(sql`COUNT(DISTINCT ${workLogTags.tag}) = ${tags.length}`);

		query = query.where(inArray(workLogs.id, taggedWorkLogIds));
	}

	// 並び順・ページング（既存）
	const rows = await query.orderBy(desc(workLogs.startedAt)).limit(limit).offset(offset);

	// タグの取得とWorkLogオブジェクトの構築
	return await Promise.all(
		rows.map(async (row) => {
			const tags = await getWorkLogTags(row.id);
			return WorkLog.reconstruct({ ...row, tags });
		}),
	);
};
```

**注意**: 上記のSQLは概念的なものです。Drizzle ORMの具体的なAPIに合わせて調整が必要です。

### タグサジェスト用API

ユーザーが使用した全タグのリストを取得するエンドポイント（既存または新規）:

```typescript
// src/routes/api/tags/+server.ts (新規)
export const GET: RequestHandler = async ({ locals }) => {
	const user = await getAuthenticatedUser(locals);
	if (!user) {
		throw error(401, 'Unauthorized');
	}

	const tags = await getUserTags(user.id);
	return json({ tags });
};
```

DB層:

```typescript
// src/db/workLogTags.ts
export const getUserTags = async (userId: string): Promise<string[]> => {
	const rows = await db
		.selectDistinct({ tag: workLogTags.tag })
		.from(workLogTags)
		.where(eq(workLogTags.userId, userId))
		.orderBy(workLogTags.tag);

	return rows.map((r) => r.tag);
};
```

## フロントエンド実装

### コンポーネント構成

1. **`FilterBar.svelte`** (拡張)
   - 既存の日付フィルタに加えて、タグ入力欄を追加
   - Props: `selectedTags: string[]`, `availableTags: string[]`
   - Events: `on:tagsChange`

2. **`TagInput.svelte`** (新規)
   - タグの入力とサジェスト機能
   - 複数選択をサポート
   - キーボード操作対応
   - Props: `tags: string[]`, `suggestions: string[]`
   - Events: `on:change`

3. **`TagBadge.svelte`** (既存・拡張)
   - 既存のタグ表示コンポーネント
   - クリック可能にする（`clickable` prop を追加）
   - Events: `on:click`, `on:remove`

### ページロジック

`src/routes/+page.svelte`:

```svelte
<script lang="ts">
	import { goto } from '$app/navigation';
	import { page } from '$app/stores';
	import FilterBar from '$lib/components/FilterBar.svelte';

	export let data;

	$: selectedTags = $page.url.searchParams.get('tags')?.split(',') || [];

	const handleTagsChange = (event: CustomEvent<string[]>) => {
		const tags = event.detail;
		const url = new URL($page.url);

		if (tags.length > 0) {
			url.searchParams.set('tags', tags.join(','));
		} else {
			url.searchParams.delete('tags');
		}

		// ページをリセット
		url.searchParams.set('page', '1');

		goto(url.toString(), { replaceState: true });
	};

	const handleTagClick = (tag: string) => {
		const newTags = selectedTags.includes(tag)
			? selectedTags.filter((t) => t !== tag)
			: [...selectedTags, tag];

		handleTagsChange({ detail: newTags } as CustomEvent<string[]>);
	};
</script>

<FilterBar
	{selectedTags}
	availableTags={data.availableTags || []}
	on:tagsChange={handleTagsChange}
/>

<!-- 作業一覧 -->
{#each data.items as workLog}
	<div>
		<!-- ... 既存の表示 ... -->
		<div class="tags">
			{#each workLog.tags as tag}
				<TagBadge {tag} clickable on:click={() => handleTagClick(tag)} />
			{/each}
		</div>
	</div>
{/each}
```

## UI/UX仕様

### デザイン方針

- **ミニマリスト**: 余計な装飾を避け、機能に集中
- **レスポンシブ**: モバイルでも使いやすい
- **アクセシブル**: キーボード操作、スクリーンリーダー対応

### タグ入力のインタラクション

1. **サジェスト表示**
   - 入力欄にフォーカスすると、全タグリストを表示
   - 文字を入力すると、前方一致・部分一致でフィルタリング
   - 最大10件まで表示

2. **キーボード操作**
   - `↓` / `↑`: サジェストリスト内を移動
   - `Enter`: 選択されたタグを追加
   - `Escape`: サジェストを閉じる
   - `Backspace` (入力が空の時): 最後に追加したタグを削除
   - `Tab`: サジェストを閉じて次の要素へ

3. **マウス操作**
   - サジェストリストのタグをクリック: そのタグを追加
   - タグバッジの×をクリック: タグを削除

### スタイリング（Tailwind CSS + daisyUI）

```html
<!-- タグ入力欄 -->
<div class="form-control">
	<label class="label">
		<span class="label-text">タグで絞り込み</span>
	</label>
	<input type="text" placeholder="タグを入力..." class="input-bordered input w-full" />
</div>

<!-- 選択中タグバッジ -->
<div class="mt-2 flex flex-wrap gap-2">
	<div class="badge gap-2 badge-primary">
		開発
		<button class="btn btn-ghost btn-xs">×</button>
	</div>
</div>

<!-- サジェストリスト -->
<ul class="menu mt-1 w-full rounded-box bg-base-100 shadow-lg">
	<li><a>開発</a></li>
	<li><a>会議</a></li>
	<li><a>PJ-A</a></li>
</ul>
```

## パフォーマンス考慮

### DB最適化

- `work_log_tags` テーブルに適切なインデックスを設定済み（F-003で実装）
  - `idx_work_log_tags_work_log_id`
  - `idx_work_log_tags_tag`
  - `idx_work_log_tags_user_tag`

- タグ数が多い場合のクエリ最適化
  - HAVING句を使った効率的なAND検索
  - 必要に応じてクエリプランを確認

### フロントエンド最適化

- タグサジェストのデバウンス（入力後200ms）
- タグリストのキャッシュ（ページロード時に一度取得）
- 仮想スクロール（タグが100個を超える場合のみ）

## テスト仕様

### 単体テスト

1. **DB層テスト** (`src/db/workLogs.spec.ts`)
   - 単一タグでのフィルタリング
   - 複数タグでのフィルタリング（AND条件）
   - 存在しないタグでのフィルタリング（結果0件）
   - 日付とタグの組み合わせフィルタリング
   - タグ数制限のテスト

2. **ドメイン層テスト**
   - タグバリデーション（文字数、数量）

3. **コンポーネントテスト**
   - `TagInput.svelte`: サジェスト動作、キーボード操作
   - `FilterBar.svelte`: タグ追加・削除、イベント発火
   - `TagBadge.svelte`: クリックイベント

### E2Eテスト (Playwright)

1. **タグフィルタリングフロー**
   - タグ入力欄にタグを入力
   - サジェストから選択
   - フィルタリングされた結果を確認
   - URLパラメータの確認

2. **複数タグフィルタリング**
   - 2つのタグを追加
   - AND条件で絞り込まれることを確認

3. **タグバッジクリック**
   - 一覧のタグバッジをクリック
   - そのタグでフィルタリングされることを確認

4. **フィルタクリア**
   - タグバッジの×をクリック
   - フィルタが解除されることを確認

## 非機能要件

### アクセシビリティ

- タグ入力欄に適切なラベル（`<label>`）
- サジェストリストにARIAロール（`role="listbox"`、`role="option"`）
- キーボードのみで全操作が可能
- フォーカスインジケーターの明確な表示

### セキュリティ

- XSS対策: タグ名のエスケープ（Svelteが自動で行う）
- SQLインジェクション対策: Drizzle ORMのパラメータバインディング

### エラーハンドリング

- タグが多すぎる場合: 最大10個に制限（警告表示）
- 不正なタグ名: 無視（バリデーションでフィルタ）
- DB接続エラー: 500エラー、ユーザーにエラーメッセージ表示

## 将来の拡張

### OR条件サポート

現在はAND条件のみだが、将来的にOR条件も追加:

- UI: トグルスイッチで「すべて含む（AND）」「いずれか含む（OR）」を切り替え
- URLパラメータ: `?tags=開発,会議&tagsMode=or`

### タググループ

タグをカテゴリ別にグループ化:

- プロジェクト: `PJ-A`, `PJ-B`
- 作業種別: `開発`, `会議`, `レビュー`
- サジェストでグループごとに表示

### タグの統計

- よく使うタグTOP10を表示
- 未使用タグの削除機能

## マイルストーン

1. **Phase 1**: DB層とAPI実装（タグフィルタ機能の基盤）
2. **Phase 2**: UI実装（タグ入力、バッジクリック）
3. **Phase 3**: サジェスト機能の実装
4. **Phase 4**: テスト実装
5. **Phase 5**: E2Eテスト、リファクタリング、デプロイ

## 参考資料

- [F-003: タグ付け仕様](./2025-10-29%2000:00-F003-tags.md)
- [F-005/F-006: 作業一覧表示と絞り込み仕様](./2025-10-25%2000:00-F005-F006-worklog-list-and-filter.md)
- [Drizzle ORM - Filters](https://orm.drizzle.team/docs/select#filtering)
- [daisyUI - Badge](https://daisyui.com/components/badge/)
- [daisyUI - Input](https://daisyui.com/components/input/)
