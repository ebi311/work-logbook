# F-004: Phase 1 - 編集機能（作業記録の編集）

**タスクID**: F004-EDIT  
**作成日**: 2025-10-27 14:00  
**関連機能**: [F-004: 作業記録の編集・削除](../features/2025-10-27%2012:00-F004-edit-delete-worklog.md)

## 目的

完了した作業記録の編集機能を実装する。開始時刻、終了時刻、作業内容を変更できるようにする。

## 前提条件

- F-001「作業開始・終了」が実装済み
- F-002「作業内容の入力」が実装済み
- F-005「作業一覧の表示」が実装済み
- 進行中の作業（`endedAt` が `null`）は編集対象外

## 実装範囲

### 1. ドメインモデルの拡張

**ファイル:** `src/models/workLog.ts`

- `WorkLog` クラスに編集用メソッドを追加
  - `update()`: 作業記録を更新した新しいインスタンスを返す
  - `validateTimeRange()`: 開始時刻と終了時刻の整合性を検証
- バリデーションロジックの実装

### 2. Server Actions（更新処理）

**ファイル:** `src/routes/+page.server.ts`

- `actions.update`: 作業記録の更新処理
- 認証チェック
- 権限チェック（自分の作業記録のみ）
- バリデーション
- データベース更新

### 3. UIコンポーネント

**編集モーダルコンポーネント:** `src/routes/_components/WorkLogEditModal/`

- モーダルダイアログの表示/非表示制御
- 編集フォーム（開始時刻、終了時刻、作業内容）
- バリデーション表示
- フォーム送信処理

**作業一覧への編集ボタン追加:**

- 完了した作業のみに編集ボタンを表示
- ボタンクリックで編集モーダルを開く

### 4. バリデーションユーティリティ

**ファイル:** `src/lib/utils/validation.ts`

- 時刻の整合性チェック
- 未来の時刻チェック
- 作業内容の文字数チェック

## API仕様

### actions.update

#### 入力

```typescript
{
	id: number;
	startedAt: string; // ISO 8601形式
	endedAt: string; // ISO 8601形式（完了した作業のみなのでnullなし）
	description: string;
}
```

#### 出力（成功時）

```typescript
{
	ok: true;
	workLog: {
		id: number;
		userId: number;
		startedAt: string; // ISO 8601形式
		endedAt: string; // ISO 8601形式
		description: string;
		updatedAt: string; // ISO 8601形式
	}
	serverNow: string; // ISO 8601形式
}
```

#### 出力（失敗時）

```typescript
{
  ok: false;
  reason: 'UNAUTHORIZED' | 'NOT_FOUND' | 'FORBIDDEN' | 'VALIDATION_ERROR' | 'INTERNAL_ERROR';
  message: string;
  errors?: Record<string, string>; // フィールドごとのエラー
  serverNow: string;
}
```

### 処理フロー

1. 認証チェック: `locals.user`が無い場合は401エラー
2. フォームデータから `id`, `startedAt`, `endedAt`, `description` を取得
3. 作業記録をDBから取得
4. 作業記録が見つからない場合、404エラーを返却
5. 権限チェック: 作業記録の`userId`と現在のユーザーが一致するか確認
6. 不一致の場合、403エラーを返却
7. バリデーション:
   - 時刻の整合性（startedAt < endedAt）
   - 未来の時刻でないこと
   - 作業内容の文字数（最大10,000文字）
8. バリデーションエラーがある場合、400エラーを返却
9. ドメインモデルを使用して更新処理
10. データベースを更新
11. 成功レスポンスを返却

## バリデーションルール

### 時刻の整合性

| ルール                 | エラーメッセージ                               |
| ---------------------- | ---------------------------------------------- |
| startedAt < endedAt    | "開始時刻は終了時刻より前である必要があります" |
| startedAt が未来でない | "未来の時刻は設定できません"                   |
| endedAt が未来でない   | "未来の時刻は設定できません"                   |

### 作業内容

| ルール                     | エラーメッセージ                             |
| -------------------------- | -------------------------------------------- |
| description.length ≤ 10000 | "作業内容は10,000文字以内で入力してください" |

## 実装ステップ

### Step 1: ドメインモデルの拡張

**ファイル:** `src/models/workLog.ts`, `src/models/workLog.spec.ts`

#### 実装内容

1. `WorkLog.update()` メソッドの実装
   - 引数: `{ startedAt?, endedAt?, description? }`
   - 戻り値: 新しい `WorkLog` インスタンス
   - イミュータブルに実装（元のインスタンスは変更しない）

2. `WorkLog.validateTimeRange()` メソッドの実装
   - `startedAt` < `endedAt` の検証
   - `endedAt` が `null` の場合は検証をスキップ
   - エラー時は `Error` をスロー

3. `WorkLog.isActive()` メソッドの実装
   - `endedAt === null` の判定
   - 戻り値: `boolean`

#### テストケース

**TC1: update() - 正常系**

- 各フィールドが正しく更新される
- 元のインスタンスが変更されない
- `updatedAt` が現在時刻で更新される

**TC2: update() - 部分更新**

- 一部のフィールドのみ更新できる
- 指定しないフィールドは元の値を保持

**TC3: validateTimeRange() - 正常系**

- startedAt < endedAt の場合、エラーをスローしない

**TC4: validateTimeRange() - 異常系**

- startedAt >= endedAt の場合、エラーをスロー
- エラーメッセージが適切

**TC5: validateTimeRange() - endedAt が null の場合**

- 検証をスキップ（エラーをスローしない）

**TC6: isActive() - 進行中の場合**

- `endedAt === null` の場合、`true` を返す

**TC7: isActive() - 完了した場合**

- `endedAt` に値がある場合、`false` を返す

#### 合格基準

- [ ] すべてのテストがパスすること
- [ ] TypeScriptの型エラーがないこと
- [ ] イミュータブルに実装されていること

---

### Step 2: バリデーションユーティリティの実装

**ファイル:** `src/lib/utils/validation.ts`, `src/lib/utils/validation.spec.ts`

#### 実装内容

1. `validateTimeRange(startedAt: Date, endedAt: Date): { valid: boolean; error?: string }`
   - 開始時刻が終了時刻より前かチェック
   - 未来の時刻でないかチェック

2. `validateDescription(description: string): { valid: boolean; error?: string }`
   - 文字数が10,000文字以内かチェック

3. `isFutureDate(date: Date): boolean`
   - 指定された日時が未来かどうかを判定

#### テストケース

**TC1: validateTimeRange() - 正常系**

- 開始 < 終了の場合、`{ valid: true }` を返す

**TC2: validateTimeRange() - 開始 >= 終了**

- `{ valid: false, error: "開始時刻は終了時刻より前である必要があります" }` を返す

**TC3: validateTimeRange() - 開始が未来**

- `{ valid: false, error: "未来の時刻は設定できません" }` を返す

**TC4: validateTimeRange() - 終了が未来**

- `{ valid: false, error: "未来の時刻は設定できません" }` を返す

**TC5: validateDescription() - 正常系**

- 10,000文字以内の場合、`{ valid: true }` を返す

**TC6: validateDescription() - 10,000文字超**

- `{ valid: false, error: "作業内容は10,000文字以内で入力してください" }` を返す

**TC7: isFutureDate() - 未来の日時**

- `true` を返す

**TC8: isFutureDate() - 過去の日時**

- `false` を返す

#### 合格基準

- [ ] すべてのテストがパスすること
- [ ] エッジケース（境界値）が正しく処理されること

---

### Step 3: Server Actions - update の実装

**ファイル:** `src/routes/+page.server.ts`, `src/routes/page.server.spec.ts`

#### 実装内容

1. `actions.update` の実装
   - フォームデータの取得とパース
   - 認証チェック
   - 作業記録の取得
   - 権限チェック
   - バリデーション
   - ドメインモデルを使用した更新
   - データベース更新
   - レスポンスの構築

2. エラーハンドリング
   - 401: 未認証
   - 403: 権限なし
   - 404: 作業記録が見つからない
   - 400: バリデーションエラー
   - 500: サーバーエラー

#### テストケース

**TC1: 正常系 - 更新成功**

- モック: `locals.user`が存在
- モック: 作業記録が存在し、`userId`が一致
- モック: バリデーションがパス
- モック: DB更新が成功
- 検証: `ok: true` が返却される
- 検証: 更新された `workLog` が含まれる
- 検証: `serverNow` が含まれる

**TC2: 異常系 - 未認証**

- モック: `locals.user`が存在しない
- 検証: 401エラーがスローされる

**TC3: 異常系 - 作業記録が見つからない**

- モック: `locals.user`が存在
- モック: 作業記録が存在しない
- 検証: 404エラーが返却される
- 検証: `reason: 'NOT_FOUND'`

**TC4: 異常系 - 権限なし（他人の作業記録）**

- モック: `locals.user`が存在
- モック: 作業記録が存在するが、`userId`が不一致
- 検証: 403エラーが返却される
- 検証: `reason: 'FORBIDDEN'`

**TC5: 異常系 - バリデーションエラー（時刻の整合性）**

- モック: `locals.user`が存在
- モック: 作業記録が存在し、`userId`が一致
- モック: `startedAt >= endedAt`
- 検証: 400エラーが返却される
- 検証: `reason: 'VALIDATION_ERROR'`
- 検証: `errors` にフィールドごとのエラーが含まれる

**TC6: 異常系 - バリデーションエラー（未来の時刻）**

- モック: `locals.user`が存在
- モック: 作業記録が存在し、`userId`が一致
- モック: `endedAt` が未来の時刻
- 検証: 400エラーが返却される

**TC7: 異常系 - バリデーションエラー（文字数超過）**

- モック: `locals.user`が存在
- モック: 作業記録が存在し、`userId`が一致
- モック: `description` が10,001文字
- 検証: 400エラーが返却される

**TC8: 異常系 - サーバーエラー**

- モック: DB更新時にエラーが発生
- 検証: 500エラーがスローされる

#### 合格基準

- [ ] すべてのテストがパスすること
- [ ] エラーハンドリングが適切に実装されていること
- [ ] レスポンス形式がAPI仕様に準拠していること

---

### Step 4: WorkLogEditModal コンポーネントの実装

**ディレクトリ構成:**

```
src/routes/_components/WorkLogEditModal/
├── WorkLogEditModal.svelte
├── WorkLogEditModal.spec.ts
└── WorkLogEditModal.stories.svelte
```

#### 実装内容

1. コンポーネント本体の実装
   - Props定義
     - `workLog`: 編集対象の作業記録
     - `open`: モーダルの開閉状態
   - イベント定義
     - `close`: モーダルを閉じるイベント
     - `updated`: 更新成功時のイベント
   - フォーム要素
     - 開始時刻: `<input type="datetime-local">`
     - 終了時刻: `<input type="datetime-local">`
     - 作業内容: `<textarea>`
   - バリデーション
     - クライアント側のリアルタイムバリデーション
     - エラーメッセージの表示
   - フォーム送信
     - `enhance` を使用してプログレッシブエンハンスメント
     - 送信中の無効化
   - キーボードショートカット
     - `Esc`: キャンセル
     - `Ctrl/Cmd + Enter`: 保存

2. ユニットテストの実装
   - モーダルの表示/非表示
   - フォーム入力の動作
   - バリデーションエラーの表示
   - フォーム送信の動作
   - キーボードショートカット

3. Storybookストーリーの実装
   - 開いた状態のストーリー
   - 閉じた状態のストーリー
   - バリデーションエラーのストーリー

#### テストケース

**TC1: モーダルの表示**

- Props: `open = true`
- 検証: モーダルが表示される

**TC2: モーダルの非表示**

- Props: `open = false`
- 検証: モーダルが表示されない

**TC3: フォーム入力**

- 操作: 各フィールドに値を入力
- 検証: 入力値が正しく反映される

**TC4: バリデーションエラー（時刻の整合性）**

- 操作: 開始時刻 > 終了時刻に設定
- 検証: エラーメッセージが表示される
- 検証: 保存ボタンが無効化される

**TC5: バリデーションエラー（未来の時刻）**

- 操作: 未来の時刻を設定
- 検証: エラーメッセージが表示される

**TC6: バリデーションエラー（文字数超過）**

- 操作: 10,001文字の作業内容を入力
- 検証: エラーメッセージが表示される

**TC7: フォーム送信成功**

- モック: Server Actionが成功レスポンスを返す
- 操作: 保存ボタンをクリック
- 検証: `updated` イベントが発火する
- 検証: モーダルが閉じる

**TC8: フォーム送信失敗**

- モック: Server Actionがエラーレスポンスを返す
- 操作: 保存ボタンをクリック
- 検証: エラーメッセージが表示される
- 検証: モーダルは開いたまま

**TC9: キャンセル**

- 操作: キャンセルボタンをクリック
- 検証: `close` イベントが発火する

**TC10: キーボードショートカット（Esc）**

- 操作: `Esc` キーを押下
- 検証: `close` イベントが発火する

**TC11: キーボードショートカット（Ctrl+Enter）**

- 操作: `Ctrl/Cmd + Enter` キーを押下
- 検証: フォームが送信される

#### 合格基準

- [ ] すべてのテストがパスすること
- [ ] Storybookでビジュアル確認ができること
- [ ] キーボード操作が正しく動作すること
- [ ] バリデーションがリアルタイムで動作すること

---

### Step 5: 作業一覧への編集ボタン追加

**ファイル:** `src/routes/+page.svelte`, `src/routes/page.svelte.spec.ts`

#### 実装内容

1. 編集ボタンの追加
   - 完了した作業（`endedAt !== null`）のみに表示
   - 鉛筆アイコンまたは「編集」ラベル
   - クリックで編集モーダルを開く

2. モーダルの状態管理
   - 編集対象の作業記録を保持
   - モーダルの開閉状態を管理

3. 更新後の処理
   - 一覧を再読み込み（またはクライアント側で更新）
   - トースト通知: "作業記録を更新しました"

#### テストケース

**TC1: 編集ボタンの表示（完了した作業）**

- Props: `endedAt` が設定されている作業
- 検証: 編集ボタンが表示される

**TC2: 編集ボタンの非表示（進行中の作業）**

- Props: `endedAt === null` の作業
- 検証: 編集ボタンが表示されない

**TC3: 編集ボタンクリック**

- 操作: 編集ボタンをクリック
- 検証: 編集モーダルが開く
- 検証: 選択した作業記録のデータがモーダルに表示される

**TC4: 更新成功後の処理**

- モック: 更新が成功
- 検証: モーダルが閉じる
- 検証: 一覧が更新される
- 検証: トースト通知が表示される

#### 合格基準

- [ ] すべてのテストがパスすること
- [ ] 編集ボタンが正しい条件で表示されること
- [ ] 編集フローが正しく動作すること

---

### Step 6: E2Eテストの実装

**ファイル:** `e2e/edit-worklog.test.ts`

#### テストシナリオ

**シナリオ1: 編集フロー（正常系）**

1. ログイン
2. 作業を開始・終了して完了した作業を作成
3. 作業一覧で編集ボタンをクリック
4. 編集モーダルが開く
5. 開始時刻、終了時刻、作業内容を変更
6. 保存ボタンをクリック
7. モーダルが閉じる
8. 一覧に更新された内容が表示される
9. トースト通知が表示される

**シナリオ2: バリデーションエラー**

1. ログイン
2. 完了した作業の編集ボタンをクリック
3. 開始時刻を終了時刻より後に設定
4. エラーメッセージが表示される
5. 保存ボタンが無効化される

**シナリオ3: キャンセル**

1. ログイン
2. 完了した作業の編集ボタンをクリック
3. 内容を変更
4. キャンセルボタンをクリック
5. モーダルが閉じる
6. 一覧の内容は変更されていない

#### 合格基準

- [ ] すべてのE2Eテストがパスすること
- [ ] 実際のブラウザで正しく動作すること

---

## 全体の合格基準

- [ ] すべてのユニットテストがパスする
- [ ] すべての統合テストがパスする
- [ ] すべてのE2Eテストがパスする
- [ ] TypeScriptの型エラーがない
- [ ] ESLintのエラーがない
- [ ] Storybookで各コンポーネントが正しく表示される
- [ ] 編集機能が正しく動作する
- [ ] バリデーションが適切に動作する
- [ ] エラーハンドリングが適切に実装されている

## 参考資料

- [F-004 機能仕様書](../features/2025-10-27%2012:00-F004-edit-delete-worklog.md)
- [F-001 機能仕様書](../features/2025-10-19%2012:51-F001-start-stop.md)
- [F-002 機能仕様書](../features/2025-10-27%2000:00-F002-work-description.md)
- SvelteKit Form Actions: https://kit.svelte.dev/docs/form-actions
- Testing Library for Svelte: https://testing-library.com/docs/svelte-testing-library/intro
