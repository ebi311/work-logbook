# F-006 UC-004: タグフィルタのクリア機能

作成日: 2025-11-01T14:00:00Z  
ステータス: 実装中

## 概要

タグでフィルタリングしている状態から、タグフィルタを解除する機能を実装します。

## 前提条件

- ✅ F-006 UC-001: 単一タグフィルタ実装済み
- ✅ F-006 UC-002: 複数タグフィルタ実装済み
- ✅ F-006 UC-003: タグバッジクリック実装済み

## ユースケース

### UC-004-1: 個別タグの削除

1. ユーザーがタグでフィルタリングしている状態（例: `開発`, `PJ-A`）
2. フィルタバーのタグバッジの×ボタンをクリック（例: `PJ-A` を削除）
3. システムは選択されたタグを削除し、残りのタグでフィルタリング（例: `開発` のみ）
4. URLが更新される（例: `?tags=開発`）
5. 削除されたタグのバッジがフィルタバーから消える

### UC-004-2: 全タグの削除（Backspaceキー）

1. ユーザーがタグでフィルタリングしている状態
2. タグ入力欄にフォーカスがある状態でBackspaceキーを押す
3. システムは最後に追加されたタグを削除
4. URLが更新される
5. 削除されたタグのバッジがフィルタバーから消える

## 実装ステップ

### Step 1: TagInputコンポーネントの確認

**目的**: TagInputコンポーネントが既に×ボタンとBackspace削除をサポートしているか確認

**確認項目**:

- ✅ タグの削除機能が実装されているか
- ✅ `on:change` イベントで削除後のタグリストが通知されるか
- ✅ Backspaceキーで最後のタグを削除できるか

**結果**: 既存のTagInputコンポーネントは削除機能を完全にサポートしているため、追加の実装は不要。

### Step 2: フィルタバーでのTagInput統合確認

**目的**: WorkLogHistoryコンポーネントのフィルタバーでTagInputが正しく機能しているか確認

**実装箇所**: `src/routes/_components/WorkLogHistory/WorkLogHistory.svelte`

**確認項目**:

```svelte
<TagInput
	tags={filterTags}
	suggestions={tagSuggestions}
	placeholder="タグで絞り込み..."
	on:change={(e) => onFilterTagsChange(e.detail)}
/>
```

**合格基準**:

- タグバッジの×ボタンが表示される
- ×ボタンクリックで `on:change` イベントが発火する
- Backspaceキーで最後のタグが削除される
- 削除後のタグリストが `onFilterTagsChange` に渡される

### Step 3: +page.svelteでの削除処理確認

**目的**: handleFilterTagsChange関数がタグ削除を正しく処理できるか確認

**実装箇所**: `src/routes/+page.svelte`

**確認内容**:

```typescript
// F-006: フィルタタグ変更ハンドラー
const handleFilterTagsChange = (newTags: string[]) => {
	const url = new URL(page.url);

	if (newTags.length > 0) {
		url.searchParams.set('tags', newTags.join(','));
	} else {
		url.searchParams.delete('tags'); // ✅ 全削除時にクエリパラメータを削除
	}

	// ページをリセット
	url.searchParams.set('page', '1');

	goto(url.toString(), { replaceState: false, noScroll: true, keepFocus: true });
};
```

**合格基準**:

- `newTags` が空配列の場合、`tags` クエリパラメータが削除される
- `newTags` が空でない場合、残りのタグでフィルタリングが継続される
- ページが1にリセットされる
- スクロール位置が保持される

### Step 4: テストケースの追加

**目的**: タグ削除機能の動作を確認するテストを追加

**実装箇所**: `src/routes/page.svelte.spec.ts`

**テストケース**:

```typescript
describe('F-006 UC-004: タグフィルタのクリア', () => {
	it('タグバッジの×ボタンで個別タグを削除できる', async () => {
		// Given: 複数タグでフィルタリング中（'開発', 'PJ-A'）
		// When: 'PJ-A' のバッジの×ボタンをクリック
		// Then: '開発' のみでフィルタリングされる
	});

	it('最後のタグを削除すると、タグフィルタが完全に解除される', async () => {
		// Given: 1つのタグでフィルタリング中（'開発'）
		// When: タグバッジの×ボタンをクリック
		// Then: タグフィルタが解除され、全作業が表示される
	});

	it('Backspaceキーで最後のタグを削除できる', async () => {
		// Given: 複数タグでフィルタリング中（'開発', 'PJ-A'）
		// When: タグ入力欄でBackspaceキーを押す
		// Then: 最後に追加されたタグ（'PJ-A'）が削除される
	});

	it('全タグ削除時、URLからtagsパラメータが削除される', async () => {
		// Given: タグでフィルタリング中
		// When: 全てのタグを削除
		// Then: URLに ?tags= が含まれない
	});
});
```

### Step 5: 動作確認とコミット

**確認項目**:

1. ✅ タグバッジの×ボタンが表示される
2. ✅ ×ボタンクリックで該当タグが削除される
3. ✅ 複数タグから1つ削除すると、残りのタグでフィルタリングが継続される
4. ✅ 最後のタグを削除すると、タグフィルタが完全に解除される
5. ✅ Backspaceキーで最後のタグを削除できる
6. ✅ URLが正しく更新される（全削除時は `tags` パラメータが削除される）
7. ✅ スクロール位置が保持される

**コミット**:

```bash
git add -A
git commit -m "F-006 UC-004: タグフィルタのクリア機能を実装

- TagInputコンポーネントの既存機能を活用
  - タグバッジの×ボタンで個別削除
  - Backspaceキーで最後のタグを削除
- handleFilterTagsChangeで全削除時にURLパラメータを削除
- テストケース追加（4件）
- 全テスト成功
"
```

## 技術仕様

### イベントフロー

```
TagInput (×ボタンクリック or Backspace)
  → on:change イベント発火（削除後のタグリスト）
    → WorkLogHistory (onFilterTagsChange)
      → +page.svelte (handleFilterTagsChange)
        → goto() でURL更新
          → +page.server.ts (load関数)
            → DBから再取得
```

### タグ削除のロジック

TagInputコンポーネント内で既に実装済み:

1. **×ボタンクリック**:

   ```typescript
   const handleRemove = (index: number) => {
   	const newTags = [...tags];
   	newTags.splice(index, 1);
   	dispatch('change', newTags);
   };
   ```

2. **Backspaceキー**:
   ```typescript
   const handleKeyDown = (e: KeyboardEvent) => {
   	if (e.key === 'Backspace' && inputValue === '' && tags.length > 0) {
   		e.preventDefault();
   		const newTags = [...tags];
   		newTags.pop(); // 最後のタグを削除
   		dispatch('change', newTags);
   	}
   };
   ```

### URL更新のロジック

+page.svelte の handleFilterTagsChange:

```typescript
if (newTags.length > 0) {
	url.searchParams.set('tags', newTags.join(','));
} else {
	url.searchParams.delete('tags'); // ✅ 重要: 全削除時にパラメータを削除
}
```

## UI/UX仕様

### タグバッジの×ボタン

- 位置: バッジの右端
- アイコン: `×` 文字
- スタイル:
  - デフォルト: 薄いグレー
  - hover: 濃いグレー、カーソル変更（pointer）
  - active: さらに濃いグレー
- アクセシビリティ:
  - aria-label: "削除"
  - role: "button"
  - キーボード操作可能（Enter/Space）

### Backspace削除の挙動

- 条件: タグ入力欄にフォーカスがあり、入力値が空の状態
- 動作: 最後に追加されたタグを削除
- フィードバック: 削除されたタグのバッジがフェードアウト

### 全削除時の挙動

- タグフィルタが完全に解除される
- 日付フィルタは保持される（ある場合）
- ページが1にリセットされる
- 「データがありません」または「全件表示」メッセージ（データによる）

## 非機能要件

- **パフォーマンス**: タグ削除からフィルタリングまで100ms以内
- **アクセシビリティ**:
  - スクリーンリーダー対応（×ボタンに適切なラベル）
  - キーボード操作のみで削除可能
- **レスポンシブ**: モバイルでもタップしやすい×ボタンサイズ（最低44x44px）

## 備考

- TagInputコンポーネントは既にF-003で完全に実装されているため、UC-004は主にテストと動作確認が中心
- 既存の実装を活用することで、コード重複を避け、一貫性を保つ
- 「全タグクリア」専用のボタンは不要（最後のタグの×ボタンで同じ結果が得られる）
