# 作業記録 F-001.2 仕様（進行中作業の開始時刻・内容・タグ編集）

進行中（`endedAt=null`）の作業について、開始時刻・作業内容・タグを停止前に修正できるようにする拡張仕様。

最終更新: 2025-11-18 (更新案: 進行中カード内に開始時刻フィールドと「作業中変更」ボタンを追加する方針へ修正)

## 目的・ゴール

- 「開始」ボタンを押し忘れた際に、実際の開始時刻へ即座に補正できる
- 進行中にメモやタグを追記して思考ログを残せる
- 停止操作を挟まずに修正できることで、CONCEPTの「思考を中断させない」体験を保つ

## 背景 / 課題

- 現状は進行中作業カードで description/tags を即時編集できるが、開始時刻のみ調整手段がなく停止→編集→再開が必要
- 誤って遅れて開始した場合、開始時刻を戻す手段がないため月次集計が不正確になる
- 作業中メモやタグは既存UIで更新できるが、開始時刻まで同じコンテキストで扱えないことが体験差になっている

## スコープ

- **対象**: 進行中の単一作業レコード (`WorkLog` with `endedAt=null`)
- **編集項目**: `startedAt`, `description`, `tags`
- **除外**: 終了時刻の編集（停止時に確定する）、他ユーザーの作業、複数アクティブ状態

## 関連要件

- 前提: F-001「作業開始・終了」
- 前提: F-002「作業内容の入力」
- 前提: F-003「タグ付け」
- 関連: F-004「作業記録の編集・削除」（完了後の編集）

## ユーザーストーリー / ユースケース

| ID     | ストーリー       | 詳細フロー                                                                                                                                                                                             |
| ------ | ---------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| UC-001 | 開始押し忘れ補正 | 1) 10:05 に開始ボタンを押し忘れ 10:20 に押下<br>2) 進行中カード上の開始時刻入力（ボタン群と同じ領域）で `startedAt` を 10:05 に変更<br>3) 「作業中変更」ボタンで保存すると、タイマー表示が再計算される |
| UC-002 | 作業メモ追記     | 1) 作業中にメモを残したい場合、既存の「作業内容」テキストエリアに追記<br>2) 「作業中変更」ボタンで保存すると停止待ちせずに description フィールドが更新される                                          |
| UC-003 | タグの差し替え   | 1) 誤ったタグを付けたまま開始した場合、既存タグ入力で削除＋追加<br>2) 「作業中変更」ボタンで保存すると `tags` が差し替わり、将来のフィルタリングに即時反映                                             |
| UC-004 | 誤操作の取り消し | 編集途中で内容を戻したい場合はキャンセルか未保存警告で元に戻せる                                                                                                                                       |

## 機能要件

| ID    | 要件                  | 内容                                                                                                         | 受入基準                                                           |
| ----- | --------------------- | ------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------ |
| FR-01 | 進行中カード内編集UI  | 既存の description/tags 入力があるカードに `datetime-local` の開始時刻フィールドを追加し、常時表示する       | 進行中が無い場合はフィールドもボタンも表示しない                   |
| FR-02 | 開始時刻編集          | 新規フィールドの初期値はサーバー提供の startedAt。入力補助として今の時刻ボタンやショートカットを検討         | 保存後、タイマー表示と差分が即時更新される                         |
| FR-03 | 作業内容・タグ編集    | 既存の入力群と同じフォーム送信にまとめ、「作業中変更」ボタンで開始時刻・内容・タグを同時更新                 | 保存後、一覧や進行中表示が更新される                               |
| FR-04 | 保存 / キャンセル制御 | 「作業終了」「切り替え」に並べて「作業中変更」ボタンを追加。未保存の変更がある状態でカードを離脱する際は確認 | 保存処理中は「作業中変更」ボタンをローディング表示し二重送信を防止 |
| FR-05 | 更新履歴ヒント        | 最終更新時刻をパネル下に表示（`updatedAt`）し、変更が反映されたことを可視化                                  | 保存成功後に最新の serverNow を使用して更新                        |

## バリデーション / ルール

1. **開始時刻の下限**: 直前の完了済み作業 `previousEndedAt` より前には設定不可（重複防止）
2. **開始時刻の上限**: サーバー現在時刻 `serverNow` を超えてはならない。秒単位で比較
3. **補正幅の制限**: `serverNow` から過去24時間以内まで変更を許容（極端な補正を防止）。閾値は設定で調整可能
4. **タイムゾーン**: すべてUTCベースで保存し、UIではユーザーのローカルTZに変換
5. **作業内容**: 最大10,000文字、空文字可（既存ルール継承）
6. **タグ**: F-003の制約を継承（1〜100文字、最大20個、トリミング＋重複排除）
7. **同時編集**: 開いているユーザー以外が停止した場合は 409 を返し、最新状態で再描画
8. **監査**: 更新後は `updated_at` を自動更新し、操作ログ（userId, workLogId, changedFields）を残す（最低でもサーバーログ）

## UX / UI 要件

- 進行中カード内の既存フォームを拡張し、開始時刻フィールドと「作業中変更」ボタンをボタン行（作業終了/切り替えと同一行）にレイアウト
- 保存成功時: トーストで「進行中の作業を更新しました」+ 自動クローズ
- エラー時: フィールド下にエラー文 & トーストに概要
- キーボード操作: `Ctrl/Cmd + Enter` で「作業中変更」をトリガー、`Esc` で入力値を元に戻す確認を表示
- フォームの初期フォーカスは description、Tab で開始時刻→タグ→ボタンへ移動できるよう順序を調整
- モバイルではボタンを縦積みにし、開始時刻フィールドは OS 標準ピッカーを使用

## サーバーアクション / API

### 新規: `actions.adjustActive`

- **エンドポイント**: `/worklogs/active/adjust`
- **入力**:

```typescript
interface AdjustActiveInput {
	workLogId: string; // クライアントが保持する現在のアクティブログID
	startedAt: string; // ISO8601, UTC
	description: string;
	tags: string[];
	clientClockOffsetMs?: number; // 任意、警告用
}
```

- **レスポンス**:

```typescript
interface AdjustActiveSuccess {
	ok: true;
	workLog: {
		id: string;
		startedAt: string;
		description: string;
		tags: string[];
		updatedAt: string;
	};
	serverNow: string;
}
```

- **エラーレスポンス**: `reason` = `NO_ACTIVE`, `NOT_FOUND`, `VALIDATION_ERROR`, `CONFLICT_STOPPED`, `INTERNAL_ERROR`
- **振る舞い**:
  1.  認証済みユーザーで唯一のアクティブログを取得
  2.  入力バリデーション
  3.  DBトランザクションで `work_logs` と `work_log_tags` を同時更新
  4.  更新後のレコードと `serverNow` を返却

### load の拡張

- `active` オブジェクトに `editableFields` フラグと `previousEndedAt` を含め、クライアントでバリデーション境界を提示

## データモデル / ドメイン影響

- 既存テーブルを再利用。新規カラムは不要
- ドメインサービス `ActiveWorkLogService.adjust(params)` を追加し、時間整合性チェックを集約
- イベントログ（オプション）: `work_log_events` に `ADJUST_START`, `ADJUST_DESCRIPTION`, `ADJUST_TAGS` を記録可能（今回は任意）

## 状態・フロー

1. 進行中作業取得（load）
2. ユーザーが編集 → クライアント側でsoft-validation
3. 保存押下 → `actions.adjustActive`
4. 成功: store更新 → タイマー再計算（`serverNow - startedAt`）
5. 失敗: エラーを表示し、必要なら `load` で再同期

## エラーハンドリング / 通知

- バリデーションエラー: フィールドごと、`errors.startedAt` など
- 409/CONFLICT_STOPPED: トースト「作業が既に終了しました。最新の状態を取得してください」+ 自動リロード
- ネットワーク/500: リトライボタン付きトースト

## テスト観点

- startedAt を現在時刻より未来に設定 → 400
- previousEndedAt より前に設定 → 400
- 24時間超の過去日を設定 → 400
- description 文字数上限, tags 上限の検証
- 認証なしアクセス → 401
- 同時編集: 他端末で stop→ 本端末で adjust → 409
- 保存後に経過時間表示が補正されること（フロントユニットテスト）

## 未決定事項 / Open Questions

1. 24時間制限の具体値を設定ファイル化するか（環境変数?）
2. 調整履歴をユーザーに見せるか（監査ログUI）
3. 自動保存（フォーカスアウトで即保存）を採用するか。初回は明示保存のみで運用し、フィードバック後に検討

---

本仕様に基づき、次工程では docs/task に詳細タスクを作成し、TDD 方針（先テスト）で実装を進める。
