# タスク: F-005/F-006 作業一覧表示と絞り込み UI実装

作成日: 2025-10-25T11:30:00Z

## 目的

サーバー側で実装済みの一覧取得・月次集計機能をフロントエンドで表示する。

## 前提条件

- ✅ サーバー側実装完了（`+page.server.ts`）
  - `load`関数が`listData`をストリーミングで返却
  - `listData`には`{ items, hasNext, page, size, monthlyTotalSec }`が含まれる
- ✅ 既存UIコンポーネント
  - `WorkLogStatus`: 進行中作業の表示
  - `WorkLogToggleButton`: 開始/停止ボタン
  - `MessageAlert`: メッセージ表示

## スコープ

### MVP（このタスク）

1. **作業一覧テーブル**: 日付、開始時刻、終了時刻、作業時間を表示
2. **月次合計表示**: フッターに指定月の合計作業時間を表示
3. **ページネーション**: 前/次へページボタン
4. **ローディング状態**: ストリーミング中のスケルトン表示

### 非MVP（後続タスク）

- フィルタUI（日付選択、期間選択）
- タグ絞り込み（F-003後）
- クイックフィルタ（今日/今週/今月）
- 無限スクロール

## コンポーネント設計

### 新規コンポーネント

#### 1. `WorkLogList.svelte`

**役割**: 作業一覧テーブルの表示

**Props**:

```typescript
type Props = {
	items: Array<{
		id: string;
		startedAt: string; // ISO
		endedAt: string | null; // ISO
	}>;
	serverNow: string; // ISO（進行中の作業時間計算用）
};
```

**表示内容**:

- テーブル形式
  - ヘッダー: 日付 | 開始 | 終了 | 作業時間
  - データ行:
    - 日付: `YYYY-MM-DD` 形式（ローカルタイムゾーン）
    - 開始: `HH:mm` 形式
    - 終了: `HH:mm` または `—`（進行中）
    - 作業時間: `HH:mm` 形式または `—`（進行中）
- 進行中の作業は背景色を変える（例: `bg-blue-50`）
- レスポンシブ対応（モバイルではカード形式に変更）

**スタイル**:

- daisyUI の `table` クラスを使用
- `table-zebra` で行ごとの色分け
- `table-compact` でコンパクト表示

#### 2. `WorkLogListSkeleton.svelte`

**役割**: ローディング中のスケルトン表示

**Props**:

```typescript
type Props = {
	rows?: number; // デフォルト: 5
};
```

**表示内容**:

- テーブル構造は `WorkLogList` と同じ
- 各セルに `skeleton` アニメーションを表示

#### 3. `MonthlyTotal.svelte`

**役割**: 月次合計時間の表示

**Props**:

```typescript
type Props = {
	totalSec: number;
	month?: string; // YYYY-MM 形式。未指定の場合は「今月」
};
```

**表示内容**:

- `この月の合計: HH:mm` 形式
- 右寄せ、やや大きめのフォント
- daisyUI の `stat` コンポーネントを使用

#### 4. `Pagination.svelte`

**役割**: ページネーション

**Props**:

```typescript
type Props = {
	currentPage: number;
	hasNext: boolean;
	size: number;
};
```

**表示内容**:

- 前へボタン（`currentPage === 1` の場合は無効化）
- 現在ページ表示: `ページ N`
- 次へボタン（`hasNext === false` の場合は無効化）
- daisyUI の `btn-group` を使用

**動作**:

- ボタンクリックで `?page=N&size=M` にナビゲート

### 既存コンポーネント修正

#### `+page.svelte`

**変更点**:

1. `listData` の Await 処理を追加
2. 新規コンポーネントを配置
3. レイアウト調整

## 実装ステップ

### Step 1: ユーティリティ関数の実装

**ファイル**: `src/lib/utils/timeFormat.ts`

**目的**: 作業時間を HH:mm 形式にフォーマット

**関数**:

```typescript
/**
 * 秒数を HH:mm 形式にフォーマット
 * @param seconds 秒数
 * @returns HH:mm 形式の文字列（例: "01:30", "12:05"）
 */
export const formatDuration = (seconds: number): string;

/**
 * ISO文字列をローカル日付形式にフォーマット
 * @param isoString ISO8601形式の日時文字列
 * @returns YYYY-MM-DD 形式の文字列
 */
export const formatDate = (isoString: string): string;

/**
 * ISO文字列をローカル時刻形式にフォーマット
 * @param isoString ISO8601形式の日時文字列
 * @returns HH:mm 形式の文字列
 */
export const formatTime = (isoString: string): string;

/**
 * 開始時刻と終了時刻から作業時間（秒）を計算
 * @param startedAt 開始時刻（ISO）
 * @param endedAt 終了時刻（ISO）またはnull
 * @param serverNow サーバー時刻（ISO）- 進行中の場合に使用
 * @returns 作業時間（秒）またはnull（進行中の場合）
 */
export const calculateDuration = (
  startedAt: string,
  endedAt: string | null,
  serverNow: string
): number | null;
```

**テストケース**:

- `formatDuration(3661)` → `"01:01"`
- `formatDuration(0)` → `"00:00"`
- `formatDuration(86399)` → `"23:59"`
- `formatDate("2025-10-25T12:30:00.000Z")` → ローカル日付
- `formatTime("2025-10-25T12:30:00.000Z")` → ローカル時刻
- `calculateDuration(start, end, now)` → 秒数またはnull

### Step 2: WorkLogList コンポーネント

**ファイル**: `src/routes/_components/WorkLogList/WorkLogList.svelte`

**テストファイル**: `src/routes/_components/WorkLogList/WorkLogList.spec.ts`

**実装内容**:

- テーブル構造
- 各行のデータ表示
- 進行中作業のハイライト
- レスポンシブ対応

**合格基準**:

- アイテムが正しく表示される
- 進行中の作業が識別できる（`endedAt === null`）
- 空配列の場合は「データがありません」メッセージ
- アクセシビリティ（`scope="col"`、適切な`aria-label`）

### Step 3: WorkLogListSkeleton コンポーネント

**ファイル**: `src/routes/_components/WorkLogList/WorkLogListSkeleton.svelte`

**実装内容**:

- テーブル構造（WorkLogListと同じ）
- スケルトンアニメーション

**合格基準**:

- 指定した行数のスケルトンが表示される
- アニメーションが適切に動作する

### Step 4: MonthlyTotal コンポーネント

**ファイル**: `src/routes/_components/MonthlyTotal/MonthlyTotal.svelte`

**テストファイル**: `src/routes/_components/MonthlyTotal/MonthlyTotal.spec.ts`

**実装内容**:

- 合計時間の表示
- 月の表示（指定あり/なし）

**合格基準**:

- 秒数が HH:mm 形式で表示される
- 月が指定されている場合は「YYYY年MM月の合計」
- 月が未指定の場合は「今月の合計」

### Step 5: Pagination コンポーネント

**ファイル**: `src/routes/_components/Pagination/Pagination.svelte`

**テストファイル**: `src/routes/_components/Pagination/Pagination.spec.ts`

**実装内容**:

- 前へボタン
- 現在ページ表示
- 次へボタン
- ボタンの有効/無効切り替え

**合格基準**:

- `currentPage === 1` の場合、前へボタンが無効
- `hasNext === false` の場合、次へボタンが無効
- ボタンクリックで正しいURLにナビゲート
- キーボード操作可能

### Step 6: +page.svelte の修正

**ファイル**: `src/routes/+page.svelte`

**変更内容**:

1. 新規コンポーネントのインポート
2. `{#await data.listData}` ブロックの追加
3. レイアウト調整

**実装例**:

```svelte
<script lang="ts">
	import WorkLogList from './_components/WorkLogList/WorkLogList.svelte';
	import WorkLogListSkeleton from './_components/WorkLogList/WorkLogListSkeleton.svelte';
	import MonthlyTotal from './_components/MonthlyTotal/MonthlyTotal.svelte';
	import Pagination from './_components/Pagination/Pagination.svelte';
	// ... 既存のインポート
</script>

<!-- 既存のWorkLogStatusとToggleButton -->

<!-- 作業一覧セクション -->
<div class="card mb-8 border border-neutral-300 bg-base-100">
	<div class="card-body">
		<h2 class="card-title">作業履歴</h2>

		{#await data.listData}
			<!-- ローディング中 -->
			<WorkLogListSkeleton rows={5} />
		{:then listData}
			<!-- データ表示 -->
			<WorkLogList items={listData.items} serverNow={currentServerNow} />

			<!-- フッター: 月次合計とページネーション -->
			<div class="mt-4 card-actions items-center justify-between">
				<MonthlyTotal totalSec={listData.monthlyTotalSec} />
				<Pagination currentPage={listData.page} hasNext={listData.hasNext} size={listData.size} />
			</div>
		{:catch error}
			<!-- エラー表示 -->
			<div class="alert alert-error">
				<span>データの読み込みに失敗しました</span>
			</div>
		{/await}
	</div>
</div>
```

**合格基準**:

- ストリーミング中はスケルトンが表示される
- データ取得後は一覧が表示される
- エラー時は適切なメッセージが表示される
- レイアウトが崩れない

### Step 7: 統合テスト

**ファイル**: `src/routes/page.svelte.spec.ts`（既存ファイルに追加）

**テストケース**:

1. 一覧が正しく表示される
2. ページネーションが機能する
3. 月次合計が表示される
4. ローディング状態が適切に処理される

## データフロー

```
+page.server.ts (load)
  ↓ streaming
  ↓ Promise<ListData>
  ↓
+page.svelte
  ↓ {#await}
  ↓
WorkLogList + MonthlyTotal + Pagination
```

## スタイルガイド

- **コンポーネント**: daisyUI のクラスを使用
- **テーブル**: `table table-zebra table-compact`
- **カード**: `card bg-base-100 border`
- **ボタン**: `btn btn-primary` / `btn-disabled`
- **統計**: `stat`
- **レスポンシブ**: Tailwind の `md:`, `lg:` プレフィックス

## 型定義

```typescript
// +page.svelte で使用する型
type ListData = {
	items: Array<{
		id: string;
		startedAt: string;
		endedAt: string | null;
	}>;
	page: number;
	size: number;
	hasNext: boolean;
	monthlyTotalSec: number;
};
```

## コミット戦略

各ステップごとにコミット:

1. `feat(utils): add time format utilities`
2. `feat(ui): add WorkLogList component`
3. `feat(ui): add WorkLogListSkeleton component`
4. `feat(ui): add MonthlyTotal component`
5. `feat(ui): add Pagination component`
6. `feat(ui): integrate list components into main page`
7. `test(ui): add integration tests for list view`

## 次のステップ

このタスク完了後:

- フィルタUI（日付選択、期間選択）の実装
- タグ絞り込み（F-003実装後）
- 作業編集機能（F-004）
