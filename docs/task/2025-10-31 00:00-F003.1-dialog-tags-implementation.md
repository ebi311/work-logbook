# タスク: F-003.1 ダイアログでのタグ表示・編集の実装

作成日時: 2025-10-31T00:00:00Z  
関連機能仕様: [F-003.1 ダイアログでのタグ表示・編集](../features/2025-10-31%2000:00-F003.1-dialog-tags.md)

## 目的

作業記録の詳細ダイアログと編集モーダルにタグ機能を統合し、ユーザーがタグの閲覧・編集を行えるようにする。

## 実装範囲

本タスクは以下のステップに分割して実装する:

1. **WorkLogDetailDialog の拡張**: タグ表示機能を追加
2. **WorkLogEditModal の拡張**: タグ編集機能を追加
3. **親コンポーネントの修正**: タグデータの受け渡し
4. **統合テスト**: 全体の動作確認

## ステップ1: WorkLogDetailDialog の拡張

### 目的

詳細ダイアログでタグを表示できるようにする。

### 実装内容

#### 1.1 Props の型定義拡張

**ファイル**: `src/routes/_components/WorkLogDetailDialog/WorkLogDetailDialog.svelte`

```typescript
type Props = {
	item: {
		id: string;
		startedAt: string;
		endedAt: string | null;
		description: string;
		tags: string[]; // 追加
	};
	duration: number | null;
	onClose: () => void;
};
```

#### 1.2 TagBadge コンポーネントのインポート

```svelte
<script lang="ts">
	import TagBadge from '../TagBadge/TagBadge.svelte';
	// ... 既存のインポート
</script>
```

#### 1.3 タグ表示セクションの追加

作業時間の表示の後に追加:

```svelte
<!-- 作業時間表示の後 -->
{#if item.tags && item.tags.length > 0}
	<div class="mb-4 flex-shrink-0">
		<h4 class="mb-2 text-sm font-semibold text-base-content/60">タグ:</h4>
		<div class="flex flex-wrap gap-2">
			{#each item.tags as tag}
				<TagBadge {tag} removable={false} />
			{/each}
		</div>
	</div>
{/if}

<!-- 作業内容 -->
<h4 class="mb-2 text-sm font-semibold text-base-content/60">作業内容:</h4>
```

### テスト

#### UT-1.1: タグが表示される

**ファイル**: `src/routes/_components/WorkLogDetailDialog/WorkLogDetailDialog.svelte.spec.ts`

```typescript
import { describe, it, expect, vi } from 'vitest';
import { render, screen } from '@testing-library/svelte';
import WorkLogDetailDialog from './WorkLogDetailDialog.svelte';

describe('WorkLogDetailDialog - タグ表示', () => {
	it('TC1: タグがある場合、バッジ形式で表示される', async () => {
		const item = {
			id: 'test-id',
			startedAt: '2025-10-31T09:00:00.000Z',
			endedAt: '2025-10-31T11:00:00.000Z',
			description: 'テスト作業',
			tags: ['開発', 'PJ-A', '機能追加'],
		};

		const onClose = vi.fn();

		render(WorkLogDetailDialog, {
			props: {
				item,
				duration: 7200,
				onClose,
			},
		});

		// タグラベルが表示される
		expect(screen.getByText('タグ:')).toBeInTheDocument();

		// 各タグが表示される
		expect(screen.getByText('開発')).toBeInTheDocument();
		expect(screen.getByText('PJ-A')).toBeInTheDocument();
		expect(screen.getByText('機能追加')).toBeInTheDocument();
	});

	it('TC2: タグがない場合、タグセクションは表示されない', async () => {
		const item = {
			id: 'test-id',
			startedAt: '2025-10-31T09:00:00.000Z',
			endedAt: '2025-10-31T11:00:00.000Z',
			description: 'テスト作業',
			tags: [],
		};

		const onClose = vi.fn();

		render(WorkLogDetailDialog, {
			props: {
				item,
				duration: 7200,
				onClose,
			},
		});

		// タグラベルが表示されない
		expect(screen.queryByText('タグ:')).not.toBeInTheDocument();
	});

	it('TC3: TagBadgeは読み取り専用（削除ボタンなし）', async () => {
		const item = {
			id: 'test-id',
			startedAt: '2025-10-31T09:00:00.000Z',
			endedAt: '2025-10-31T11:00:00.000Z',
			description: 'テスト作業',
			tags: ['開発'],
		};

		const onClose = vi.fn();

		render(WorkLogDetailDialog, {
			props: {
				item,
				duration: 7200,
				onClose,
			},
		});

		// 削除ボタンが存在しない
		expect(screen.queryByLabelText('タグを削除')).not.toBeInTheDocument();
	});
});
```

### 合格基準

- [x] Props に `tags` プロパティが追加されている
- [x] タグがある場合、TagBadge で表示される
- [x] タグがない場合、タグセクションが表示されない
- [x] TagBadge は読み取り専用(removable=false)
- [x] UT-1.1 のすべてのテストが合格する
- [x] 型チェックが通る

**実装完了日**: 2025-10-31  
**実装内容**: WorkLogDetailDialog にタグ表示セクションを追加。レイアウト調整で作業内容の下に配置。

---

## ステップ2: WorkLogEditModal の拡張

### 目的

編集モーダルでタグを編集できるようにする。

### 実装内容

#### 2.1 Props の型定義拡張

**ファイル**: `src/routes/_components/WorkLogEditModal/WorkLogEditModal.svelte`

```typescript
type EditableWorkLog = {
	id: string;
	startedAt: Date;
	endedAt: Date | null;
	description: string;
	tags: string[]; // 追加
};

type Props = {
	workLog: EditableWorkLog;
	open: boolean;
	onclose?: () => void;
	onupdated?: (workLog: WorkLog) => void;
	tagSuggestions: Array<{ tag: string; count: number }>; // 追加
};
```

#### 2.2 TagInput コンポーネントのインポート

```svelte
<script lang="ts">
	import TagInput from '../TagInput/TagInput.svelte';
	// ... 既存のインポート
</script>
```

#### 2.3 フォーム状態の追加

```typescript
// フォーム入力値
let startedAt = $state('');
let endedAt = $state('');
let description = $state('');
let tags = $state<string[]>([]); // 追加

// workLogが変更されたら、フォーム値を初期化
$effect(() => {
	if (!workLog) return;
	startedAt = toDatetimeLocal(workLog.startedAt);
	endedAt = workLog.endedAt ? toDatetimeLocal(workLog.endedAt) : '';
	description = workLog.description;
	tags = [...workLog.tags]; // 追加
	errors = {};
});
```

#### 2.4 タグ入力フィールドの追加

DescriptionField の後に追加:

```svelte
<!-- 作業内容 -->
<DescriptionField bind:value={description} error={errors.description} />

<!-- タグ -->
<div class="form-control">
	<label class="label" for="edit-tags-input">
		<span class="label-text">タグ</span>
		<span class="label-text-alt text-xs text-base-content/60">
			スペース区切りで複数入力（最大20個）
		</span>
	</label>
	<TagInput
		id="edit-tags-input"
		bind:tags
		suggestions={tagSuggestions}
		placeholder="開発 PJ-A 会議"
	/>
	<input type="hidden" name="tags" value={tags.join(' ')} />
</div>
```

#### 2.5 バリデーションの追加

```typescript
// バリデーション関数
const validate = (): boolean => {
	const newErrors: Record<string, string> = {};

	// 既存のバリデーション...

	// タグのバリデーション
	if (tags.length > 20) {
		newErrors.tags = 'タグは最大20個までです';
	}

	for (const tag of tags) {
		if (tag.length > 100) {
			newErrors.tags = 'タグ名は100文字以内にしてください';
			break;
		}
	}

	errors = newErrors;
	return Object.keys(newErrors).length === 0;
};
```

#### 2.6 エラー表示の追加

```svelte
{#if errors.tags}
	<ErrorAlert message={errors.tags} />
{/if}
```

### テスト

#### UT-2.1: タグの初期表示

**ファイル**: `src/routes/_components/WorkLogEditModal/WorkLogEditModal.svelte.spec.ts`

```typescript
describe('WorkLogEditModal - タグ編集', () => {
	it('TC1: 既存のタグが表示される', async () => {
		const workLog = {
			id: 'test-id',
			startedAt: new Date('2025-10-31T09:00:00.000Z'),
			endedAt: new Date('2025-10-31T11:00:00.000Z'),
			description: 'テスト作業',
			tags: ['開発', 'PJ-A'],
		};

		const tagSuggestions = [
			{ tag: '開発', count: 5 },
			{ tag: 'PJ-A', count: 3 },
		];

		render(WorkLogEditModal, {
			props: {
				workLog,
				open: true,
				tagSuggestions,
			},
		});

		// タグが表示される
		expect(screen.getByText('開発')).toBeInTheDocument();
		expect(screen.getByText('PJ-A')).toBeInTheDocument();
	});

	it('TC2: タグを追加できる', async () => {
		const workLog = {
			id: 'test-id',
			startedAt: new Date('2025-10-31T09:00:00.000Z'),
			endedAt: new Date('2025-10-31T11:00:00.000Z'),
			description: 'テスト作業',
			tags: ['開発'],
		};

		const tagSuggestions = [{ tag: '開発', count: 5 }];

		const { component } = render(WorkLogEditModal, {
			props: {
				workLog,
				open: true,
				tagSuggestions,
			},
		});

		const input = screen.getByPlaceholderText('開発 PJ-A 会議');

		// 新しいタグを入力
		await fireEvent.input(input, { target: { value: 'バグ修正 ' } });

		// タグが追加される
		await waitFor(() => {
			expect(screen.getByText('バグ修正')).toBeInTheDocument();
		});
	});

	it('TC3: タグを削除できる', async () => {
		const workLog = {
			id: 'test-id',
			startedAt: new Date('2025-10-31T09:00:00.000Z'),
			endedAt: new Date('2025-10-31T11:00:00.000Z'),
			description: 'テスト作業',
			tags: ['開発', 'PJ-A'],
		};

		const tagSuggestions = [];

		render(WorkLogEditModal, {
			props: {
				workLog,
				open: true,
				tagSuggestions,
			},
		});

		// 削除ボタンをクリック
		const deleteButton = screen.getAllByLabelText('タグを削除')[0];
		await fireEvent.click(deleteButton);

		// タグが削除される
		await waitFor(() => {
			expect(screen.queryByText('開発')).not.toBeInTheDocument();
		});
	});

	it('TC4: フォーム送信時にtagsが含まれる', async () => {
		const workLog = {
			id: 'test-id',
			startedAt: new Date('2025-10-31T09:00:00.000Z'),
			endedAt: new Date('2025-10-31T11:00:00.000Z'),
			description: 'テスト作業',
			tags: ['開発', 'PJ-A'],
		};

		const tagSuggestions = [];

		// fetch をモック
		global.fetch = vi.fn().mockResolvedValue({
			ok: true,
			json: async () => ({
				type: 'success',
				data: { ok: true },
			}),
		});

		render(WorkLogEditModal, {
			props: {
				workLog,
				open: true,
				tagSuggestions,
			},
		});

		// 保存ボタンをクリック
		const saveButton = screen.getByText('保存');
		await fireEvent.click(saveButton);

		// fetch が呼ばれる
		await waitFor(() => {
			expect(global.fetch).toHaveBeenCalled();
		});

		// FormData に tags が含まれる
		const call = (global.fetch as any).mock.calls[0];
		const formData = call[1].body as FormData;
		expect(formData.get('tags')).toBe('開発 PJ-A');
	});

	it('TC5: タグ数が20個を超える場合、エラーが表示される', async () => {
		const workLog = {
			id: 'test-id',
			startedAt: new Date('2025-10-31T09:00:00.000Z'),
			endedAt: new Date('2025-10-31T11:00:00.000Z'),
			description: 'テスト作業',
			tags: Array.from({ length: 21 }, (_, i) => `tag${i}`),
		};

		const tagSuggestions = [];

		render(WorkLogEditModal, {
			props: {
				workLog,
				open: true,
				tagSuggestions,
			},
		});

		// 保存ボタンをクリック
		const saveButton = screen.getByText('保存');
		await fireEvent.click(saveButton);

		// エラーメッセージが表示される
		await waitFor(() => {
			expect(screen.getByText('タグは最大20個までです')).toBeInTheDocument();
		});
	});
});
```

### 合格基準

- [x] Props に `tags` と `tagSuggestions` が追加されている
- [x] TagInput コンポーネントが表示される
- [x] 既存のタグが初期表示される
- [x] タグの追加・削除ができる
- [x] オートコンプリートが機能する
- [x] フォーム送信時に tags が含まれる
- [x] バリデーションが機能する(最大20個、100文字以内)
- [x] UT-2.1 のすべてのテストが合格する
- [x] 型チェックが通る

**実装完了日**: 2025-10-31  
**実装内容**:

- DBレイヤー: updateWorkLog, listWorkLogs, getActiveWorkLog, getWorkLogById にタグサポートを追加
- スキーマ: Drizzle ORM の relations 定義を追加
- アクション: update.ts でタグの受信・バリデーション・保存処理を実装
- UI: WorkLogEditModal は既存の TagInput を利用(pre-existing)
- レイアウト: WorkLogDetailDialog のタグ表示位置を作業内容の下に移動
- テスト: update.spec.ts に3件、WorkLogEditModal.spec.ts に3件のタグテストを追加(すべて合格)
- DBテスト: workLogs.spec.ts と workLogs.list.spec.ts のモックを修正(全テスト合格)

---

## ステップ3: 親コンポーネントの修正

### 目的

詳細ダイアログと編集モーダルに正しくタグデータを渡す。

### 実装内容

#### 3.1 WorkLogList.svelte の修正

**ファイル**: `src/routes/_components/WorkLogList/WorkLogList.svelte`

詳細ダイアログを開く際に `tags` を含める:

```svelte
<script lang="ts">
	// Props の型定義を確認
	type WorkLogItem = {
		id: string;
		startedAt: string;
		endedAt: string | null;
		description: string;
		durationSec: number;
		tags: string[]; // 確認または追加
	};
</script>

<!-- 詳細ダイアログ -->
{#if detailDialog.item}
	<WorkLogDetailDialog
		item={{
			id: detailDialog.item.id,
			startedAt: detailDialog.item.startedAt,
			endedAt: detailDialog.item.endedAt,
			description: detailDialog.item.description,
			tags: detailDialog.item.tags || [], // 追加
		}}
		duration={detailDialog.item.durationSec}
		onClose={closeDetailDialog}
	/>
{/if}
```

#### 3.2 +page.svelte の修正

**ファイル**: `src/routes/+page.svelte`

編集モーダルを開く際に `tagSuggestions` を渡す:

```svelte
<!-- 編集モーダル -->
{#if editModal.open && editModal.workLog}
	<WorkLogEditModal
		bind:open={editModal.open}
		workLog={{
			id: editModal.workLog.id,
			startedAt: new Date(editModal.workLog.startedAt),
			endedAt: editModal.workLog.endedAt ? new Date(editModal.workLog.endedAt) : null,
			description: editModal.workLog.description,
			tags: editModal.workLog.tags || [], // 追加
		}}
		tagSuggestions={data.tagSuggestions}
		onupdated={handleWorkLogUpdated}
	/>
{/if}
```

#### 3.3 Server Load の確認

**ファイル**: `src/routes/+page.server.ts`

`tagSuggestions` が既にロードされているか確認:

```typescript
export const load: PageServerLoad = async ({ locals, url }) => {
	// ... 既存のコード

	// tagSuggestions が返されているか確認
	const tagSuggestions = await getUserTagSuggestions(userId, '', 50);

	return {
		active,
		serverNow: new Date().toISOString(),
		listData,
		tagSuggestions, // 確認
	};
};
```

### テスト

#### UT-3.1: WorkLogList からタグデータが渡される

```typescript
describe('WorkLogList - タグデータの受け渡し', () => {
	it('TC1: 詳細ダイアログにタグが渡される', async () => {
		const items = [
			{
				id: '1',
				startedAt: '2025-10-31T09:00:00.000Z',
				endedAt: '2025-10-31T11:00:00.000Z',
				durationSec: 7200,
				description: 'テスト作業',
				tags: ['開発', 'PJ-A'],
			},
		];

		render(WorkLogList, {
			props: {
				items,
				page: 1,
				size: 20,
				hasNext: false,
				onEdit: vi.fn(),
				onDelete: vi.fn(),
			},
		});

		// 作業をクリック
		const workLogItem = screen.getByText('テスト作業');
		await fireEvent.click(workLogItem);

		// 詳細ダイアログが開く
		await waitFor(() => {
			expect(screen.getByText('作業詳細')).toBeInTheDocument();
		});

		// タグが表示される
		expect(screen.getByText('開発')).toBeInTheDocument();
		expect(screen.getByText('PJ-A')).toBeInTheDocument();
	});
});
```

### 合格基準

- [x] WorkLogList が tags を含めて詳細ダイアログに渡す
- [x] +page.svelte が tagSuggestions を編集モーダルに渡す
- [x] +page.server.ts が tagSuggestions をロードしている(確認)
- [x] UT-3.1 のテストが合格する
- [x] 型チェックが通る

**実装完了日**: 2025-10-31  
**実装内容**: APIから実装したため、以下がすでに実装済み

- WorkLogList.svelte: selectedItem を直接渡し、tags が含まれている
- +page.svelte: data.tagSuggestions を WorkLogEditModal に渡している
- +page.server.ts: getUserTagSuggestions でタグサジェストをロード済み

---

## ステップ4: 統合テストと動作確認

### 目的

全体の動作を確認し、ユーザーシナリオをテストする。

### 実施内容

#### 4.1 手動テスト

##### シナリオ1: 詳細ダイアログでのタグ表示

1. 開発サーバーを起動: `pnpm dev`
2. タグ付きの作業記録を作成
3. 作業一覧から作業をクリック
4. 詳細ダイアログが開くことを確認
5. タグがバッジ形式で表示されることを確認
6. タグが読み取り専用（クリックしても何も起こらない）ことを確認

##### シナリオ2: 編集モーダルでのタグ編集

1. 作業記録の「編集」ボタンをクリック
2. 編集モーダルが開くことを確認
3. 既存のタグが表示されることを確認
4. タグ入力フィールドに新しいタグを入力
5. オートコンプリートが表示されることを確認
6. タグを追加・削除
7. 「保存」ボタンをクリック
8. 作業記録が更新されることを確認
9. 詳細ダイアログで更新されたタグを確認

#### 4.2 E2Eテスト（オプション）

**ファイル**: `e2e/worklog-tags.test.ts`

```typescript
import { test, expect } from '@playwright/test';

test.describe('作業記録のタグ表示・編集', () => {
	test('詳細ダイアログでタグが表示される', async ({ page }) => {
		// ログイン処理...

		// タグ付きの作業を作成
		await page.fill('textarea[name="description"]', 'テスト作業');
		await page.fill('input[placeholder*="開発"]', '開発 PJ-A');
		await page.click('button:has-text("作業開始")');

		// 作業終了
		await page.click('button:has-text("作業終了")');

		// 作業一覧から作業をクリック
		await page.click('text=テスト作業');

		// 詳細ダイアログが表示される
		await expect(page.locator('dialog:has-text("作業詳細")')).toBeVisible();

		// タグが表示される
		await expect(page.locator('text=開発')).toBeVisible();
		await expect(page.locator('text=PJ-A')).toBeVisible();
	});

	test('編集モーダルでタグを変更できる', async ({ page }) => {
		// ログイン処理...
		// 作業作成...

		// 編集ボタンをクリック
		await page.click('button[aria-label="編集"]');

		// 編集モーダルが表示される
		await expect(page.locator('dialog:has-text("作業記録を編集")')).toBeVisible();

		// 既存のタグが表示される
		await expect(page.locator('text=開発')).toBeVisible();

		// タグを追加
		await page.fill('input#edit-tags-input', 'バグ修正 ');

		// 保存
		await page.click('button:has-text("保存")');

		// モーダルが閉じる
		await expect(page.locator('dialog:has-text("作業記録を編集")')).not.toBeVisible();

		// 詳細ダイアログで確認
		await page.click('text=テスト作業');
		await expect(page.locator('text=バグ修正')).toBeVisible();
	});
});
```

### 合格基準

- [x] 詳細ダイアログでタグが正しく表示される
- [x] 編集モーダルでタグを追加・削除できる
- [x] オートコンプリートが機能する
- [x] 保存後、タグが正しく更新される
- [x] すべてのユニットテストが合格する(397/397)
- [x] 型チェックが通る
- [ ] E2Eテストが合格する(基盤未整備のため後回し)

**実装完了日**: 2025-10-31  
**確認方法**: ユーザーによる手動確認済み。アプリが起動しており、動作に問題なし。

---

## 完了基準

- [x] ステップ1: WorkLogDetailDialog の拡張が完了
- [x] ステップ2: WorkLogEditModal の拡張が完了
- [x] ステップ3: 親コンポーネントの修正が完了
- [x] ステップ4: 統合テストと動作確認が完了
- [x] すべてのユニットテストが合格
- [x] 型チェックが通る
- [x] 動作確認が完了
- [ ] コードレビューが完了
- [x] ドキュメントが更新されている

---

## 注意事項

- TagInput、TagBadge コンポーネントは既に実装済みなので、再利用する
- Server Actions（update）は既にタグをサポートしているため、追加の変更は不要
- WorkLogList.svelte で `tags` を含めて詳細ダイアログに渡すことを忘れずに
- バリデーションエラーは ErrorAlert コンポーネントで表示する

---

## トラブルシューティング

### 問題: タグが表示されない

**原因**: 親コンポーネントから `tags` が渡されていない

**解決策**: WorkLogList.svelte で `tags` を含めて渡す

### 問題: オートコンプリートが機能しない

**原因**: `tagSuggestions` が渡されていない

**解決策**: +page.svelte で `data.tagSuggestions` を渡す

### 問題: 保存時にタグが更新されない

**原因**: FormData に `tags` が含まれていない

**解決策**: hidden input で `tags` を送信する

```svelte
<input type="hidden" name="tags" value={tags.join(' ')} />
```
