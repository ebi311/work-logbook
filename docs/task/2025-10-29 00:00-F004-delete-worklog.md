# F-004: Phase 2 - 削除機能（作業記録の削除）

**タスクID**: F004-DELETE  
**作成日**: 2025-10-29 00:00  
**関連機能**: [F-004: 作業記録の編集・削除](../features/2025-10-27%2012:00-F004-edit-delete-worklog.md)

## 目的

完了した作業記録の削除機能を実装する。ユーザーが不要な作業記録を削除できるようにする。

## 前提条件

- F-001「作業開始・終了」が実装済み
- F-005「作業一覧の表示」が実装済み
- F-004 Phase 1「編集機能」が実装済み
- 進行中の作業（`endedAt` が `null`）は削除対象外

## 実装範囲

### 1. Server Actions（削除処理）

**ファイル:** `src/routes/+page.server.ts`

- `actions.delete`: 作業記録の削除処理
- 認証チェック
- 権限チェック（自分の作業記録のみ）
- 完了した作業のみ削除可能（進行中の作業は削除不可）
- データベースからの物理削除（MVP段階）

### 2. UIコンポーネント

**作業一覧への削除ボタン追加:**

- 完了した作業のみに削除ボタンを表示
- ボタンクリック時、ブラウザ標準の `window.confirm()` で確認
- 編集ボタンと並べて配置
- アイコン: ゴミ箱アイコン
- 色: error/危険色

### 3. UI/UXの考慮事項

- **誤操作防止**: ブラウザ標準の確認ダイアログで再確認
  - メッセージ: "この作業記録を削除してもよろしいですか？\n\nこの操作は取り消せません。"
- **視認性**: 削除ボタンは危険な操作であることを示す色（例: error色）を使用
- **操作の取り消し不可**: 確認ダイアログで明示
- **シンプルさ**: ブラウザ標準UIで実装が簡単、動作が軽快、キーボード操作（Enter/Esc）が標準対応
- **将来の拡張**: より詳細な情報を表示したい場合は、カスタムモーダルに置き換えることも検討

## API仕様

### actions.delete

**パス**: `/` (メインページのフォームアクション、`?/delete`)

#### 入力

```typescript
{
	id: number;
}
```

#### 出力（成功時）

```typescript
{
	ok: true;
	deletedId: number;
	serverNow: string; // ISO 8601形式
}
```

#### 出力（失敗時）

```typescript
{
	ok: false;
	reason: 'UNAUTHORIZED' | 'NOT_FOUND' | 'FORBIDDEN' | 'INTERNAL_ERROR';
	message: string;
	serverNow: string;
}
```

### エラー理由の詳細

| reason         | 説明                                     | HTTPステータス |
| -------------- | ---------------------------------------- | -------------- |
| UNAUTHORIZED   | ログインしていない                       | 401            |
| NOT_FOUND      | 指定されたIDの作業記録が存在しない       | 404            |
| FORBIDDEN      | 他のユーザーの作業記録を削除しようとした | 403            |
| INTERNAL_ERROR | データベースエラーなど予期しないエラー   | 500            |

**注**: 機能仕様書では進行中の作業を削除不可としていますが、完了した作業のみに削除ボタンを表示することで、UI側で制御します。サーバー側では追加の状態チェックは行いません（削除ボタンが表示される = 完了した作業）。

### 処理フロー

1. 認証チェック: `locals.user`が無い場合は401エラー
2. フォームデータから `id` を取得
3. 作業記録をDBから取得
4. 作業記録が見つからない場合、404エラーを返却
5. 権限チェック: 作業記録の`userId`と現在のユーザーが一致するか確認
6. 不一致の場合、403エラーを返却
7. データベースから物理削除: `DELETE FROM work_logs WHERE id = ? AND user_id = ?`
8. 成功レスポンスを返却

**注**: 完了した作業のみに削除ボタンが表示されるため、サーバー側での状態チェック（`endedAt` が `null` かどうか）は不要です。

## 実装ステップ

### Step 1: Server Actions - 削除処理の実装

**ファイル:** `src/routes/+page.server.ts`, `src/routes/page.server.spec.ts`

#### 実装内容

1. `actions.delete` の実装
   - 認証チェック
   - 作業記録の取得
   - 権限チェック
   - 状態チェック（進行中でないこと）
   - データベースから削除
   - レスポンス返却

#### テストケース

**TC1: 削除 - 正常系**

- 完了した自分の作業記録を削除できる
- 削除後、DBから作業記録が消えている
- 成功レスポンスが返却される
- `deletedId` が正しい

**TC2: 削除 - 認証エラー**

- ログインしていない場合、401エラー
- reason が `UNAUTHORIZED`
- データベースに変更がない

**TC3: 削除 - 存在しないID**

- 存在しないIDを指定した場合、404エラー
- reason が `NOT_FOUND`
- エラーメッセージが適切

**TC4: 削除 - 権限エラー**

- 他のユーザーの作業記録を削除しようとした場合、403エラー
- reason が `FORBIDDEN`
- データベースに変更がない

**注**: 機能仕様書に基づき、進行中の作業の削除テストは削除しました。UI側で削除ボタンを表示しない制御を行うため、サーバー側での状態チェックは不要です。

#### 合格基準

- [ ] すべてのテストがパスすること
- [ ] TypeScriptの型エラーがないこと
- [ ] 適切なHTTPステータスコードが返却されること
- [ ] エラーハンドリングが適切に実装されていること

---

### Step 2: UI実装 - 削除ボタンとブラウザ標準の確認ダイアログ

**ファイル:**

- `src/routes/+page.svelte`
- `src/routes/page.svelte.spec.ts`

**注**: 機能仕様書に基づき、ブラウザ標準の `window.confirm()` を使用します。カスタムモーダルコンポーネントは作成しません。

#### 実装内容

1. 作業一覧に削除ボタンを追加
   - 完了した作業（`endedAt !== null`）のみに表示
   - 編集ボタンの隣に配置
   - アイコン: ゴミ箱アイコン
   - 色: error/危険色（daisyUIの `btn-error` など）
   - クリック時: ブラウザ標準の確認ダイアログを表示

2. 削除処理の実装
   - `window.confirm()` で確認
     - メッセージ: "この作業記録を削除してもよろしいですか？\n\nこの操作は取り消せません。"
     - ユーザーが「OK」をクリックした場合のみ、削除アクションを実行
   - `use:enhance` で削除アクションを実行
   - 削除成功時:
     - 作業一覧を再読み込み（またはリストから削除）
     - 成功メッセージを表示（トースト通知、オプション）
   - 削除失敗時:
     - エラーメッセージを表示（トースト通知）

3. レスポンシブ対応
   - 削除中は削除ボタンを無効化
   - ローディング表示（オプション）

#### ブラウザ標準の確認ダイアログのメリット

- 実装が簡単で高速
- ネイティブUIで動作が軽快
- キーボード操作（Enter/Esc）が標準で対応済み
- アクセシビリティ対応が不要（OSレベルで自動対応）

#### テストケース

**TC1: 削除ボタンの表示**

- 完了した作業に削除ボタンが表示される
- 進行中の作業には削除ボタンが表示されない

**TC2: 削除確認ダイアログ**

- 削除ボタンをクリックすると、`window.confirm()` が呼ばれる
- 確認メッセージが適切

**TC3: 削除処理 - 正常系（OKをクリック）**

- ユーザーがOKをクリックすると、削除アクションが実行される
- 削除成功後、作業一覧から削除された作業が消える

**TC4: 削除処理 - キャンセル**

- ユーザーがキャンセルをクリックすると、削除処理は実行されない
- 作業一覧に変更がない

**TC5: 削除処理 - エラー**

- 削除失敗時、エラーメッセージが表示される

**注**: `window.confirm()` のモックが必要です。Vitestで `vi.spyOn(window, 'confirm')` を使用します。

---

## 全体の合格基準

- [ ] すべてのステップの合格基準を満たしていること
- [ ] `pnpm test:unit` がすべてパスすること
- [ ] TypeScriptのビルドエラーがないこと
- [ ] ブラウザでの手動テストで、以下が正常に動作すること:
  - [ ] 完了した作業の削除ボタンが表示される
  - [ ] 進行中の作業には削除ボタンが表示されない
  - [ ] 削除ボタンをクリックすると確認ダイアログが表示される
  - [ ] ダイアログで「OK」をクリックすると作業が削除される
  - [ ] ダイアログで「キャンセル」をクリックすると削除されない
  - [ ] 削除後、作業一覧が更新される
  - [ ] 他のユーザーの作業は削除できない（権限エラー）

---

## 実装後のチェックリスト

- [ ] Step 1: Server Actions - 削除処理の実装
- [ ] Step 2: UI実装 - 削除ボタンとブラウザ標準の確認ダイアログ
- [ ] すべてのユニットテストが通過
- [ ] ブラウザでの動作確認
- [ ] コードレビュー
- [ ] Git コミット & プッシュ

---

## 将来的な拡張（オプション）

機能仕様書に記載されている将来的な拡張:

- **カスタム削除ダイアログ**: 作業内容の要約を表示するカスタムモーダル
  - より詳細な情報（日付、時間範囲、作業内容の一部）を表示
  - ただし、MVP段階ではブラウザ標準で十分
- **論理削除**: `deleted_at` フラグによる論理削除と復元機能
- **一括操作**: 複数の作業記録を選択して一括削除
- **変更履歴**: 削除された作業記録の履歴を記録

---

## 参考

- [F-004: 作業記録の編集・削除](../features/2025-10-27%2012:00-F004-edit-delete-worklog.md)
- [F-004: Phase 1 - 編集機能](./2025-10-27%2014:00-F004-edit-worklog.md)
