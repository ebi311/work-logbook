# タスク: F-001 作業記録データモデル実装

作成日時: 2025-10-19T13:00:00Z  
関連機能仕様: [F-001 作業開始・終了](../features/2025-10-19%2012:51-F001-start-stop.md)

## 目的

F-001「作業開始・終了」機能のデータモデル層を実装する。

- Drizzle ORM によるスキーマ定義
- PostgreSQL マイグレーション
- DB アクセス関数（CRUD + ビジネスロジック）
- テストコード（TDD）

## 実装範囲

### 対象

- `work_logs` テーブルのスキーマ定義とマイグレーション
- DBアクセス関数: `getActiveWorkLog`, `createWorkLog`, `stopWorkLog`
- 型定義: `WorkLog` 型
- 統合テスト（Vitest）

### 対象外（後続タスク）

- SvelteKit form actions（load/actions.start/actions.stop）
- UI コンポーネント
- 認証・認可の実装（モックで対応）

## データモデル仕様

### テーブル: `work_logs`

| カラム名     | 型          | 制約                          | 説明                        |
| ------------ | ----------- | ----------------------------- | --------------------------- |
| `id`         | UUID        | PK, DEFAULT gen_random_uuid() | 主キー                      |
| `user_id`    | UUID        | NOT NULL                      | ユーザーID（外部キー想定）  |
| `started_at` | TIMESTAMPTZ | NOT NULL                      | 作業開始時刻（UTC）         |
| `ended_at`   | TIMESTAMPTZ | NULL                          | 作業終了時刻（NULL=進行中） |
| `created_at` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW()       | レコード作成時刻            |
| `updated_at` | TIMESTAMPTZ | NOT NULL, DEFAULT NOW()       | レコード更新時刻            |

### インデックス・制約

1. **部分ユニーク制約**（重要）

   ```sql
   CREATE UNIQUE INDEX work_logs_user_id_active_unique
   ON work_logs (user_id)
   WHERE ended_at IS NULL;
   ```

   → 1ユーザーにつき同時に1つだけ進行中の作業を許可

2. **updated_at 自動更新**（推奨）
   ```sql
   CREATE TRIGGER update_work_logs_updated_at
   BEFORE UPDATE ON work_logs
   FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
   ```
   → トリガー関数は共通化または別途定義

## 実装ステップ

### ステップ1: Drizzle スキーマ定義

**ファイル:** `src/lib/server/db/schema.ts`

```typescript
import { pgTable, uuid, timestamp } from 'drizzle-orm/pg-core';

export const workLogs = pgTable('work_logs', {
	id: uuid('id').primaryKey().defaultRandom(),
	userId: uuid('user_id').notNull(),
	startedAt: timestamp('started_at', { withTimezone: true, mode: 'string' }).notNull(),
	endedAt: timestamp('ended_at', { withTimezone: true, mode: 'string' }),
	createdAt: timestamp('created_at', { withTimezone: true, mode: 'string' }).notNull().defaultNow(),
	updatedAt: timestamp('updated_at', { withTimezone: true, mode: 'string' }).notNull().defaultNow(),
});

export type WorkLog = typeof workLogs.$inferSelect;
export type NewWorkLog = typeof workLogs.$inferInsert;
```

**決定事項:**

- `timestamp` の `mode: 'string'` を使用（ISO 8601文字列として扱う）
- `defaultRandom()` でUUID自動生成
- `defaultNow()` でタイムスタンプ自動設定

### ステップ2: マイグレーション生成・編集

**コマンド:**

```bash
pnpm drizzle-kit generate:pg
```

**生成後の手動追加:**

- 部分ユニークインデックス `work_logs_user_id_active_unique`
- `updated_at` トリガー（必要に応じて）

**マイグレーションファイル例:**

```sql
-- migrations/0001_add_work_logs.sql
CREATE TABLE IF NOT EXISTS "work_logs" (
  "id" uuid PRIMARY KEY DEFAULT gen_random_uuid() NOT NULL,
  "user_id" uuid NOT NULL,
  "started_at" timestamp with time zone NOT NULL,
  "ended_at" timestamp with time zone,
  "created_at" timestamp with time zone DEFAULT now() NOT NULL,
  "updated_at" timestamp with time zone DEFAULT now() NOT NULL
);

-- 部分ユニーク制約（重要）
CREATE UNIQUE INDEX work_logs_user_id_active_unique
ON work_logs (user_id)
WHERE ended_at IS NULL;

-- updated_at 自動更新トリガー（オプション）
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_work_logs_updated_at
BEFORE UPDATE ON work_logs
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### ステップ3: 型定義の整理

**ファイル:** `src/lib/server/db/schema.ts` (上記で定義済み)

追加で必要な型:

```typescript
// API レスポンス用の型
export type WorkLogResponse = {
	id: string;
	userId: string;
	startedAt: string; // ISO 8601
	endedAt: string | null;
	createdAt: string;
	updatedAt: string;
};
```

### ステップ4: テストコード作成（TDD）

**ファイル:** `src/lib/server/db/workLogs.spec.ts`

**テストケース:**

1. **正常系: 作業開始→終了**
   - `createWorkLog` で新規作業を開始
   - `getActiveWorkLog` で進行中を取得できる
   - `stopWorkLog` で作業を終了
   - `getActiveWorkLog` が null を返す

2. **異常系: 二重開始 → 409 CONFLICT**
   - 進行中の作業がある状態で `createWorkLog` を呼ぶ
   - 部分ユニーク制約違反をキャッチし、409エラーを返す

3. **異常系: 進行中なしで停止 → 404 NOT_FOUND**
   - 進行中の作業がない状態で `stopWorkLog` を呼ぶ
   - 404エラーを返す

4. **認証なし → 401 UNAUTHORIZED**（モック）
   - `userId` が無効な場合の挙動を確認

**テスト構成:**

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { getTestDb, cleanupTestDb } from './testUtils';
import { getActiveWorkLog, createWorkLog, stopWorkLog } from './workLogs';

describe('WorkLogs DB Functions', () => {
	const testUserId = 'test-user-id-123';

	beforeEach(async () => {
		await cleanupTestDb();
	});

	it('正常系: 作業開始→終了', async () => {
		// Test implementation
	});

	it('異常系: 二重開始 → 409', async () => {
		// Test implementation
	});

	it('異常系: 進行中なしで停止 → 404', async () => {
		// Test implementation
	});
});
```

### ステップ5: DBアクセス関数の実装

**ファイル:** `src/lib/server/db/workLogs.ts`

**関数仕様:**

#### `getActiveWorkLog(userId: string): Promise<WorkLog | null>`

```typescript
// 進行中の作業を取得（ended_at IS NULL）
// 見つからない場合は null を返す
```

#### `createWorkLog(userId: string, serverNow: Date): Promise<WorkLog>`

```typescript
// 新規作業を開始
// - started_at = serverNow
// - ended_at = null
// 部分ユニーク制約違反時は ConflictError(409) をスロー
```

#### `stopWorkLog(userId: string, serverNow: Date): Promise<{ workLog: WorkLog, durationSec: number }>`

```typescript
// 進行中の作業を終了
// - ended_at = serverNow
// 進行中がない場合は NotFoundError(404) をスロー
// 所要時間(秒)を計算して返す
```

**エラークラス:**

```typescript
export class ConflictError extends Error {
	statusCode = 409;
	constructor(message: string) {
		super(message);
		this.name = 'ConflictError';
	}
}

export class NotFoundError extends Error {
	statusCode = 404;
	constructor(message: string) {
		super(message);
		this.name = 'NotFoundError';
	}
}
```

## 合格基準

### 必須条件

- [x] `work_logs` テーブルがスキーマで定義されている
- [x] マイグレーションが適用でき、部分ユニーク制約が機能する
- [x] 全テストケースが PASS する
- [x] TypeScript の型チェックが通る（`pnpm tsc --noEmit`）
- [x] 二重開始が防止される（409エラー）
- [x] 進行中なしで停止すると404エラー

### 推奨条件

- [x] `updated_at` トリガーが機能する
- [ ] テストカバレッジ 80% 以上（未測定）
- [x] ESLint エラーなし

## 決定事項・差分

### 上流仕様との差分

| 項目        | 機能仕様           | 実装仕様                                            | 理由                  |
| ----------- | ------------------ | --------------------------------------------------- | --------------------- |
| timestamp型 | `timestamptz`      | `timestamp({ withTimezone: true, mode: 'string' })` | Drizzle構文に合わせる |
| UUID生成    | 未指定             | `defaultRandom()`                                   | DBレベルで自動生成    |
| エラー型    | HTTPステータス記載 | カスタムエラークラス                                | 型安全性向上          |

### 技術選定

- **ORM:** Drizzle ORM（既存プロジェクト準拠）
- **DB:** PostgreSQL 14+（UUID、部分インデックス対応）
- **テスト:** Vitest + テスト用DB（開発環境のPostgresを使用）
- **型:** TypeScript strict mode

### 保留事項

- 外部キー制約（`user_id` → `users.id`）は後続で追加
- マイグレーションロールバック手順は別途整備
- 本番環境での `updated_at` トリガーのパフォーマンス検証

## 参考資料

- [Drizzle ORM - PostgreSQL](https://orm.drizzle.team/docs/get-started-postgresql)
- [PostgreSQL Partial Indexes](https://www.postgresql.org/docs/current/indexes-partial.html)
- 機能仕様: `docs/features/2025-10-19 12:51-F001-start-stop.md`

---

**次のステップ:** ステップ1のスキーマ定義から実装開始
